[build]
  # ビルドコマンド（環境変数チェック付き）
  command = "npm run build:safe"
  publish = "dist"

[build.environment]
  NODE_VERSION = "20"
  # ビルドログを詳細にする
  NODE_OPTIONS = "--max-old-space-size=4096"

# WordPress uploads フォルダをコピーするためのディレクトリ設定
[build.processing]
  skip_processing = false

# 環境変数の設定
# 以下の環境変数をNetlify UIで設定してください：
# Site Settings → Environment Variables
#
# 必須:
#   PUBLIC_API_URL = https://your-production-wordpress-url.com
#   PUBLIC_API_PREFIX = /wp-json/wp/v2/
#
# オプション（Contact Form 7を使用する場合）:
#   PUBLIC_WPCF7_API_PREFIX = contact-form-7/v1/contact-forms/
#   PUBLIC_WPCF7_API_ID = 123
#   PUBLIC_WPCF7_ID = 123
#   PUBLIC_WPCF7_UNIT_TAG = wpcf7-f123-p456-o1
#   PUBLIC_WPCF7_POST_ID = 456

# ============================================
# キャッシュヘッダーの設定（PageSpeed Insights最適化）
# ============================================
# 静的アセットには長期間のキャッシュ（1年）を設定し、
# 再訪問時のページ読み込み速度を向上させます。
# immutable フラグにより、ブラウザは再検証せずにキャッシュを使用します。

# 画像ファイル（すべてのサブディレクトリを含む）
[[headers]]
  for = "/**/*.webp"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.jpg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.jpeg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.png"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.gif"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.svg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.ico"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# CSS/JSファイル（Astroビルド出力、pagefind、その他のライブラリ）
[[headers]]
  for = "/_astro/**/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/_astro/**/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/_astro/**/*.map"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/css/**/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/pagefind/**/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/pagefind/**/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# フォントファイル
[[headers]]
  for = "/**/*.woff"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.woff2"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.ttf"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.otf"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# その他の静的アセット（音声、動画、WASM、Riveアニメーション）
[[headers]]
  for = "/**/*.mp3"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.mp4"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.wasm"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.riv"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# データファイル（JSON、XML、マニフェスト）
[[headers]]
  for = "/**/*.json"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.xml"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.webmanifest"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# pagefind関連ファイル（検索インデックス）
[[headers]]
  for = "/pagefind/**/*.pf_*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# WordPressアップロードファイル（wp-content/uploads/）
# これらのファイルは変更頻度が低いため、長期間キャッシュ可能
[[headers]]
  for = "/wp-content/uploads/**/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# assetsディレクトリ内のファイル
[[headers]]
  for = "/assets/**/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# HTMLファイルは短いキャッシュ期間を設定（再検証可能）
# コンテンツの更新を確実に反映させるため
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# robots.txtとsitemap.xmlは中程度のキャッシュ期間を設定
[[headers]]
  for = "/robots.txt"
  [headers.values]
    Cache-Control = "public, max-age=86400, must-revalidate"

[[headers]]
  for = "/sitemap.xml"
  [headers.values]
    Cache-Control = "public, max-age=86400, must-revalidate"
