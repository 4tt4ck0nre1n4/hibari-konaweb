[build]
  # ビルドコマンド（環境変数チェック付き）
  command = "npm run build:safe"
  publish = "dist"

[build.environment]
  NODE_VERSION = "20"
  # ビルドログを詳細にする
  NODE_OPTIONS = "--max-old-space-size=4096"

# ============================================
# 圧縮設定（PageSpeed Insights最適化）
# ============================================
# Netlifyはデフォルトでgzipとbrotli圧縮をサポートしていますが、
# 明示的に有効化することで確実に動作させます。
# 圧縮により、CSS/JS/HTMLなどのテキストベースファイルの
# 転送サイズが60-80%削減され、PageSpeed Insightsの
# パフォーマンススコアが大幅に改善されます。
[build.processing]
  skip_processing = false
  # 圧縮を有効化（デフォルトでtrueですが、明示的に設定）
  # Netlifyは自動的にgzip/brotli圧縮を適用します

# ============================================
# 環境変数の設定
# ============================================
# ⚠️ 重要: 以下のコメント内の値は「例示」です。
# 実際の環境変数は Netlify UI で設定してください：
# Site Settings → Environment Variables
#
# このファイル内のコメントはドキュメントとしての役割のみで、
# 実行時には使用されません。そのまま残しておいて問題ありません。
#
# 必須環境変数（Netlify UIで設定）:
#   PUBLIC_API_URL = https://your-production-wordpress-url.com
#     （例示: 実際のWordPressサイトのURLに置き換えてください）
#   PUBLIC_API_PREFIX = /wp-json/wp/v2/
#     （通常はこの値のままで問題ありません）
#
# オプション環境変数（Contact Form 7を使用する場合）:
#   PUBLIC_WPCF7_API_PREFIX = contact-form-7/v1/contact-forms/
#     （通常はこの値のままで問題ありません）
#   PUBLIC_WPCF7_API_ID = 123
#     （例示: 実際のContact Form 7のIDに置き換えてください）
#   PUBLIC_WPCF7_ID = 123
#     （例示: 実際のContact Form 7のIDに置き換えてください）
#   PUBLIC_WPCF7_UNIT_TAG = wpcf7-f123-p456-o1
#     （例示: 実際のユニットタグに置き換えてください）
#   PUBLIC_WPCF7_POST_ID = 456
#     （例示: 実際の投稿IDに置き換えてください）
#
# オプション環境変数（セキュリティ対策 - reCAPTCHA）:
#   PUBLIC_RECAPTCHA_SITE_KEY = your_recaptcha_site_key_here
#     （例示: Google reCAPTCHA管理画面で取得したサイトキーに置き換えてください）
#     ⚠️ 注意: これは公開されても問題ないサイトキーです。シークレットキーは設定しないでください

# ============================================
# キャッシュヘッダーの設定（PageSpeed Insights最適化）
# ============================================
# 静的アセットには長期間のキャッシュ（1年）を設定し、
# 再訪問時のページ読み込み速度を向上させます。
# immutable フラグにより、ブラウザは再検証せずにキャッシュを使用します。

# 画像ファイル（すべてのサブディレクトリを含む）
[[headers]]
  for = "/**/*.webp"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.jpg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.jpeg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.png"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.gif"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.svg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.ico"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# CSS/JSファイル（Astroビルド出力、pagefind、その他のライブラリ）
[[headers]]
  for = "/_astro/**/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/_astro/**/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/_astro/**/*.map"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/css/**/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/pagefind/**/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/pagefind/**/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# フォントファイル
[[headers]]
  for = "/**/*.woff"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.woff2"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.ttf"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.otf"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# その他の静的アセット（音声、動画、WASM、Riveアニメーション）
[[headers]]
  for = "/**/*.mp3"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.mp4"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.wasm"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.riv"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# データファイル（JSON、XML、マニフェスト）
[[headers]]
  for = "/**/*.json"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.xml"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/**/*.webmanifest"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# pagefind関連ファイル（検索インデックス）
[[headers]]
  for = "/pagefind/**/*.pf_*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# WordPressアップロードファイル（wp-content/uploads/）
# これらのファイルは変更頻度が低いため、長期間キャッシュ可能
[[headers]]
  for = "/wp-content/uploads/**/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# assetsディレクトリ内のファイル
[[headers]]
  for = "/assets/**/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# HTMLファイルは短いキャッシュ期間を設定（再検証可能）
# コンテンツの更新を確実に反映させるため
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# robots.txtとsitemap.xmlは中程度のキャッシュ期間を設定
[[headers]]
  for = "/robots.txt"
  [headers.values]
    Cache-Control = "public, max-age=86400, must-revalidate"

[[headers]]
  for = "/sitemap.xml"
  [headers.values]
    Cache-Control = "public, max-age=86400, must-revalidate"

# ============================================
# Content-Security-Policy（CSP）設定
# ============================================
# 注意: HTTPヘッダーとmetaタグの両方で設定した場合、
# HTTPヘッダーが優先されます（metaタグはフォールバックとして機能）
# 本番環境のCSP（Google AnalyticsとreCAPTCHA対応）
# 開発環境ではmetaタグのCSPが使用されます（localhost対応のため）
[[headers]]
  for = "/*"
  [headers.values]
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'wasm-unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://hibari-konaweb.netlify.app https://hibari-konaweb.com https://www.googletagmanager.com https://www.google.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; img-src 'self' data: blob: http://hibari-konaweb.local https://cdn.jsdelivr.net https://hibari-konaweb.com https://hibari-konaweb.netlify.app https://www.google-analytics.com https://www.googletagmanager.com https://www.gstatic.com; font-src 'self' https://fonts.gstatic.com data:; connect-src 'self' blob: data: https://unpkg.com https://cdn.jsdelivr.net https://api.iconify.design https://hibari-konaweb.com https://hibari-konaweb.netlify.app https://www.google-analytics.com https://analytics.google.com https://region1.google-analytics.com https://www.google.com https://www.gstatic.com; frame-src 'self' https://www.google.com https://www.gstatic.com; worker-src 'self' blob:; media-src 'self' blob:; object-src 'none';"
