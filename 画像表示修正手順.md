# 画像表示修正手順

## 🎯 目的

NetlifyにデプロイしたAstroサイトで画像が表示されない問題を解決します。

---

## ステップ1: 画像URLの診断 🔍

### 1-1. ブラウザで画像URLを確認

1. **Netlifyサイトを開く**

   ```
   https://hibari-konaweb.netlify.app/blog/1
   または
   https://hibari-konaweb.netlify.app/works/1
   ```

2. **開発者ツールを開く**

   - Windows: `F12`キー
   - または右クリック → 「検証」

3. **Elements（要素）タブで画像を探す**

   - `Ctrl + F`で検索ボックスを開く
   - `<img`で検索
   - `src=`属性の値を確認

4. **または、画像を右クリック**
   - 「画像アドレスをコピー」
   - メモ帳に貼り付けて確認

### 1-2. 診断結果の判断

確認したURLを以下と照らし合わせてください：

#### ❌ パターンA: ローカルURLのまま

```
http://hibari-konaweb.local/wp-content/uploads/2024/10/image.jpg
```

**原因**: データベースのURL置換が必要
**解決策**: 👉 **ステップ2へ進む**

#### ⚠️ パターンB: 本番URLだがCORSエラー

```
https://あなたのドメイン.com/wp-content/uploads/2024/10/image.jpg
```

**コンソールに以下のようなエラーが表示される**:

```
Access to image at 'https://...' from origin 'https://hibari-konaweb.netlify.app'
has been blocked by CORS policy
```

**原因**: WordPress側のCORS設定が不足
**解決策**: 👉 **ステップ3へ進む**

#### ⚠️ パターンC: 本番URLだが404エラー

```
https://あなたのドメイン.com/wp-content/uploads/2024/10/image.jpg
```

**原因**: 画像ファイルが本番サーバーに存在しない
**解決策**: 👉 **ステップ4へ進む**

#### ⚠️ パターンD: URLが空または不正

```
src="" または src="undefined"
```

**原因**: ACFフィールドが正しく設定されていない
**解決策**: 👉 **ステップ5へ進む**

---

## ステップ2: データベースのURL置換（パターンAの場合） 🔄

データベース内のローカルURLを本番URLに置き換えます。

### 方法1: Better Search Replace プラグイン（推奨）

1. **ConoHa WINGのWordPress管理画面にログイン**

   ```
   https://あなたのドメイン.com/wp-admin
   ```

2. **プラグインをインストール**

   - 左メニュー: 「プラグイン」→「新規追加」
   - 検索: `Better Search Replace`
   - 作者: `WP Engine`
   - 「今すぐインストール」→「有効化」

3. **URL置換を実行**

   - 左メニュー: 「ツール」→「Better Search Replace」

   **設定値：**

   ```
   Search for: http://hibari-konaweb.local
   Replace with: https://あなたのConoHa WINGのドメイン.com

   Select tables: すべて選択（✓を全てチェック）

   ⚠️ 重要: 「Run as dry run?」のチェックを外す
   （チェックが入っていると実際には変更されません）
   ```

4. **「Run Search/Replace」をクリック**

   - 処理が完了するまで待つ（数秒～数分）
   - 完了後、何件置換されたか表示される

5. **確認**
   - WordPress管理画面で投稿を開く
   - 画像URLが本番URLに変わっているか確認

### 方法2: WP-CLI（上級者向け）

SSHでサーバーにアクセスできる場合：

```bash
# SSHで接続
ssh user@your-server

# WordPressディレクトリに移動
cd /path/to/wordpress

# URL置換を実行
wp search-replace 'http://hibari-konaweb.local' 'https://あなたのドメイン.com' --all-tables

# 結果を確認
wp option get home
wp option get siteurl
```

### 方法3: SQL直接実行（上級者向け）

phpMyAdminまたはAdminerで以下のSQLを実行：

```sql
-- サイトURLの更新
UPDATE wp_options
SET option_value = REPLACE(option_value, 'http://hibari-konaweb.local', 'https://あなたのドメイン.com')
WHERE option_name = 'home' OR option_name = 'siteurl';

-- 投稿内容の更新
UPDATE wp_posts
SET post_content = REPLACE(post_content, 'http://hibari-konaweb.local', 'https://あなたのドメイン.com');

-- 投稿GUIDの更新
UPDATE wp_posts
SET guid = REPLACE(guid, 'http://hibari-konaweb.local', 'https://あなたのドメイン.com');

-- カスタムフィールド（ACF）の更新
UPDATE wp_postmeta
SET meta_value = REPLACE(meta_value, 'http://hibari-konaweb.local', 'https://あなたのドメイン.com');
```

### ステップ2の完了後

- 👉 **ステップ6へ進む**（Netlifyの再ビルド）

---

## ステップ3: CORS設定の追加（パターンBの場合） 🔓

WordPress側でNetlifyからの画像リクエストを許可します。

### 3-1. functions.phpを編集

1. **FTPまたはファイルマネージャーでアクセス**

   - ConoHa WINGのコントロールパネルにログイン
   - ファイルマネージャーを開く

2. **functions.phpを開く**

   ```
   パス: wp-content/themes/arkhe/functions.php
   ```

3. **ファイルの最後に以下を追加**

   ⚠️ **重要**: `?>` がある場合は、その**前**に追加してください

```php
// ====================================
// CORS設定（ヘッドレスWordPress用）
// ====================================
function add_cors_http_header() {
    // 許可するドメインのリスト
    $allowed_origins = array(
        'https://hibari-konaweb.netlify.app',  // Netlify本番環境
        'http://localhost:4321',               // ローカル開発環境
        'http://127.0.0.1:4321',              // ローカル開発環境（代替）
    );

    // リクエスト元のドメインを取得
    $origin = isset($_SERVER['HTTP_ORIGIN']) ? $_SERVER['HTTP_ORIGIN'] : '';

    // 許可されたドメインかチェック
    if (in_array($origin, $allowed_origins)) {
        header("Access-Control-Allow-Origin: " . $origin);
    }

    header("Access-Control-Allow-Methods: GET, POST, OPTIONS");
    header("Access-Control-Allow-Headers: Content-Type, Authorization");
    header("Access-Control-Allow-Credentials: true");

    // OPTIONSリクエスト（プリフライトリクエスト）の処理
    if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
        http_response_code(200);
        exit();
    }
}
add_action('init', 'add_cors_http_header');

// ====================================
// REST API用CORS設定
// ====================================
add_action('rest_api_init', function() {
    remove_filter('rest_pre_serve_request', 'rest_send_cors_headers');
    add_filter('rest_pre_serve_request', function($value) {
        $allowed_origins = array(
            'https://hibari-konaweb.netlify.app',
            'http://localhost:4321',
            'http://127.0.0.1:4321',
        );

        $origin = isset($_SERVER['HTTP_ORIGIN']) ? $_SERVER['HTTP_ORIGIN'] : '';

        if (in_array($origin, $allowed_origins)) {
            header('Access-Control-Allow-Origin: ' . $origin);
        }

        header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');
        header('Access-Control-Allow-Headers: Content-Type, Authorization');
        header('Access-Control-Allow-Credentials: true');

        if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
            status_header(200);
            exit();
        }

        return $value;
    });
}, 15);
```

4. **ファイルを保存**

### 3-2. .htaccessにも追加（オプション）

より確実にするため、`.htaccess`にも追加できます：

1. **WordPressルートディレクトリの`.htaccess`を開く**

2. **`# BEGIN WordPress`の**前**に以下を追加**

```apache
# ====================================
# CORS設定（ヘッドレスWordPress用）
# ====================================
<IfModule mod_headers.c>
    SetEnvIf Origin "^https://hibari-konaweb\.netlify\.app$" AccessControlAllowOrigin=$0
    SetEnvIf Origin "^http://localhost:4321$" AccessControlAllowOrigin=$0
    SetEnvIf Origin "^http://127\.0\.0\.1:4321$" AccessControlAllowOrigin=$0

    Header set Access-Control-Allow-Origin "%{AccessControlAllowOrigin}e" env=AccessControlAllowOrigin
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization"
    Header set Access-Control-Allow-Credentials "true"
</IfModule>

# BEGIN WordPress
```

3. **保存**

### ステップ3の完了後

- ブラウザのキャッシュをクリア（`Ctrl + Shift + Delete`）
- Netlifyサイトをリロード
- それでもダメなら 👉 **ステップ6へ進む**（Netlifyの再ビルド）

---

## ステップ4: 画像ファイルのアップロード（パターンCの場合） 📤

画像ファイルが本番サーバーに存在しない場合。

### 4-1. wp-content/uploadsフォルダを確認

1. **ConoHa WINGのファイルマネージャーを開く**

2. **wp-content/uploadsを確認**

   ```
   パス: public_html/wp-content/uploads/
   ```

3. **フォルダの中身を確認**
   - 年月のフォルダ（2024/10など）が存在するか
   - その中に画像ファイルがあるか

### 4-2. ローカルから画像をアップロード

画像がない場合、ローカル環境からアップロードします。

**方法1: FTPでアップロード（推奨）**

1. **FTPクライアントを起動**

   - FileZilla、WinSCP、Cyberduckなど

2. **ConoHa WINGに接続**

   - ホスト: ConoHa WINGから提供されたFTPホスト名
   - ユーザー名: FTPユーザー名
   - パスワード: FTPパスワード
   - ポート: 21（または提供された番号）

3. **ローカルのuploadsフォルダを開く**

   ```
   ローカル: C:\Users\yooth-k\Local Sites\hibari-konaweb\app\public\wp-content\uploads\
   ```

4. **サーバー側のuploadsフォルダにアップロード**

   ```
   サーバー: /public_html/wp-content/uploads/
   ```

   - uploadsフォルダ全体をドラッグ&ドロップ
   - アップロードが完了するまで待つ（サイズによっては数分～数十分）

**方法2: ファイルマネージャーでアップロード**

1. ConoHa WINGのファイルマネージャーを開く
2. `wp-content/uploads/`に移動
3. 「アップロード」ボタンをクリック
4. ローカルの画像ファイルを選択してアップロード

**方法3: Zipでアップロード（大量ファイルの場合）**

1. **ローカルでuploadsフォルダをZIP圧縮**

   ```
   C:\Users\yooth-k\Local Sites\hibari-konaweb\app\public\wp-content\uploads\
   ```

   - フォルダを右クリック → 「圧縮」
   - `uploads.zip`を作成

2. **FTPでZIPファイルをアップロード**

   - サーバーの`wp-content/`にアップロード

3. **サーバー側で解凍**
   - ConoHa WINGのファイルマネージャー
   - または SSH で `unzip uploads.zip`

### ステップ4の完了後

- ブラウザで画像URLに直接アクセスして確認
- 👉 **ステップ6へ進む**（Netlifyの再ビルド）

---

## ステップ5: ACFフィールドの確認（パターンDの場合） ⚙️

カスタムフィールド（Advanced Custom Fields）が正しく設定されていない場合。

### 5-1. WordPress管理画面で確認

1. **WordPress管理画面にログイン**

2. **投稿またはWorksを開く**

   - 左メニュー: 「投稿」または「Works」
   - 記事を1つ選択して編集画面を開く

3. **カスタムフィールドを確認**

   - ページ下部にACFフィールドが表示されているか
   - ブログの場合: `blog_image`フィールド
   - Worksの場合: ACFで設定した画像フィールド

4. **画像が設定されているか確認**
   - フィールドが空の場合 → 画像を選択して保存
   - フィールド自体がない場合 → ACF設定を確認

### 5-2. ACF設定を確認

1. **左メニュー: 「カスタムフィールド」（ACF）**

2. **フィールドグループを開く**

   - ブログ用フィールドグループを選択
   - Works用フィールドグループを選択

3. **画像フィールドが存在するか確認**

   - フィールドタイプ: `画像（Image）`
   - フィールド名: `blog_image`や`work_image`など
   - 返り値: `画像URL`または`画像配列`

4. **設定場所を確認**
   - 「表示条件」タブを確認
   - 正しい投稿タイプ（PostまたはWorks）に表示されているか

### 5-3. 画像を再設定

1. **各投稿を開く**
2. **ACFフィールドで画像を選択**
3. **更新を保存**

### ステップ5の完了後

- 👉 **ステップ6へ進む**（Netlifyの再ビルド）

---

## ステップ6: Netlifyの再ビルド 🔄

データベースや設定を変更したら、必ずNetlifyを再ビルドします。

### 6-1. 環境変数の確認

1. **Netlify Dashboard を開く**

   - https://app.netlify.com/

2. **Site configuration → Environment variables**

3. **以下の変数が設定されているか確認**

   ```
   PUBLIC_API_URL
   PUBLIC_API_PREFIX         ← これが抜けていないか確認！
   PUBLIC_WPCF7_API_PREFIX
   PUBLIC_WPCF7_API_ID
   PUBLIC_WPCF7_ID
   PUBLIC_WPCF7_UNIT_TAG
   PUBLIC_WPCF7_POST_ID
   ```

4. **`PUBLIC_API_PREFIX`が抜けている場合は追加**
   ```
   Key: PUBLIC_API_PREFIX
   Value: /wp-json/wp/v2/
   ```

### 6-2. 再ビルドを実行

**方法1: ダミーコミットでトリガー**

```bash
# プロジェクトディレクトリで実行
git commit --allow-empty -m "chore: rebuild for image fix"
git push origin main
```

**方法2: Netlifyダッシュボードから手動トリガー**

1. Netlify Dashboard を開く
2. 「Deploys」タブをクリック
3. 「Trigger deploy」ボタンをクリック
4. 「Deploy site」を選択

### 6-3. デプロイログを確認

1. **「Deploys」タブで最新のデプロイをクリック**

2. **ログを確認**
   - エラーがないか
   - `Fetching data...`のログが表示されているか
   - ビルドが成功（Success）になっているか

### 6-4. キャッシュクリア

1. **ブラウザのキャッシュをクリア**

   - Windows: `Ctrl + Shift + Delete`
   - 「キャッシュされた画像とファイル」を選択
   - 「データを削除」

2. **ハードリロード**
   - `Ctrl + Shift + R`または`Ctrl + F5`

---

## ステップ7: 最終確認 ✅

### 7-1. 画像が表示されるか確認

1. **Netlifyサイトにアクセス**

   ```
   https://hibari-konaweb.netlify.app/blog/1
   https://hibari-konaweb.netlify.app/works/1
   ```

2. **画像が正しく表示されているか確認**

3. **開発者ツールで確認**
   - `F12`キーを押す
   - Consoleタブでエラーがないか確認
   - Networkタブで画像が200 OKで読み込まれているか確認

### 7-2. 複数ページで確認

- ✅ トップページ
- ✅ ブログ一覧ページ
- ✅ ブログ詳細ページ
- ✅ Works一覧ページ
- ✅ Works詳細ページ
- ✅ カテゴリーページ

---

## 🎯 よくある問題と解決策

### 問題: Better Search Replaceで0件置換された

**原因**: データベース内のURLが既に本番URLになっている可能性

**確認方法**:

1. WordPress管理画面で投稿を開く
2. テキストエディタモードで画像URLを確認

### 問題: 一部の画像だけ表示されない

**原因**: 特定の画像ファイルがサーバーにアップロードされていない

**解決策**:

1. 表示されない画像のURLをコピー
2. ブラウザで直接そのURLにアクセス
3. 404エラーの場合 → その画像をFTPでアップロード

### 問題: ローカルでは表示されるがNetlifyで表示されない

**原因**: ビルド時のデータ取得失敗

**解決策**:

1. Netlifyの環境変数を再確認
2. デプロイログでエラーを確認
3. WordPress REST APIが正しく動作しているか確認

---

## 📞 サポート

この手順でも解決しない場合は、以下の情報を共有してください：

1. **ブラウザのコンソールエラー** (F12 → Console タブのスクリーンショット)
2. **画像のURL** (開発者ツールで確認したsrc属性)
3. **Netlifyのデプロイログ** (エラー部分)
4. **WordPress REST APIの動作状況**
   ```
   https://あなたのドメイン.com/wp-json/wp/v2/posts
   ↑ このURLにアクセスして表示される内容
   ```

---

## ✅ チェックリスト

- [ ] ブラウザで画像URLを確認した
- [ ] 画像URLのパターンを特定した
- [ ] データベースのURL置換を実行した（必要な場合）
- [ ] CORS設定を追加した（必要な場合）
- [ ] 画像ファイルをアップロードした（必要な場合）
- [ ] Netlifyの環境変数`PUBLIC_API_PREFIX`を確認した
- [ ] Netlifyを再ビルドした
- [ ] ブラウザのキャッシュをクリアした
- [ ] 画像が表示されることを確認した
- [ ] すべてのページで画像が表示されることを確認した

---

🎉 この手順で画像表示の問題が解決するはずです！
