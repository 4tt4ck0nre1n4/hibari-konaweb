---
import NaviCard from "./NaviCard.astro";
import Glitch from "./Glitch.astro";
// LCPæœ€é©åŒ–: ç”»åƒã®æœ€é©åŒ–ã¯index.astroã§å®Ÿè¡Œï¼ˆãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚’æœ€å„ªå…ˆé…ç½®ã™ã‚‹ãŸã‚ï¼‰
// ç”»åƒURLã¯propsã¨ã—ã¦å—ã‘å–ã‚‹
interface Props {
  fvBackgroundImageSrc: string;
  spFvBackgroundImageSrc: string;
  fvAnimeImageSrc: string;
}

const { fvBackgroundImageSrc, spFvBackgroundImageSrc, fvAnimeImageSrc } = Astro.props;
---

<div class="fv">
  <div class="fv__wrapper">
    <!-- LCPæœ€é©åŒ–: ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ç”»åƒã‚’<picture>è¦ç´ ã§å®Ÿè£… -->
    <!-- ç”»é¢å¹…768pxä»¥ä¸‹ã¯ãƒ¢ãƒã‚¤ãƒ«ç”»åƒã€769pxä»¥ä¸Šï¼ˆã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼‰ã¯ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”»åƒã‚’ä½¿ç”¨ -->
    <!-- iPad Proï¼ˆ1024pxï¼‰ãªã©ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã‚µã‚¤ã‚ºã¯ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ç”»åƒã‚’ä½¿ç”¨ -->
    <!-- width/heightå±æ€§ã‚’è¿½åŠ ã—ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®é…å»¶ã‚’å‰Šæ¸›ï¼ˆCLSå¯¾ç­–ã‚‚å…¼ã­ã‚‹ï¼‰ -->
    <picture>
      <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ç”»åƒï¼ˆ768pxä»¥ä¸‹ãƒ»ã‚¹ãƒãƒ›ã®ã¿ï¼‰ -->
      <source
        media="(max-width: 768px)"
        srcset={spFvBackgroundImageSrc}
        type="image/webp"
        width="768"
        height="432"
      />
      <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ç”»åƒï¼ˆ769pxä»¥ä¸Šãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆï¼‹ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼‰ -->
      <source
        media="(min-width: 769px)"
        srcset={fvBackgroundImageSrc}
        type="image/webp"
        width="1920"
        height="1080"
      />
      <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”»åƒï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ã‚’ä½¿ç”¨ï¼‰ -->
      <img
        src={fvBackgroundImageSrc}
        alt="ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ã®èƒŒæ™¯ç”»åƒ"
        class="fv__background-image"
        width="1920"
        height="1080"
        fetchpriority="high"
        decoding="sync"
        loading="eager"
        onerror="this.style.display='none';console.error('Failed to load background image:', this.src);"
      />
    </picture>
    <div class="background-container">
      <div class="background-rotated" style={`background-image: url(${fvAnimeImageSrc})`}></div>
      <div class="background"></div>
    </div>
    <h2 class="site-title">My Portfolio Site</h2>
    <div class="glitch-container">
      <NaviCard />
      <Glitch />
    </div>
  </div>
</div>

<style is:global>
  .site-title {
    position: fixed;
    top: 80px;
    right: 168px;
    font-family: "Marcellus", serif;
    font-size: 2rem;
    font-weight: 400;
    color: var(--color-white, #f1f5f9);
    text-shadow:
      0 0 40px rgb(147 51 234 / 0.8),
      0 0 30px rgb(147 51 234 / 0.6),
      0 0 20px rgb(255 255 255 / 0.9),
      0 0 15px rgb(255 255 255 / 0.7),
      0 4px 8px rgb(0 0 0 / 0.5),
      0 2px 4px rgb(0 0 0 / 0.7);
    z-index: 10000;
    pointer-events: none;
    margin: 0;
    white-space: nowrap;
  }

  @media (width <= 850px) {
    .site-title {
      top: 20px;
      left: 50%;
      right: auto;
      transform: translateX(-50%);
      font-size: 1.5rem;
    }
  }
</style>

<script is:inline>
  // @ts-nocheck
  // IIFEã§ã‚¹ã‚³ãƒ¼ãƒ—ã‚’åˆ†é›¢ï¼ˆé‡è¤‡å®£è¨€ã‚¨ãƒ©ãƒ¼ã‚’é˜²ãï¼‰
  (() => {
    // é–‹ç™ºç’°å¢ƒã§ã®ã¿ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹é–¢æ•°ï¼ˆé‡è¤‡å®£è¨€ã‚’é˜²ããŸã‚ã€æ—¢å­˜ãƒã‚§ãƒƒã‚¯ï¼‰
    if (typeof window.devLog === "undefined") {
      window.devLog = (...args) => {
        if (window.__DEV__) {
          console.log(...args);
        }
      };
    }
    if (typeof window.devWarn === "undefined") {
      window.devWarn = (...args) => {
        if (window.__DEV__) {
          console.warn(...args);
        }
      };
    }
    // é‡è¤‡å®£è¨€ã‚’é¿ã‘ã‚‹ãŸã‚ã€constã§å®£è¨€ã›ãšã€window.devLogã‚’ç›´æ¥ä½¿ç”¨
    const devLog = typeof window !== "undefined" && window.devLog ? window.devLog : () => {};
    const devWarn = typeof window !== "undefined" && window.devWarn ? window.devWarn : () => {};

    // ãƒã‚¦ã‚¹è¿½å¾“èƒŒæ™¯ã®åˆæœŸåŒ–
    function initBackgroundMouseFollow() {
      devLog("ğŸ” initBackgroundMouseFollow called");

      // è¦ç´ ãŒè¦‹ã¤ã‹ã‚‹ã¾ã§å¾…æ©Ÿï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®çµ‚äº†ã‚’è€ƒæ…®ï¼‰
      const checkAndInit = () => {
        devLog("ğŸ” Checking for elements...");
        const backgroundContainer = document.querySelector(".background-container");
        const fvWrapper = document.querySelector(".fv__wrapper");

        devLog("ğŸ” Elements found:", { backgroundContainer, fvWrapper });

        if (!backgroundContainer || !fvWrapper) {
          // è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å†è©¦è¡Œ
          devWarn("âš ï¸ Elements not found, retrying in 100ms...");
          setTimeout(checkAndInit, 100);
          return;
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®çµ‚äº†ã‚’å¾…ã¤
        const loadingScreen = document.getElementById("loading-screen");
        devLog("ğŸ” Loading screen:", loadingScreen);

        if (loadingScreen) {
          const checkLoadingComplete = () => {
            // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã€ã¾ãšã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¢ºèª
            const inlineDisplay = loadingScreen.style.display;
            const inlineVisibility = loadingScreen.style.visibility;

            // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã§åˆ¤å®šå¯èƒ½ãªå ´åˆã¯ã€getComputedStyleã‚’å‘¼ã°ãªã„
            let isVisible = false;
            if (inlineDisplay !== "none" && inlineVisibility !== "hidden") {
              if (inlineDisplay === "" && inlineVisibility === "") {
                // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ã€requestAnimationFrameå†…ã§getComputedStyleã‚’å‘¼ã¶
                requestAnimationFrame(() => {
                  const computedStyle = window.getComputedStyle(loadingScreen);
                  const computedDisplay = computedStyle.display;
                  const computedVisibility = computedStyle.visibility;
                  const computedVisible = computedDisplay !== "none" && computedVisibility !== "hidden";

                  devLog("ğŸ” Loading screen visible (computed):", computedVisible);

                  if (computedVisible) {
                    // ã¾ã ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ãªã®ã§å†ãƒã‚§ãƒƒã‚¯
                    devLog("â³ Loading screen still visible, rechecking in 100ms...");
                    setTimeout(checkLoadingComplete, 100);
                  } else {
                    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†å¾Œã«åˆæœŸåŒ–
                    devLog("âœ… Loading complete, initializing mouse follow...");
                    initializeMouseFollow(backgroundContainer, fvWrapper);
                  }
                });
                return;
              } else {
                isVisible = true;
              }
            }

            devLog("ğŸ” Loading screen visible (inline):", isVisible);

            if (isVisible) {
              // ã¾ã ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ãªã®ã§å†ãƒã‚§ãƒƒã‚¯
              devLog("â³ Loading screen still visible, rechecking in 100ms...");
              setTimeout(checkLoadingComplete, 100);
            } else {
              // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†å¾Œã«åˆæœŸåŒ–
              devLog("âœ… Loading complete, initializing mouse follow...");
              initializeMouseFollow(backgroundContainer, fvWrapper);
            }
          };
          checkLoadingComplete();
        } else {
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å³åº§ã«åˆæœŸåŒ–
          devLog("â„¹ï¸ No loading screen, initializing immediately...");
          initializeMouseFollow(backgroundContainer, fvWrapper);
        }
      };

      checkAndInit();
    }

    // ãƒã‚¦ã‚¹è¿½å¾“ã®å®Ÿéš›ã®åˆæœŸåŒ–å‡¦ç†
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ä¿æŒï¼ˆé‡è¤‡é˜²æ­¢ã®ãŸã‚ï¼‰
    let mouseMoveHandler = null;
    let mouseLeaveHandler = null;
    let touchStartHandler = null;
    let touchMoveHandler = null;
    let touchEndHandler = null;
    let resizeHandler = null;

    function initializeMouseFollow(backgroundContainer, fvWrapper) {
      // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
      if (mouseMoveHandler) {
        window.removeEventListener("mousemove", mouseMoveHandler);
        mouseMoveHandler = null;
      }
      if (mouseLeaveHandler) {
        window.removeEventListener("mouseleave", mouseLeaveHandler);
        mouseLeaveHandler = null;
      }
      if (touchStartHandler) {
        window.removeEventListener("touchstart", touchStartHandler);
        touchStartHandler = null;
      }
      if (touchMoveHandler) {
        window.removeEventListener("touchmove", touchMoveHandler);
        touchMoveHandler = null;
      }
      if (touchEndHandler) {
        window.removeEventListener("touchend", touchEndHandler);
        touchEndHandler = null;
      }
      if (resizeHandler) {
        window.removeEventListener("resize", resizeHandler);
        resizeHandler = null;
      }

      // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰
      // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã€requestAnimationFrameå†…ã§getComputedStyleã‚’å®Ÿè¡Œ
      requestAnimationFrame(() => {
        devLog("âœ… Initializing mouse follow...", {
          backgroundContainer,
          fvWrapper,
          maskImage: window.getComputedStyle(backgroundContainer).maskImage,
          webkitMaskImage: window.getComputedStyle(backgroundContainer).webkitMaskImage,
          mouseXVar: window.getComputedStyle(backgroundContainer).getPropertyValue("--mouse-x"),
          mouseYVar: window.getComputedStyle(backgroundContainer).getPropertyValue("--mouse-y"),
        });
      });

      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã€requestAnimationFrameã‚’ä½¿ç”¨
      let rafId = null;
      let mouseX = 0;
      let mouseY = 0;

      // getBoundingClientRectã®çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰å‡¦ç†ã®æœ€é©åŒ–ï¼‰
      let cachedRect = null;
      let lastRectUpdate = 0;
      const RECT_CACHE_DURATION = 100; // 100msé–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥

      const updateMaskPosition = () => {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¤ã„å ´åˆã®ã¿å†è¨ˆç®—
        if (!cachedRect || Date.now() - lastRectUpdate > RECT_CACHE_DURATION) {
          cachedRect = fvWrapper.getBoundingClientRect();
          lastRectUpdate = Date.now();
        }
        const rect = cachedRect;
        const x = mouseX - rect.left;
        const y = mouseY - rect.top;

        // CSSå¤‰æ•°ã‚’ä½¿ã£ã¦ãƒã‚¹ã‚¯ã®ä½ç½®ã‚’æ›´æ–°ï¼ˆã‚ˆã‚Šç¢ºå®Ÿã«è¨­å®šï¼‰
        backgroundContainer.style.setProperty("--mouse-x", `${x}px`);
        backgroundContainer.style.setProperty("--mouse-y", `${y}px`);

        rafId = null;
      };

      // ãƒ‡ãƒã‚¤ã‚¹ãŒã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã‹ã©ã†ã‹ã‚’åˆ¤å®š
      const isTouchDevice =
        window.matchMedia("(any-hover: none)").matches ||
        window.matchMedia("(pointer: coarse)").matches ||
        "ontouchstart" in window;

      devLog("ğŸ“± Device type:", isTouchDevice ? "Touch device" : "Desktop");

      // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: ãƒã‚¦ã‚¹è¿½å¾“
      if (!isTouchDevice) {
        devLog("ğŸ–±ï¸ Setting up desktop mouse tracking...");
        // windowå…¨ä½“ã§ãƒã‚¦ã‚¹ç§»å‹•ã‚’ç›£è¦–ï¼ˆç”»é¢å…¨ä½“ã‚’è¿½å¾“ï¼‰
        mouseMoveHandler = (e) => {
          mouseX = e.clientX;
          mouseY = e.clientY;

          // requestAnimationFrameã§æ›´æ–°ã‚’æœ€é©åŒ–
          if (rafId === null) {
            rafId = requestAnimationFrame(updateMaskPosition);
          }
        };
        window.addEventListener("mousemove", mouseMoveHandler, { passive: true });

        devLog("âœ… Desktop mouse tracking event listener attached");

        // ãƒã‚¦ã‚¹ãŒç”»é¢å¤–ã«å‡ºãŸå ´åˆã‚‚è¿½å¾“ï¼ˆç”»é¢ç«¯ã§ã‚‚åå¿œã™ã‚‹ã‚ˆã†ã«ï¼‰
        mouseLeaveHandler = () => {
          // ãƒã‚¦ã‚¹ãŒç”»é¢å¤–ã«å‡ºãŸå ´åˆã¯æœ€å¾Œã®ä½ç½®ã‚’ä¿æŒ
        };
        window.addEventListener("mouseleave", mouseLeaveHandler);
      } else {
        // ã‚¹ãƒãƒ›/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ: ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã¨è‡ªå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®çµ„ã¿åˆã‚ã›

        // 1. ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œï¼ˆã‚¿ãƒƒãƒä½ç½®ã‚’è¿½å¾“ï¼‰
        let touchX = 0;
        let touchY = 0;
        let isTouching = false;

        touchStartHandler = (e) => {
          if (e.touches.length > 0) {
            isTouching = true;
            touchX = e.touches[0].clientX;
            touchY = e.touches[0].clientY;
            mouseX = touchX;
            mouseY = touchY;

            if (rafId === null) {
              rafId = requestAnimationFrame(updateMaskPosition);
            }
          }
        };
        window.addEventListener("touchstart", touchStartHandler, { passive: true });

        touchMoveHandler = (e) => {
          if (e.touches.length > 0 && isTouching) {
            touchX = e.touches[0].clientX;
            touchY = e.touches[0].clientY;
            mouseX = touchX;
            mouseY = touchY;

            if (rafId === null) {
              rafId = requestAnimationFrame(updateMaskPosition);
            }
          }
        };
        window.addEventListener("touchmove", touchMoveHandler, { passive: true });

        touchEndHandler = () => {
          isTouching = false;
        };
        window.addEventListener("touchend", touchEndHandler, { passive: true });

        // 2. è‡ªå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¿ãƒƒãƒæ“ä½œãŒãªã„å ´åˆã®ä»£æ›¿ï¼‰
        // ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: å®šæœŸçš„ã«ä½ç½®ã‚’å¤‰æ›´ã—ã¦è¦–è¦šçš„ãªå‹•ãã‚’æä¾›
        let autoAnimationId = null;
        let animationPhase = 0;
        const animationDuration = 4000; // 4ç§’å‘¨æœŸ
        const animationRadius = 100; // ç§»å‹•åŠå¾„ï¼ˆpxï¼‰

        const startAutoAnimation = () => {
          if (autoAnimationId !== null) return; // æ—¢ã«å®Ÿè¡Œä¸­

          const startTime = Date.now();

          const animate = () => {
            if (isTouching) {
              // ã‚¿ãƒƒãƒä¸­ã¯è‡ªå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸€æ™‚åœæ­¢
              autoAnimationId = requestAnimationFrame(animate);
              return;
            }

            // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã€getBoundingClientRectã®çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            // ãƒªã‚µã‚¤ã‚ºæ™‚ã®ã¿å†è¨ˆç®—ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
            if (!cachedRect || Date.now() - lastRectUpdate > 100) {
              cachedRect = fvWrapper.getBoundingClientRect();
              lastRectUpdate = Date.now();
            }
            const rect = cachedRect;
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;

            const elapsed = Date.now() - startTime;
            const progress = (elapsed % animationDuration) / animationDuration;

            // å††å½¢ãƒ‘ã‚¹ã§ç§»å‹•ï¼ˆã‚¹ãƒ ãƒ¼ã‚ºãªå‹•ãï¼‰
            const angle = progress * Math.PI * 2;
            const offsetX = Math.cos(angle) * animationRadius;
            const offsetY = Math.sin(angle) * animationRadius;

            mouseX = centerX + rect.left + offsetX;
            mouseY = centerY + rect.top + offsetY;

            if (rafId === null) {
              rafId = requestAnimationFrame(updateMaskPosition);
            }

            autoAnimationId = requestAnimationFrame(animate);
          };

          autoAnimationId = requestAnimationFrame(animate);
        };

        // è‡ªå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ï¼ˆå°‘ã—é…å»¶ã•ã›ã¦è‡ªç„¶ãªå‹•ãã«ï¼‰
        setTimeout(() => {
          startAutoAnimation();
        }, 500);
      }

      // åˆæœŸä½ç½®ã‚’è¨­å®šï¼ˆç”»é¢ä¸­å¤®ï¼‰
      // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã€requestAnimationFrameå†…ã§getBoundingClientRectã‚’å®Ÿè¡Œ
      const initialX = window.innerWidth / 2;
      const initialY = window.innerHeight / 2;
      requestAnimationFrame(() => {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ï¼ˆæ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
        if (!cachedRect) {
          cachedRect = fvWrapper.getBoundingClientRect();
          lastRectUpdate = Date.now();
        }
        const rect = cachedRect;
        const x = initialX - rect.left;
        const y = initialY - rect.top;
        backgroundContainer.style.setProperty("--mouse-x", `${x}px`);
        backgroundContainer.style.setProperty("--mouse-y", `${y}px`);

        // åˆæœŸåŒ–å®Œäº†ã®ãƒ­ã‚°ï¼ˆrequestAnimationFrameå†…ã§å®Ÿè¡Œã—ã¦ã‚¹ã‚³ãƒ¼ãƒ—å†…ã®å¤‰æ•°ã‚’ä½¿ç”¨ï¼‰
        devLog("âœ… Mouse follow initialized successfully", {
          initialX,
          initialY,
          x,
          y,
          rect: {
            left: rect.left,
            top: rect.top,
            width: rect.width,
            height: rect.height,
          },
          // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã¯åˆ¥ã®requestAnimationFrameã§å–å¾—ã—ã¦å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼ã‚’é¿ã‘ã‚‹
          finalMouseXVar: window.getComputedStyle(backgroundContainer).getPropertyValue("--mouse-x"),
          finalMouseYVar: window.getComputedStyle(backgroundContainer).getPropertyValue("--mouse-y"),
        });
      });

      // ãƒªã‚µã‚¤ã‚ºæ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
      let resizeCacheTimer = null;
      resizeHandler = () => {
        if (resizeCacheTimer) {
          clearTimeout(resizeCacheTimer);
        }
        resizeCacheTimer = setTimeout(() => {
          cachedRect = null;
          lastRectUpdate = 0;
        }, 150);
      };
      window.addEventListener("resize", resizeHandler, { passive: true });
    }

    // LCPæœ€é©åŒ–: ãƒã‚¦ã‚¹è¿½å¾“ã®åˆæœŸåŒ–ã‚’é…å»¶ã•ã›ãšã«å³åº§ã«å®Ÿè¡Œï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®å¾…æ©Ÿã¯æœ€å°é™ã«ï¼‰
    function waitForInit() {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®å¾…æ©Ÿã‚’æœ€é©åŒ–: æœ€å¤§3000msã¾ã§å¾…æ©Ÿï¼ˆLighthouseå®Ÿè¡Œæ™‚ã§ã‚‚ç¢ºå®Ÿã«åˆæœŸåŒ–ã•ã‚Œã‚‹ã‚ˆã†ã«ï¼‰
      const MAX_WAIT_TIME = 3000;
      const startTime = Date.now();

      const tryInit = () => {
        const loadingScreen = document.getElementById("loading-screen");
        const elapsed = Date.now() - startTime;

        // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã€ã¾ãšã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¢ºèª
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯éè¡¨ç¤ºã€ã¾ãŸã¯æœ€å¤§å¾…æ©Ÿæ™‚é–“ã‚’è¶…ãˆãŸå ´åˆã¯å³åº§ã«åˆæœŸåŒ–
        if (
          !loadingScreen ||
          elapsed >= MAX_WAIT_TIME ||
          loadingScreen.style.display === "none" ||
          loadingScreen.style.visibility === "hidden" ||
          loadingScreen.style.opacity === "0"
        ) {
          devLog("âœ… Initializing mouse follow (loading screen check passed)");
          initBackgroundMouseFollow();
          return;
        }

        // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã§åˆ¤å®šã§ããªã„å ´åˆã®ã¿ã€requestAnimationFrameå†…ã§getComputedStyleã‚’å‘¼ã¶
        if (loadingScreen.style.display === "" && loadingScreen.style.visibility === "" && loadingScreen.style.opacity === "") {
          requestAnimationFrame(() => {
            const computedStyle = window.getComputedStyle(loadingScreen);
            const computedDisplay = computedStyle.display;
            const computedVisibility = computedStyle.visibility;
            const computedOpacity = computedStyle.opacity;

            if (
              computedDisplay === "none" ||
              computedVisibility === "hidden" ||
              computedOpacity === "0"
            ) {
              devLog("âœ… Initializing mouse follow (computed style check passed)");
              initBackgroundMouseFollow();
              return;
            }

            // æœ€å¤§å¾…æ©Ÿæ™‚é–“ã‚’è¶…ãˆãŸå ´åˆã¯å¼·åˆ¶çš„ã«åˆæœŸåŒ–ï¼ˆLighthouseå®Ÿè¡Œæ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            if (elapsed >= MAX_WAIT_TIME) {
              devWarn("âš ï¸ Max wait time exceeded, initializing mouse follow anyway");
              initBackgroundMouseFollow();
              return;
            }

            // ã¾ã ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®å ´åˆã¯å†è©¦è¡Œ
            setTimeout(tryInit, 50);
          });
          return;
        }

        // æœ€å¤§å¾…æ©Ÿæ™‚é–“ã‚’è¶…ãˆãŸå ´åˆã¯å¼·åˆ¶çš„ã«åˆæœŸåŒ–
        if (elapsed >= MAX_WAIT_TIME) {
          devWarn("âš ï¸ Max wait time exceeded, initializing mouse follow anyway");
          initBackgroundMouseFollow();
          return;
        }

        // ã¾ã ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®å ´åˆã¯50mså¾Œã«å†è©¦è¡Œ
        setTimeout(tryInit, 50);
      };

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", tryInit);
      } else {
        tryInit();
      }
    }

    // window.onloadã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    window.addEventListener("load", () => {
      waitForInit();
    });

    // å³åº§ã«ã‚‚è©¦è¡Œï¼ˆæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
    waitForInit();

    // View Transitionså¯¾å¿œ: ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã«å†åˆæœŸåŒ–
    // ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆ/ï¼‰ã«é·ç§»ã—ãŸå ´åˆã®ã¿ãƒã‚¦ã‚¹è¿½å¾“ã‚’åˆæœŸåŒ–
    document.addEventListener("astro:after-swap", () => {
      // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ãŒãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‹ã©ã†ã‹ã‚’ç¢ºèª
      if (window.location.pathname === "/" || window.location.pathname === "/index.html") {
        devLog("ğŸ”„ Page swapped to index, reinitializing mouse follow...");
        // å°‘ã—é…å»¶ã•ã›ã¦DOMã®æ›´æ–°ã‚’å¾…ã¤
        setTimeout(() => {
          waitForInit();
        }, 100);
      }
    });
  })();
</script>
