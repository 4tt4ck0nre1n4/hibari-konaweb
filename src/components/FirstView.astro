---
import NaviCard from "./NaviCard.astro";
import Glitch from "./Glitch.astro";
import fvAnimeImageSrc from "../assets/fvAnimeImage.webp";
import fvBackgroundImageSrc from "../assets/fvBackgroundImage.webp";
import { getImage } from "astro:assets";

// LCPæœ€é©åŒ–: èƒŒæ™¯ç”»åƒã‚’é«˜å“è³ªãƒ»é©åˆ‡ãªã‚µã‚¤ã‚ºã§æœ€é©åŒ–
// 1920pxå¹…ï¼ˆä¸€èˆ¬çš„ãªãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”»é¢å¹…ï¼‰ã§æœ€é©åŒ–ã—ã€AVIF/WebPå½¢å¼ã‚’å„ªå…ˆ
const fvBackgroundImage = await getImage({
  src: fvBackgroundImageSrc,
  width: 1920,
  quality: 85, // å“è³ªã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ãƒãƒ©ãƒ³ã‚¹
  format: "webp", // WebPå½¢å¼ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šï¼ˆAVIFã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
});

// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”»åƒã¯ä½å„ªå…ˆåº¦ã§æœ€é©åŒ–
const fvAnimeImage = await getImage({
  src: fvAnimeImageSrc,
  width: 1920,
  quality: 80,
  format: "webp",
});
---

<!-- LCPèƒŒæ™¯ç”»åƒã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆPageSpeed Insightsæœ€é©åŒ–ï¼‰ --><!-- ãƒªã‚½ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ã®é…å»¶ã‚’å‰Šæ¸›ã™ã‚‹ãŸã‚ã€headã®æœ€åˆã«é…ç½® -->
<link slot="head" rel="preload" href={fvBackgroundImage.src} as="image" fetchpriority="high" type="image/webp" />
<link slot="head" rel="preload" href={fvAnimeImage.src} as="image" fetchpriority="low" type="image/webp" />

<div class="fv">
  <div class="fv__wrapper" style={`background-image: url(${fvBackgroundImage.src})`}>
    <div class="background-container">
      <div class="background-rotated" style={`background-image: url(${fvAnimeImage.src})`}></div>
      <div class="background"></div>
    </div>
    <div class="glitch-container">
      <NaviCard />
      <Glitch />
    </div>
  </div>
</div>

<script is:inline>
  // @ts-nocheck
  // é–‹ç™ºç’°å¢ƒã§ã®ã¿ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹é–¢æ•°
  const devLog = (...args) => {
    if (window.__DEV__) {
      console.log(...args);
    }
  };
  const devWarn = (...args) => {
    if (window.__DEV__) {
      console.warn(...args);
    }
  };

  // ãƒã‚¦ã‚¹è¿½å¾“èƒŒæ™¯ã®åˆæœŸåŒ–
  function initBackgroundMouseFollow() {
    devLog("ğŸ” initBackgroundMouseFollow called");

    // è¦ç´ ãŒè¦‹ã¤ã‹ã‚‹ã¾ã§å¾…æ©Ÿï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®çµ‚äº†ã‚’è€ƒæ…®ï¼‰
    const checkAndInit = () => {
      devLog("ğŸ” Checking for elements...");
      const backgroundContainer = document.querySelector(".background-container");
      const fvWrapper = document.querySelector(".fv__wrapper");

      devLog("ğŸ” Elements found:", { backgroundContainer, fvWrapper });

      if (!backgroundContainer || !fvWrapper) {
        // è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å†è©¦è¡Œ
        devWarn("âš ï¸ Elements not found, retrying in 100ms...");
        setTimeout(checkAndInit, 100);
        return;
      }

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®çµ‚äº†ã‚’å¾…ã¤
      const loadingScreen = document.getElementById("loading-screen");
      devLog("ğŸ” Loading screen:", loadingScreen);

      if (loadingScreen) {
        const checkLoadingComplete = () => {
          const computedStyle = window.getComputedStyle(loadingScreen);
          const isVisible =
            loadingScreen.style.display !== "none" &&
            loadingScreen.style.visibility !== "hidden" &&
            computedStyle.display !== "none" &&
            computedStyle.visibility !== "hidden";

          devLog("ğŸ” Loading screen visible:", isVisible);

          if (isVisible) {
            // ã¾ã ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ãªã®ã§å†ãƒã‚§ãƒƒã‚¯
            devLog("â³ Loading screen still visible, rechecking in 100ms...");
            setTimeout(checkLoadingComplete, 100);
          } else {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†å¾Œã«åˆæœŸåŒ–
            devLog("âœ… Loading complete, initializing mouse follow...");
            initializeMouseFollow(backgroundContainer, fvWrapper);
          }
        };
        checkLoadingComplete();
      } else {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å³åº§ã«åˆæœŸåŒ–
        devLog("â„¹ï¸ No loading screen, initializing immediately...");
        initializeMouseFollow(backgroundContainer, fvWrapper);
      }
    };

    checkAndInit();
  }

  // ãƒã‚¦ã‚¹è¿½å¾“ã®å®Ÿéš›ã®åˆæœŸåŒ–å‡¦ç†
  function initializeMouseFollow(backgroundContainer, fvWrapper) {
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰
    devLog("âœ… Initializing mouse follow...", {
      backgroundContainer,
      fvWrapper,
      maskImage: window.getComputedStyle(backgroundContainer).maskImage,
      webkitMaskImage: window.getComputedStyle(backgroundContainer).webkitMaskImage,
      mouseXVar: window.getComputedStyle(backgroundContainer).getPropertyValue("--mouse-x"),
      mouseYVar: window.getComputedStyle(backgroundContainer).getPropertyValue("--mouse-y"),
    });

    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã€requestAnimationFrameã‚’ä½¿ç”¨
    let rafId = null;
    let mouseX = 0;
    let mouseY = 0;

    // getBoundingClientRectã®çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰å‡¦ç†ã®æœ€é©åŒ–ï¼‰
    let cachedRect = null;
    let lastRectUpdate = 0;
    const RECT_CACHE_DURATION = 100; // 100msé–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥

    const updateMaskPosition = () => {
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¤ã„å ´åˆã®ã¿å†è¨ˆç®—
      if (!cachedRect || Date.now() - lastRectUpdate > RECT_CACHE_DURATION) {
        cachedRect = fvWrapper.getBoundingClientRect();
        lastRectUpdate = Date.now();
      }
      const rect = cachedRect;
      const x = mouseX - rect.left;
      const y = mouseY - rect.top;

      // CSSå¤‰æ•°ã‚’ä½¿ã£ã¦ãƒã‚¹ã‚¯ã®ä½ç½®ã‚’æ›´æ–°ï¼ˆã‚ˆã‚Šç¢ºå®Ÿã«è¨­å®šï¼‰
      backgroundContainer.style.setProperty("--mouse-x", `${x}px`);
      backgroundContainer.style.setProperty("--mouse-y", `${y}px`);

      rafId = null;
    };

    // ãƒ‡ãƒã‚¤ã‚¹ãŒã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã‹ã©ã†ã‹ã‚’åˆ¤å®š
    const isTouchDevice =
      window.matchMedia("(any-hover: none)").matches ||
      window.matchMedia("(pointer: coarse)").matches ||
      "ontouchstart" in window;

    devLog("ğŸ“± Device type:", isTouchDevice ? "Touch device" : "Desktop");

    // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: ãƒã‚¦ã‚¹è¿½å¾“
    if (!isTouchDevice) {
      devLog("ğŸ–±ï¸ Setting up desktop mouse tracking...");
      // windowå…¨ä½“ã§ãƒã‚¦ã‚¹ç§»å‹•ã‚’ç›£è¦–ï¼ˆç”»é¢å…¨ä½“ã‚’è¿½å¾“ï¼‰
      window.addEventListener(
        "mousemove",
        (e) => {
          mouseX = e.clientX;
          mouseY = e.clientY;

          // requestAnimationFrameã§æ›´æ–°ã‚’æœ€é©åŒ–
          if (rafId === null) {
            rafId = requestAnimationFrame(updateMaskPosition);
          }
        },
        { passive: true }
      );

      devLog("âœ… Desktop mouse tracking event listener attached");

      // ãƒã‚¦ã‚¹ãŒç”»é¢å¤–ã«å‡ºãŸå ´åˆã‚‚è¿½å¾“ï¼ˆç”»é¢ç«¯ã§ã‚‚åå¿œã™ã‚‹ã‚ˆã†ã«ï¼‰
      window.addEventListener("mouseleave", () => {
        // ãƒã‚¦ã‚¹ãŒç”»é¢å¤–ã«å‡ºãŸå ´åˆã¯æœ€å¾Œã®ä½ç½®ã‚’ä¿æŒ
      });
    } else {
      // ã‚¹ãƒãƒ›/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ: ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã¨è‡ªå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®çµ„ã¿åˆã‚ã›

      // 1. ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œï¼ˆã‚¿ãƒƒãƒä½ç½®ã‚’è¿½å¾“ï¼‰
      let touchX = 0;
      let touchY = 0;
      let isTouching = false;

      window.addEventListener(
        "touchstart",
        (e) => {
          if (e.touches.length > 0) {
            isTouching = true;
            touchX = e.touches[0].clientX;
            touchY = e.touches[0].clientY;
            mouseX = touchX;
            mouseY = touchY;

            if (rafId === null) {
              rafId = requestAnimationFrame(updateMaskPosition);
            }
          }
        },
        { passive: true }
      );

      window.addEventListener(
        "touchmove",
        (e) => {
          if (e.touches.length > 0 && isTouching) {
            touchX = e.touches[0].clientX;
            touchY = e.touches[0].clientY;
            mouseX = touchX;
            mouseY = touchY;

            if (rafId === null) {
              rafId = requestAnimationFrame(updateMaskPosition);
            }
          }
        },
        { passive: true }
      );

      window.addEventListener(
        "touchend",
        () => {
          isTouching = false;
        },
        { passive: true }
      );

      // 2. è‡ªå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¿ãƒƒãƒæ“ä½œãŒãªã„å ´åˆã®ä»£æ›¿ï¼‰
      // ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: å®šæœŸçš„ã«ä½ç½®ã‚’å¤‰æ›´ã—ã¦è¦–è¦šçš„ãªå‹•ãã‚’æä¾›
      let autoAnimationId = null;
      let animationPhase = 0;
      const animationDuration = 4000; // 4ç§’å‘¨æœŸ
      const animationRadius = 100; // ç§»å‹•åŠå¾„ï¼ˆpxï¼‰

      const startAutoAnimation = () => {
        if (autoAnimationId !== null) return; // æ—¢ã«å®Ÿè¡Œä¸­

        const startTime = Date.now();

        const animate = () => {
          if (isTouching) {
            // ã‚¿ãƒƒãƒä¸­ã¯è‡ªå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸€æ™‚åœæ­¢
            autoAnimationId = requestAnimationFrame(animate);
            return;
          }

          // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã€getBoundingClientRectã®çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
          // ãƒªã‚µã‚¤ã‚ºæ™‚ã®ã¿å†è¨ˆç®—ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
          if (!cachedRect || Date.now() - lastRectUpdate > 100) {
            cachedRect = fvWrapper.getBoundingClientRect();
            lastRectUpdate = Date.now();
          }
          const rect = cachedRect;
          const centerX = rect.width / 2;
          const centerY = rect.height / 2;

          const elapsed = Date.now() - startTime;
          const progress = (elapsed % animationDuration) / animationDuration;

          // å††å½¢ãƒ‘ã‚¹ã§ç§»å‹•ï¼ˆã‚¹ãƒ ãƒ¼ã‚ºãªå‹•ãï¼‰
          const angle = progress * Math.PI * 2;
          const offsetX = Math.cos(angle) * animationRadius;
          const offsetY = Math.sin(angle) * animationRadius;

          mouseX = centerX + rect.left + offsetX;
          mouseY = centerY + rect.top + offsetY;

          if (rafId === null) {
            rafId = requestAnimationFrame(updateMaskPosition);
          }

          autoAnimationId = requestAnimationFrame(animate);
        };

        autoAnimationId = requestAnimationFrame(animate);
      };

      // è‡ªå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ï¼ˆå°‘ã—é…å»¶ã•ã›ã¦è‡ªç„¶ãªå‹•ãã«ï¼‰
      setTimeout(() => {
        startAutoAnimation();
      }, 500);
    }

    // åˆæœŸä½ç½®ã‚’è¨­å®šï¼ˆç”»é¢ä¸­å¤®ï¼‰
    // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã€requestAnimationFrameå†…ã§getBoundingClientRectã‚’å®Ÿè¡Œ
    const initialX = window.innerWidth / 2;
    const initialY = window.innerHeight / 2;
    requestAnimationFrame(() => {
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ï¼ˆæ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
      if (!cachedRect) {
        cachedRect = fvWrapper.getBoundingClientRect();
        lastRectUpdate = Date.now();
      }
      const rect = cachedRect;
      const x = initialX - rect.left;
      const y = initialY - rect.top;
      backgroundContainer.style.setProperty("--mouse-x", `${x}px`);
      backgroundContainer.style.setProperty("--mouse-y", `${y}px`);
    });

    // ãƒªã‚µã‚¤ã‚ºæ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
    let resizeCacheTimer = null;
    window.addEventListener(
      "resize",
      () => {
        if (resizeCacheTimer) {
          clearTimeout(resizeCacheTimer);
        }
        resizeCacheTimer = setTimeout(() => {
          cachedRect = null;
          lastRectUpdate = 0;
        }, 150);
      },
      { passive: true }
    );

    // åˆæœŸåŒ–å®Œäº†ã®ãƒ­ã‚°
    devLog("âœ… Mouse follow initialized successfully", {
      initialX,
      initialY,
      x,
      y,
      rect,
      finalMouseXVar: window.getComputedStyle(backgroundContainer).getPropertyValue("--mouse-x"),
      finalMouseYVar: window.getComputedStyle(backgroundContainer).getPropertyValue("--mouse-y"),
    });
  }

  // ãƒã‚¦ã‚¹è¿½å¾“ã®åˆæœŸåŒ–ï¼ˆ200msé…å»¶ã•ã›ã¦ã‚°ãƒªãƒƒãƒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã‚’å¾…ã¤ï¼‰
  function waitForInit() {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", () => {
        setTimeout(() => {
          initBackgroundMouseFollow();
        }, 200);
      });
    } else {
      setTimeout(() => {
        initBackgroundMouseFollow();
      }, 200);
    }
  }

  // window.onloadã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  window.addEventListener("load", () => {
    waitForInit();
  });

  // å³åº§ã«ã‚‚è©¦è¡Œï¼ˆæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
  waitForInit();
</script>
