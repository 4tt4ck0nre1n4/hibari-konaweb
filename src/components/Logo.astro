---
import { Image } from "astro:assets";
import LogoSvg from "/public/black-outline_favicon.svg";
const title = "Welcome to";
const gradientTitle = "My Portfolio";
---

<div class="logo__wrapper" id="loading-screen">
  <div class="loading-content">
    <div class="logo-container">
      <Image
        class="logo-image"
        src={LogoSvg}
        alt="ロゴ画像"
        width="200"
        height="200"
        loading="eager"
        decoding="async"
        fetchpriority="high"
      />
    </div>
    <h2 class="title">
      <div class="title-row">
        <span class="text-stroke">
          {title}
        </span>
      </div>
      <div class="title-row">
        <span class="text-gradient">
          {gradientTitle}
        </span>
      </div>
    </h2>
    <div class="loading-spinner">
      <div class="spinner"></div>
    </div>
  </div>
</div>

<script>
  import { gsap } from "gsap";

  // ローディングアニメーションの設定
  const LOADING_DURATION = 3000; // 3秒間のローディング表示

  // 初回読み込みかどうかを判定（Astroのトランジション時はスキップ）
  function isInitialLoad(): boolean {
    // sessionStorageを使用して初回読み込みを判定
    const hasVisited = sessionStorage.getItem("hasVisited");

    // 初回読み込みの場合のみローディングを表示
    // トップページに戻った場合でも、既に訪問済みの場合はローディングをスキップ
    if (!hasVisited) {
      sessionStorage.setItem("hasVisited", "true");
      return true;
    }

    // 既に訪問済みの場合はローディングをスキップ（フリーズを防ぐため）
    return false;
  }

  // ローディングスクリーンを即座に非表示にする（ページ遷移時用）
  function hideLoadingScreenImmediately() {
    const loadingScreen = document.getElementById("loading-screen") as HTMLElement;
    if (loadingScreen) {
      loadingScreen.style.display = "none";
      loadingScreen.style.visibility = "hidden";
      loadingScreen.style.opacity = "0";
      document.documentElement.style.overflow = "";
    }
  }

  // DOM要素の取得とアニメーション初期化
  function initLoadingAnimation() {
    // 初回読み込みでない場合は即座に非表示にして終了
    if (!isInitialLoad()) {
      hideLoadingScreenImmediately();
      return;
    }

    const loadingScreen = document.getElementById("loading-screen") as HTMLElement;
    // AstroのImageコンポーネントはimg要素を生成するので、imgタグを直接検索
    const logoImage = document.querySelector("#loading-screen img") as HTMLElement;
    const title = document.querySelector("#loading-screen .title") as HTMLElement;
    const spinner = document.querySelector("#loading-screen .spinner") as HTMLElement;

    if (!loadingScreen || !logoImage || !title || !spinner) {
      console.warn("Loading animation elements not found", {
        loadingScreen: !!loadingScreen,
        logoImage: !!logoImage,
        title: !!title,
        spinner: !!spinner,
      });
      // フォールバック: 要素が見つからない場合は即座に非表示
      hideLoadingScreenImmediately();
      return;
    }

    // タイムアウト処理を設定（フリーズを防ぐため）
    let timeoutId: ReturnType<typeof setTimeout> | null = null;

    // requestAnimationFrameを使用してブラウザのレンダリングサイクルに合わせる
    // これにより強制リフローを防ぐ
    requestAnimationFrame(() => {
      // ページ読み込み中はスクロールを無効化（CLSを防ぐためbodyではなくhtmlに設定）
      document.documentElement.style.overflow = "hidden";

      // タイムアウト処理を設定（フリーズを防ぐため）
      timeoutId = setTimeout(() => {
        hideLoadingScreenImmediately();
        if (spinner) {
          gsap.killTweensOf(spinner);
        }
        if (loadingScreen) {
          gsap.killTweensOf(loadingScreen);
        }
        if (logoImage) {
          gsap.killTweensOf(logoImage);
        }
        if (title) {
          gsap.killTweensOf(title);
        }
      }, LOADING_DURATION + 2000); // アニメーション時間 + 2秒のマージン

      // 初期状態を一度に設定（バッチ処理で強制リフローを最小化）
      // GSAPの設定を最適化：force3Dを使用してGPUアクセラレーションを有効化
      gsap.set(loadingScreen, {
        opacity: 1,
        display: "flex",
        visibility: "visible",
        force3D: true,
      });

      gsap.set([logoImage, title], {
        opacity: 0,
        scale: 0.8,
        force3D: true,
      });

      gsap.set(spinner, {
        opacity: 0,
        scale: 0.8,
        force3D: true,
      });

      // 次のフレームでアニメーションを開始（レイアウト計算を待つ）
      requestAnimationFrame(() => {
        // ローディングアニメーションの実行
        const tl = gsap.timeline({
          force3D: true, // タイムライン全体でGPUアクセラレーションを有効化
          onComplete: () => {
            // スピナーの回転アニメーションを開始
            gsap.to(spinner, {
              rotation: 360,
              duration: 1.2,
              ease: "none",
              repeat: -1,
              force3D: true,
            });
          },
        });

        // ロゴとタイトルのフェードイン
        tl.to(
          [logoImage, title],
          {
            opacity: 1,
            scale: 1,
            duration: 0.8,
            ease: "back.out(1.7)",
            stagger: 0.2,
            force3D: true,
          },
          0
        )
          // スピナーの表示
          .to(
            spinner,
            {
              opacity: 1,
              scale: 1,
              duration: 0.5,
              ease: "power2.out",
              force3D: true,
            },
            "-=0.3"
          );
      });

      // 指定時間後にフェードアウト
      setTimeout(() => {
        requestAnimationFrame(() => {
          // タイムアウトをクリア
          if (timeoutId !== null) {
            clearTimeout(timeoutId);
            timeoutId = null;
          }

          // スピナーのアニメーションを停止
          gsap.killTweensOf(spinner);

          // ローディングスクリーンをフェードアウト
          gsap.to(loadingScreen, {
            opacity: 0,
            duration: 0.8,
            ease: "power2.inOut",
            force3D: true,
            onComplete: () => {
              // 確実に非表示にする
              loadingScreen.style.display = "none";
              loadingScreen.style.visibility = "hidden";
              loadingScreen.style.opacity = "0";
              // メインコンテンツの表示を許可（CLSを防ぐためhtmlに設定）
              document.documentElement.style.overflow = "";
              // GSAPアニメーションをクリーンアップ
              gsap.killTweensOf(loadingScreen);
              gsap.killTweensOf([logoImage, title, spinner]);
            },
          });
        });
      }, LOADING_DURATION);
    });
  }

  // View Transitions対応: ページ遷移時の処理
  document.addEventListener("astro:after-swap", () => {
    // ページ遷移時はローディングスクリーンを確実に非表示にする
    hideLoadingScreenImmediately();

    // スピナーのアニメーションを停止
    const spinner = document.querySelector("#loading-screen .spinner");
    if (spinner) {
      gsap.killTweensOf(spinner);
    }

    // ローディングスクリーンのアニメーションを停止
    const loadingScreen = document.getElementById("loading-screen");
    if (loadingScreen) {
      gsap.killTweensOf(loadingScreen);
    }
  });

  // DOM準備状態を確認してからアニメーションを初期化
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      // requestAnimationFrameを使用してブラウザのレンダリングサイクルに合わせる
      requestAnimationFrame(() => {
        requestAnimationFrame(initLoadingAnimation);
      });
    });
  } else {
    // DOMが既に読み込まれている場合もrequestAnimationFrameを使用
    requestAnimationFrame(() => {
      requestAnimationFrame(initLoadingAnimation);
    });
  }
</script>
