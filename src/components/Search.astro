---

---

<link rel="stylesheet" href="/css/pagefind-ui.css" media="print" />

<div id="search"></div>

<style>
  #search {
    width: 100%;
    height: auto;
    min-height: 14vh; /* Clock.astroと同じ高さ基準 */
    background: var(--color-white);
    border-radius: 1rem;
    border: var(--color-gray) 1px solid;
    transition-duration: 300ms;
    position: relative; /* Clock.astroと同じposition設定 */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.5rem; /* Clock.astroと同じパディング */
    box-sizing: border-box; /* Clock.astroと同じボックスサイズ */
  }

  @media (width <= 480px) {
    #search {
      min-height: 12vh; /* モバイル版のClock.astroと同じ高さ */
      padding: 0.25rem; /* Clock.astroと同じパディング */
    }
  }

  /* iPhone特有の調整 */
  @media (width <= 480px) and (-webkit-min-device-pixel-ratio: 2) {
    #search {
      min-height: 14vh; /* iPhone版のClock.astroと同じ高さ */
      padding: 0.25rem;
    }
  }

  /* Pagefind UIの検索ボックスのスタイル調整 */
  #search .pagefind-ui__search-input {
    font-size: 1rem;
    padding: 0.75rem;
    border-radius: 0.5rem;
    width: 100%;
    max-width: 400px; /* 最大幅を制限 */
  }

  /* PagefindUIが初期化された後も、検索コンテナの基本スタイルを維持 */
  #search .pagefind-ui {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  /* 検索結果が表示されていない状態でも、検索コンテナのスタイルを維持 */
  #search .pagefind-ui__search-input-wrapper {
    width: 100%;
    max-width: 400px;
    display: flex;
    justify-content: center;
  }

  @media (width <= 480px) {
    #search .pagefind-ui__search-input {
      font-size: 0.9rem; /* モバイルでは少し小さく */
      max-width: 100%; /* モバイルでは全幅使用 */
      margin: 0 auto; /* 中央配置 */
      padding: 0.5rem;
      border: 1px solid var(--color-aqua) !important;
    }

    /* スマホサイズでのPagefind UIのコンテナ全体を中央配置 */
    #search .pagefind-ui {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }
  }
</style>

<script>
  import { PagefindUI } from "@pagefind/default-ui";

  // CSSの遅延読み込み: requestIdleCallbackが利用可能な場合はそれを使用、そうでなければsetTimeout
  const loadPagefindCSS = () => {
    const link = document.querySelector('link[href="/css/pagefind-ui.css"]') as HTMLLinkElement;
    if (link && link.media === "print") {
      // まだ読み込まれていない場合のみ読み込む
      link.media = "all";
    }
  };

  // 初回読み込み時のみ遅延読み込み
  // View Transitions後は即座に読み込む必要があるため、別途処理
  const isInitialLoad = !(window as any).__pagefindCSSLoaded;
  if (isInitialLoad) {
    (window as any).__pagefindCSSLoaded = true;
    if ("requestIdleCallback" in window) {
      requestIdleCallback(loadPagefindCSS, { timeout: 2000 });
    } else {
      setTimeout(loadPagefindCSS, 1000);
    }
  } else {
    // View Transitions後は即座に読み込む
    loadPagefindCSS();
  }

  let pagefindUIInstance: PagefindUI | null = null;
  let mutationObserver: MutationObserver | null = null;
  let resizeHandler: (() => void) | null = null;

  // iPhone判定のヘルパー関数
  const isIPhone = (): boolean => {
    return window.innerWidth <= 480 && window.devicePixelRatio >= 2;
  };

  // 検索コンテナの基本スタイルを確実に適用
  const ensureContainerStyle = () => {
    const searchContainer = document.querySelector("#search") as HTMLElement;
    if (searchContainer) {
      const isSmallScreen = window.innerWidth <= 480;
      const isIPhoneDevice = isIPhone();

      // 検索コンテナの基本スタイルを常に維持（CSSで定義されているスタイルも明示的に設定）
      searchContainer.style.width = "100%";
      searchContainer.style.height = "auto";
      searchContainer.style.minHeight = isIPhoneDevice ? "14vh" : isSmallScreen ? "12vh" : "14vh";
      searchContainer.style.background = "#f1f5f9";
      searchContainer.style.borderRadius = "1rem";
      searchContainer.style.border = "1px solid #808080";
      searchContainer.style.transitionDuration = "300ms";
      searchContainer.style.display = "flex";
      searchContainer.style.flexDirection = "column";
      searchContainer.style.alignItems = "center";
      searchContainer.style.justifyContent = "center";
      searchContainer.style.padding = isSmallScreen ? "0.25rem" : "0.5rem";
      searchContainer.style.boxSizing = "border-box";
      searchContainer.style.position = "relative";
    }

    // PagefindUIのコンテナスタイルを維持
    const pagefindUI = document.querySelector("#search .pagefind-ui") as HTMLElement;
    if (pagefindUI) {
      pagefindUI.style.width = "100%";
      pagefindUI.style.display = "flex";
      pagefindUI.style.flexDirection = "column";
      pagefindUI.style.alignItems = "center";
      pagefindUI.style.justifyContent = "center";
    }
  };

  // スマホサイズでのみ検索ボックスのborderを強制的に設定
  const applyBorderStyle = () => {
    // コンテナスタイルを先に適用
    ensureContainerStyle();

    const searchInput = document.querySelector("#search .pagefind-ui__search-input") as HTMLInputElement;
    if (searchInput) {
      // スマホサイズかどうかをチェック
      if (window.innerWidth <= 480) {
        searchInput.style.border = "1px solid #00ffff";
        searchInput.style.borderColor = "#00ffff";
        searchInput.style.setProperty("border", "1px solid #00ffff", "important");
      } else {
        // パソコンサイズではborderをリセット
        searchInput.style.border = "";
        searchInput.style.borderColor = "";
        searchInput.style.removeProperty("border");
      }
    }
  };

  function initSearch() {
    // CSSの読み込みを確実にする（View Transitions後も）
    loadPagefindCSS();

    // 既存のインスタンスを破棄
    if (pagefindUIInstance) {
      // PagefindUIにはdestroyメソッドがないため、要素をクリア
      const searchElement = document.querySelector("#search");
      if (searchElement) {
        searchElement.innerHTML = "";
      }
      pagefindUIInstance = null;
    }

    // 既存のMutationObserverを破棄
    if (mutationObserver) {
      mutationObserver.disconnect();
      mutationObserver = null;
    }

    // 既存のリサイズハンドラーを削除
    if (resizeHandler) {
      window.removeEventListener("resize", resizeHandler);
      resizeHandler = null;
    }

    // 検索コンテナの基本スタイルを先に適用（PagefindUI初期化前）
    ensureContainerStyle();

    // 新しいPagefindUIインスタンスを作成
    pagefindUIInstance = new PagefindUI({
      element: "#search",
      showImages: true,
    });

    // 検索コンテナのスタイルを確実に適用（初期化直後）
    ensureContainerStyle();

    // requestAnimationFrameでバッチ処理（メインスレッド処理の最適化）
    let rafScheduled = false;
    const scheduleStyleUpdate = () => {
      if (rafScheduled) return;
      rafScheduled = true;
      requestAnimationFrame(() => {
        ensureContainerStyle();
        applyBorderStyle();
        rafScheduled = false;
      });
    };

    // PagefindUIのDOM生成を待つ（MutationObserverで効率的に監視）
    const searchContainer = document.querySelector("#search");
    if (searchContainer) {
      let checkCount = 0;
      const maxChecks = 10; // 最大10回までチェック（約1秒）

      // MutationObserverでDOMの変更を監視（デバウンス付き）
      mutationObserver = new MutationObserver(() => {
        checkCount++;
        if (checkCount <= maxChecks) {
          scheduleStyleUpdate();
        } else {
          // 最大チェック回数に達したら監視を停止
          mutationObserver?.disconnect();
          mutationObserver = null;
        }
      });

      mutationObserver.observe(searchContainer, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ["class"],
      });

      // 初期スタイル適用（即座に1回）
      scheduleStyleUpdate();

      // フォールバック: 500ms後に最終確認（最大チェック回数に達していない場合）
      setTimeout(() => {
        if (checkCount < maxChecks) {
          scheduleStyleUpdate();
        }
      }, 500);
    }

    // ウィンドウリサイズ時にスタイルを再適用（デバウンス付き）
    let resizeTimer: ReturnType<typeof setTimeout> | null = null;
    resizeHandler = () => {
      if (resizeTimer) {
        clearTimeout(resizeTimer);
      }
      resizeTimer = setTimeout(() => {
        scheduleStyleUpdate();
      }, 150); // デバウンス時間を150msに短縮
    };
    window.addEventListener("resize", resizeHandler, { passive: true });
  }

  // DOMContentLoadedで初期化
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initSearch);
  } else {
    initSearch();
  }

  // View Transitions対応: ページ遷移時に再初期化
  document.addEventListener("astro:after-swap", () => {
    // CSS読み込みを確実にするため、少し遅延してから初期化
    // DOMの更新とCSSの読み込み完了を待つ
    setTimeout(() => {
      initSearch();
    }, 0);
  });
</script>
