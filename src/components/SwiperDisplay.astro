---
import { SWIPER_PATH_API } from "../api/headlessCms";
import { Image } from "astro:assets";
import { getOptimizedWordPressImage, getWordPressImageUrl } from "../util/optimizeWordPressImage";

interface Swiper {
  id: number;
  title: string;
  slug: string;
  acf: {
    swiper_image: string | { url: string };
    swiper_title: string;
  };
}

let swipers: Swiper[] = [];

try {
  const resSwiper = await fetch(`${SWIPER_PATH_API}${Date.now()}`, {
    method: "GET",
    headers: {
      Accept: "application/json",
    },
    // タイムアウトを設定
    signal: AbortSignal.timeout(5000),
  });

  if (!resSwiper.ok) {
    console.warn("Failed to fetch swiper data:", resSwiper.status);
  } else {
    const data = (await resSwiper.json()) as unknown as Swiper[];

    if (!Array.isArray(data)) {
      console.warn("Expected an array of posts, but received:", data);
    } else {
      swipers = data;
    }
  }
} catch (error) {
  if (error instanceof Error) {
    if (error.name === "AbortError") {
      console.warn("Swiper data fetch timed out");
    } else {
      console.warn("Error fetching swiper data:", error.message);
    }
  }
  // Continue with empty array
}

// WordPress画像を最適化（ビルド時に処理）
const optimizedSwiperImages = await Promise.all(
  swipers.slice(0, 10).map(async (swiper) => {
    const optimizedImage = await getOptimizedWordPressImage(swiper.acf?.swiper_image, {
      width: 270,
      height: 360,
      quality: 85,
      format: "webp",
    });
    // 最適化に失敗した場合は元のURLを使用
    const fallbackUrl = getWordPressImageUrl(swiper.acf?.swiper_image) ?? "";
    return {
      ...swiper,
      optimizedImage,
      fallbackUrl,
    };
  })
);

const swiperHeader = "Works Menu";
const swiperText1 = "私の活動の履歴をご覧ください。";
const swiperText2 = "Thank you for viewing my site.";
---

<section id="swiper" class="swipersDisplay">
  <div class="swipersDisplay__wrapper">
    <div class="swipersDisplay__textInner">
      <h2 class="swipes__header">
        {swiperHeader}
      </h2>
      <p class="swipers__text">
        {swiperText1}
      </p>
      <p class="swipers__text">
        {swiperText2}
      </p>
    </div>
    <div class="swipers">
      <div class="swipers-wrapper" style={`--total: ${Math.min(swipers.length, 10)};`}>
        {
          optimizedSwiperImages.map((swiperData, index) => (
            <div class="swipers-slide" style={`--position: ${index + 1};`}>
              {swiperData.optimizedImage ? (
                <>
                  <Image
                    src={swiperData.optimizedImage.src}
                    alt={swiperData.acf?.swiper_title ?? ""}
                    class="swipers__image"
                    width={270}
                    height={360}
                    loading="lazy"
                    decoding="async"
                    fetchpriority="low"
                  />
                  <Image
                    src={swiperData.optimizedImage.src}
                    alt={swiperData.acf?.swiper_title ?? ""}
                    class="swipers__shadow"
                    width={270}
                    height={360}
                    loading="lazy"
                    decoding="async"
                    fetchpriority="low"
                  />
                </>
              ) : (
                <>
                  <img
                    src={swiperData.fallbackUrl}
                    alt={swiperData.acf?.swiper_title ?? ""}
                    class="swipers__image"
                    width="270"
                    height="360"
                    decoding="async"
                    loading="lazy"
                    fetchpriority="low"
                  />
                  <img
                    src={swiperData.fallbackUrl}
                    alt={swiperData.acf?.swiper_title ?? ""}
                    class="swipers__shadow"
                    width="270"
                    height="360"
                    decoding="async"
                    loading="lazy"
                    fetchpriority="low"
                  />
                </>
              )}
            </div>
          ))
        }
      </div>
    </div>
  </div>
</section>

<style>
  .swipersDisplay__wrapper {
    width: 100%;
    max-width: 1200px;
    position: relative;
    margin-inline: auto;
  }
  .swipersDisplay__textInner {
    display: grid;
    place-items: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 5;
  }
  .swipers__header {
    font-size: 2rem;
    color: inherit;
  }
  .swipers__text {
    font-size: 1rem;
    color: inherit;
    margin-block-start: 1rem;
  }
  .swipers {
    width: 100%;
    height: 100vh;
    min-height: 600px; /* CLS対策: 固定の最小高さを確保 */
    text-align: center;
    position: relative;
    overflow: hidden;
    border-radius: 0.5rem;
    box-shadow: 0 8px 16px 0 rgb(0 0 0 / 0.6);
    margin-block-start: 4rem;
    padding-block-start: 4rem;
    padding-block-end: 2rem;
  }
  .swipers-wrapper {
    width: 300px;
    height: 400px;
    min-height: 400px; /* CLS対策: 固定の最小高さを明示 */
    position: relative;
    top: 24%;
    left: calc(50% - 160px);
    transform-style: preserve-3d;
    transform: perspective(1600px);
    backface-visibility: hidden;
    animation: rotation 32s ease-in-out infinite;
  }
  @keyframes rotation {
    from {
      transform: perspective(1600px) rotateX(-24deg) rotateY(0deg);
    }
    to {
      transform: perspective(1600px) rotateX(-24deg) rotateY(360deg);
    }
  }
  @keyframes rotation-mobile {
    from {
      transform: perspective(1800px) rotateX(-20deg) rotateY(0deg);
    }
    to {
      transform: perspective(1800px) rotateX(-20deg) rotateY(360deg);
    }
  }
  .swipers-slide {
    width: 100%;
    height: 100%;
    border-radius: 0.5rem;
    position: absolute;
    top: 0%;
    left: 0%;
    z-index: 20;
    /* パフォーマンス最適化: GPUアクセラレーションを有効化 */
    transform: rotateY(calc((var(--position) - 1) * (360 / var(--total)) * 1deg)) translateZ(600px) scale(-1, 1);
    /* パフォーマンス最適化: will-changeはJavaScriptで動的に管理 */
  }
  .swipers-slide::before {
    content: "";
    width: 100%;
    height: 100%;
    background: radial-gradient(
      ellipse farthest-corner at center,
      rgb(255 255 255 / 0.8) 0%,
      rgb(255 255 255 / 0) 100%
    );
    background-size: 600% 100%;
    position: absolute;
    top: 0%;
    left: calc(50% - 160px);
    z-index: 20;
    transform: rotateY(calc((var(--position) - 1) * (360 / var(--total)) * 1deg)) translateZ(600px);
    animation: reflection 32s linear infinite;
  }

  /* 反射アニメーション */
  @keyframes reflection {
    0% {
      transform: translateY(0%);
      background-position-x: 400%;
    }
    24% {
      transform: translateY(0%);
      background-position-x: 240%;
    }
    56% {
      transform: translateY(0%);
      background-position-x: 0%;
    }
    100% {
      transform: translateY(0%);
      background-position-x: -320%;
    }
  }
  /* スマホサイズでの反射アニメーション */
  @keyframes reflection-mobile {
    0% {
      transform: translateY(0%);
      background-position-x: 400%;
    }
    24% {
      transform: translateY(0%);
      background-position-x: 240%;
    }
    56% {
      transform: translateY(0%);
      background-position-x: 0%;
    }
    100% {
      transform: translateY(0%);
      background-position-x: -320%;
    }
  }
  /* swiperスライド画像 */
  .swipers__image {
    width: 100%;
    height: 100%;
    background: linear-gradient(225deg, #bdc3c9 0%, var(--color-white) 50%, #bdc3c9 100%);
    box-shadow:
      10px 15px 22px -5px rgb(0 0 0 / 0.2),
      0 0 2px rgb(0 0 0 / 0.15);
    border-radius: 0.5rem;
    object-fit: cover;
    position: absolute;
    top: 0%;
    left: calc(50% - 160px);
    z-index: -1;
    overflow: hidden;
    transform-style: preserve-3d;
    transform: perspective(40px) scale(0.96);
    pointer-events: none;
    padding: 0.5rem;
  }
  .swipers-slide::after {
    content: "";
    width: 100%;
    height: 100%;
    background: linear-gradient(180deg, #ffffff71 10%, transparent 32%, #ffffff 72%);
    background-size: 600% 100%;
    box-shadow: 0 16px 32px 0 rgb(0 0 0 / 0.6);
    /* パフォーマンス最適化: blurを削除（視覚的影響を最小限に） */
    border-radius: 0.5rem;
    position: absolute;
    top: 104%;
    left: calc(50% - 160px);
    z-index: 20;
    transform: rotateY(calc((var(--position) - 1) * (360 / var(--total)) * 1deg)) translateZ(600px);
    animation: reflection 32s linear infinite;
  }
  /* 反射画像（影のような透過した画像） */
  .swipers__shadow {
    width: 100%;
    height: 100%;
    background: linear-gradient(225deg, #bdc3c9 0%, var(--color-white) 50%, #bdc3c9 100%);
    box-shadow:
      10px 15px 22px -5px rgb(0 0 0 / 0.2),
      0 0 2px rgb(0 0 0 / 0.15);
    border-radius: 0.5rem;
    object-fit: cover;
    position: absolute;
    top: 100%;
    left: calc(50% - 160px);
    z-index: 10;
    transform-style: preserve-3d;
    /* 親要素の3D変換を継承し、Y軸のみを反転して上下反転効果を実現 */
    transform: scale(1, -1);
    pointer-events: none;
    padding: 1rem;
    /* 透明度とぼかし効果 */
    opacity: 0.65;
    /* パフォーマンス最適化: blurを削除、brightnessのみ使用 */
    filter: brightness(1.1);
    /* 下部に向かってフェードアウトするグラデーションマスク */
    mask-image: linear-gradient(
      to bottom,
      rgb(0 0 0 / 0.9) 0%,
      rgb(0 0 0 / 0.8) 30%,
      rgb(0 0 0 / 0.6) 60%,
      rgb(0 0 0 / 0.3) 85%,
      rgb(0 0 0 / 0) 100%
    );
    -webkit-mask-image: linear-gradient(
      to bottom,
      rgb(0 0 0 / 0.9) 0%,
      rgb(0 0 0 / 0.8) 30%,
      rgb(0 0 0 / 0.6) 60%,
      rgb(0 0 0 / 0.3) 85%,
      rgb(0 0 0 / 0) 100%
    );
  }

  /* スマホサイズでのテキスト中央配置 */
  @media (width <= 480px) {
    .swipers__header {
      width: 100%;
    }

    .swipers__text {
      width: 100%;
      margin-block-start: 0;
      line-height: 1.8;
    }

    .swipers__text:first-of-type {
      margin-block-start: 1rem;
    }

    .swipers__text:last-of-type {
      margin-block-start: 0.5rem;
    }

    .swipers {
      margin-block-start: 0;
      padding-block-start: 0;
    }

    /* スマホサイズでのスワイパー調整：引きの画角、小さな画像、滑らかなアニメーション */
    .swipers-wrapper {
      width: 150px;
      height: 200px;
      min-height: 200px;
      left: calc(50% - 75px);
      transform: perspective(1800px);
      animation: rotation-mobile 32s ease-in-out infinite;
    }

    .swipers-slide {
      transform: rotateY(calc((var(--position) - 1) * (360 / var(--total)) * 1deg)) translateZ(280px) scale(-1, 1);
    }

    .swipers-slide::before {
      left: calc(50% - 75px);
      transform: rotateY(calc((var(--position) - 1) * (360 / var(--total)) * 1deg)) translateZ(280px);
      animation: reflection-mobile 32s ease-in-out infinite;
    }

    .swipers-slide::after {
      left: calc(50% - 75px);
      transform: rotateY(calc((var(--position) - 1) * (360 / var(--total)) * 1deg)) translateZ(280px);
      animation: reflection-mobile 32s ease-in-out infinite;
    }

    .swipers__image {
      left: calc(50% - 75px);
    }

    .swipers__shadow {
      left: calc(50% - 75px);
      /* 親要素の3D変換を継承し、Y軸のみを反転（上下反転） */
      transform: scale(1, -1);
    }
  }

  /* パフォーマンス最適化: アニメーション一時停止用のクラス */
  .swipers-wrapper.paused {
    animation-play-state: paused;
  }

  .swipers-slide.paused::before,
  .swipers-slide.paused::after {
    animation-play-state: paused;
  }
</style>

<script>
  // パフォーマンス最適化: ビューポート外ではアニメーションを一時停止
  (function () {
    const swiperSection = document.getElementById("swiper");
    const swiperWrapper = swiperSection?.querySelector<HTMLElement>(".swipers-wrapper");
    const swiperSlides = swiperSection?.querySelectorAll<HTMLElement>(".swipers-slide");

    if (!swiperSection || !swiperWrapper || !swiperSlides) return;

    // Intersection Observerでビューポート内かどうかを監視
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const isVisible = entry.isIntersecting && entry.intersectionRatio > 0.1;

          if (isVisible) {
            // ビューポート内: アニメーションを再開
            swiperWrapper.classList.remove("paused");
            swiperWrapper.style.willChange = "transform";
            swiperSlides.forEach((slide) => {
              slide.classList.remove("paused");
            });
          } else {
            // ビューポート外: アニメーションを一時停止
            swiperWrapper.classList.add("paused");
            swiperWrapper.style.willChange = "auto";
            swiperSlides.forEach((slide) => {
              slide.classList.add("paused");
            });
          }
        });
      },
      {
        threshold: [0, 0.1, 0.5, 1],
        rootMargin: "50px", // 少し余裕を持たせる
      }
    );

    observer.observe(swiperSection);

    // ページが非表示になった時（別タブに切り替え等）も一時停止
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        swiperWrapper.classList.add("paused");
        swiperWrapper.style.willChange = "auto";
        swiperSlides.forEach((slide) => {
          slide.classList.add("paused");
        });
      } else {
        // ページが再表示された時、Intersection Observerが自動的に処理
        // 念のため、ビューポート内か確認して再開
        const rect = swiperSection.getBoundingClientRect();
        const isInViewport =
          rect.top < window.innerHeight && rect.bottom > 0 && rect.left < window.innerWidth && rect.right > 0;

        if (isInViewport) {
          swiperWrapper.classList.remove("paused");
          swiperWrapper.style.willChange = "transform";
          swiperSlides.forEach((slide) => {
            slide.classList.remove("paused");
          });
        }
      }
    });
  })();
</script>
