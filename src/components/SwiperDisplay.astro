---
import { SWIPER_PATH_API } from "../api/headlessCms";

interface Swiper {
  id: number;
  title: string;
  slug: string;
  acf: {
    swiper_image: string | { url: string };
    swiper_title: string;
  };
}

let swipers: Swiper[] = [];

try {
  const resSwiper = await fetch(`${SWIPER_PATH_API}${Date.now()}`, {
    method: "GET",
    headers: {
      Accept: "application/json",
    },
    // タイムアウトを設定
    signal: AbortSignal.timeout(5000),
  });

  if (!resSwiper.ok) {
    console.warn("Failed to fetch swiper data:", resSwiper.status);
  } else {
    const data = (await resSwiper.json()) as unknown as Swiper[];

    if (!Array.isArray(data)) {
      console.warn("Expected an array of posts, but received:", data);
    } else {
      swipers = data;
    }
  }
} catch (error) {
  if (error instanceof Error) {
    if (error.name === "AbortError") {
      console.warn("Swiper data fetch timed out");
    } else {
      console.warn("Error fetching swiper data:", error.message);
    }
  }
  // Continue with empty array
}

const swiperHeader = "Works Menu";
const swiperText1 = "私の活動の履歴をご覧ください。";
// const swiperText1 = "Hello, this is hibari-konaweb.com's Portfolio Site.";
const swiperText2 = "Thank you for viewing my site.";
---

<section id="swiper" class="swipersDisplay">
  <div class="swipersDisplay__wrapper">
    <div class="swipersDisplay__textInner">
      <h2 class="swipes__header">
        {swiperHeader}
      </h2>
      <p class="swipers__text">
        {swiperText1}
      </p>
      <p class="swipers__text">
        {swiperText2}
      </p>
    </div>
    <div class="swipers">
      <div class="swipers-wrapper" style={`--total: ${Math.min(swipers.length, 10)};`}>
        {
          swipers.slice(0, 10).map((swiper, index) => (
            <div class="swipers-slide" style={`--position: ${index + 1};`}>
              <img
                src={
                  typeof swiper.acf?.swiper_image === "object" ? swiper.acf?.swiper_image.url : swiper.acf?.swiper_image
                }
                alt={swiper.acf?.swiper_title ?? ""}
                class="swipers__image"
                width="270"
                height="360"
                loading="lazy"
                decoding="async"
              />
              <img
                src={
                  typeof swiper.acf?.swiper_image === "object" ? swiper.acf?.swiper_image.url : swiper.acf?.swiper_image
                }
                alt={swiper.acf?.swiper_title ?? ""}
                class="swipers__shadow"
                width="270"
                height="360"
                loading="lazy"
                decoding="async"
              />
            </div>
          ))
        }
      </div>
    </div>
  </div>
</section>

<style>
  .swipersDisplay__wrapper {
    width: 100%;
    max-width: 1200px;
    position: relative;
    margin-inline: auto;
  }
  .swipersDisplay__textInner {
    display: grid;
    place-items: center;
    position: absolute;
    top: 34%;
    left: 42%;
    z-index: 5;
  }
  .swipers__header {
    font-size: 2rem;
    color: inherit;
  }
  .swipers__text {
    font-size: 1rem;
    color: inherit;
    margin-block-start: 1rem;
  }
  .swipers {
    width: 100%;
    height: 100vh;
    min-height: 600px; /* CLS対策: 固定の最小高さを確保 */
    text-align: center;
    position: relative;
    overflow: hidden;
    border-radius: 0.5rem;
    box-shadow: 0 8px 16px 0 rgba(0 0 0 / 0.6);
    margin-block-start: 4rem;
    padding-block-start: 4rem;
    padding-block-end: 2rem;
  }
  .swipers-wrapper {
    width: 300px;
    height: 400px;
    min-height: 400px; /* CLS対策: 固定の最小高さを明示 */
    position: relative;
    top: 24%;
    left: calc(50% - 160px);
    transform-style: preserve-3d;
    transform: perspective(1600px);
    will-change: transform;
    backface-visibility: hidden;
    animation: rotation 32s linear infinite;
    animation: rotation 32s ease-in-out infinite;
  }
  @keyframes rotation {
    from {
      transform: perspective(1600px) rotateX(-24deg) rotateY(0deg);
    }
    to {
      transform: perspective(1600px) rotateX(-24deg) rotateY(360deg);
    }
  }
  @keyframes rotation-mobile {
    from {
      transform: perspective(1800px) rotateX(-20deg) rotateY(0deg);
    }
    to {
      transform: perspective(1800px) rotateX(-20deg) rotateY(360deg);
    }
  }
  .swipers-slide {
    width: 100%;
    height: 100%;
    /* box-shadow:
      10px 15px 22px -5px rgba(0 0 0 / 0.2),
      0 0 2px rgba(0 0 0 / 0.15); */
    border-radius: 0.5rem;
    position: absolute;
    top: 0%;
    left: 0%;
    z-index: 20;
    transform: rotateY(calc((var(--position) - 1) * (360 / var(--total)) * 1deg)) translateZ(600px) scale(-1, 1);
    will-change: transform;
  }
  .swipers-slide::before {
    content: "";
    width: 100%;
    height: 100%;
    background: radial-gradient(
      ellipse farthest-corner at center,
      rgba(255 255 255 / 0.8) 0%,
      rgba(255 255 255 / 0) 100%
    );
    background-size: 600% 100%;
    position: absolute;
    top: 0%;
    left: calc(50% - 160px);
    z-index: 20;
    transform: rotateY(calc((var(--position) - 1) * (360 / var(--total)) * 1deg)) translateZ(600px);
    animation: reflection 32s linear infinite;
  }

  /* 反射アニメーション */
  @keyframes reflection {
    0% {
      transform: translateY(0%);
      background-position-x: 400%;
    }
    24% {
      transform: translateY(0%);
      background-position-x: 240%;
    }
    56% {
      transform: translateY(0%);
      background-position-x: 0%;
    }
    100% {
      transform: translateY(0%);
      background-position-x: -320%;
    }
  }
  /* スマホサイズでの反射アニメーション */
  @keyframes reflection-mobile {
    0% {
      transform: translateY(0%);
      background-position-x: 400%;
    }
    24% {
      transform: translateY(0%);
      background-position-x: 240%;
    }
    56% {
      transform: translateY(0%);
      background-position-x: 0%;
    }
    100% {
      transform: translateY(0%);
      background-position-x: -320%;
    }
  }
  /* swiperスライド画像 */
  .swipers__image {
    width: 100%;
    height: 100%;
    background: linear-gradient(225deg, #bdc3c9 0%, #ffffff 50%, #bdc3c9 100%);
    box-shadow:
      10px 15px 22px -5px rgba(0 0 0 / 0.2),
      0 0 2px rgba(0 0 0 / 0.15);
    border-radius: 0.5rem;
    object-fit: cover;
    position: absolute;
    top: 0%;
    left: calc(50% - 160px);
    z-index: -1;
    overflow: hidden;
    transform-style: preserve-3d;
    transform: perspective(40px) scale(0.96);
    pointer-events: none;
    padding: 0.5rem;
  }
  .swipers-slide::after {
    content: "";
    width: 100%;
    height: 100%;
    background: linear-gradient(180deg, #ffffff71 10%, transparent 32%, #ffffff 72%);
    background-size: 600% 100%;
    box-shadow: 0 16px 32px 0 rgba(0 0 0 / 0.6);
    filter: blur(2px);
    border-radius: 0.5rem;
    position: absolute;
    top: 104%;
    left: calc(50% - 160px);
    z-index: 20;
    transform: rotateY(calc((var(--position) - 1) * (360 / var(--total)) * 1deg)) translateZ(600px);
    animation: reflection 32s linear infinite;
  }
  /* 反射画像（影のような透過した画像） */
  .swipers__shadow {
    width: 100%;
    height: 100%;
    background: linear-gradient(225deg, #bdc3c9 0%, #ffffff 50%, #bdc3c9 100%);
    box-shadow:
      10px 15px 22px -5px rgba(0 0 0 / 0.2),
      0 0 2px rgba(0 0 0 / 0.15);
    border-radius: 0.5rem;
    object-fit: cover;
    position: absolute;
    top: 100%;
    left: calc(50% - 160px);
    z-index: 10;
    transform-style: preserve-3d;
    /* 親要素の3D変換を継承し、Y軸のみを反転して上下反転効果を実現 */
    transform: scale(1, -1);
    pointer-events: none;
    padding: 1rem;
    /* 透明度とぼかし効果 */
    opacity: 0.65;
    filter: blur(0.5px) brightness(1.1);
    /* 下部に向かってフェードアウトするグラデーションマスク */
    mask-image: linear-gradient(
      to bottom,
      rgba(0 0 0 / 0.9) 0%,
      rgba(0 0 0 / 0.8) 30%,
      rgba(0 0 0 / 0.6) 60%,
      rgba(0 0 0 / 0.3) 85%,
      rgba(0 0 0 / 0) 100%
    );
    -webkit-mask-image: linear-gradient(
      to bottom,
      rgba(0 0 0 / 0.9) 0%,
      rgba(0 0 0 / 0.8) 30%,
      rgba(0 0 0 / 0.6) 60%,
      rgba(0 0 0 / 0.3) 85%,
      rgba(0 0 0 / 0) 100%
    );
  }

  /* スマホサイズでのテキスト中央配置 */
  @media (max-width: 480px) {
    .swipersDisplay__textInner {
      top: 30%;
      left: 20%;
    }
    .swipers__header {
      width: 100%;
    }

    .swipers__text {
      width: 100%;
      margin-block-start: 0;
      line-height: 1.8;
    }

    .swipers__text:first-of-type {
      margin-block-start: 1rem;
    }

    .swipers__text:last-of-type {
      margin-block-start: 0.5rem;
    }

    .swipers {
      margin-block-start: 0;
      padding-block-start: 0;
    }

    /* スマホサイズでのスワイパー調整：引きの画角、小さな画像、滑らかなアニメーション */
    .swipers-wrapper {
      width: 150px;
      height: 200px;
      min-height: 200px;
      left: calc(50% - 75px);
      transform: perspective(1800px);
      animation: rotation-mobile 32s ease-in-out infinite;
    }

    .swipers-slide {
      transform: rotateY(calc((var(--position) - 1) * (360 / var(--total)) * 1deg)) translateZ(280px) scale(-1, 1);
    }

    .swipers-slide::before {
      left: calc(50% - 75px);
      transform: rotateY(calc((var(--position) - 1) * (360 / var(--total)) * 1deg)) translateZ(280px);
      animation: reflection-mobile 32s ease-in-out infinite;
      will-change: transform, background-position;
    }

    .swipers-slide::after {
      left: calc(50% - 75px);
      transform: rotateY(calc((var(--position) - 1) * (360 / var(--total)) * 1deg)) translateZ(280px);
      animation: reflection-mobile 32s ease-in-out infinite;
      will-change: transform;
    }

    .swipers__image {
      left: calc(50% - 75px);
    }

    .swipers__shadow {
      left: calc(50% - 75px);
      /* 親要素の3D変換を継承し、Y軸のみを反転（上下反転） */
      transform: scale(1, -1);
    }
  }
</style>
