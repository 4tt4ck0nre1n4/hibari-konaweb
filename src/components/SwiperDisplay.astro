---
import { SWIPER_PATH_API } from "../api/headlessCms";

interface Swiper {
  id: number;
  title: string;
  slug: string;
  acf: {
    swiper_image: string | { url: string };
    swiper_title: string;
  };
}

let swipers: Swiper[] = [];

try {
  const resSwiper = await fetch(`${SWIPER_PATH_API}${Date.now()}`, {
    method: "GET",
    headers: {
      Accept: "application/json",
    },
    // タイムアウトを設定
    signal: AbortSignal.timeout(5000),
  });

  if (!resSwiper.ok) {
    console.warn("Failed to fetch swiper data:", resSwiper.status);
  } else {
    const data = (await resSwiper.json()) as unknown as Swiper[];

    if (!Array.isArray(data)) {
      console.warn("Expected an array of posts, but received:", data);
    } else {
      swipers = data;
    }
  }
} catch (error) {
  if (error instanceof Error) {
    if (error.name === "AbortError") {
      console.warn("Swiper data fetch timed out");
    } else {
      console.warn("Error fetching swiper data:", error.message);
    }
  }
  // Continue with empty array
}

const swiperHeader = "Works Menu";
const swiperText1 = "Hello, this is hibari-konaweb.com's Portfolio Site.";
const swiperText2 = "Thank you for viewing my site.";
---

<section id="swiper" class="swipersDisplay">
  <div class="swipersDisplay__wrapper">
    <div class="textArea">
      <h2 class="swipes__header">
        {swiperHeader}
      </h2>
      <p class="swipers__text">
        {swiperText1}
      </p>
      <p class="swipers__text">
        {swiperText2}
      </p>
    </div>
    <div class="swipers">
      <div class="swipers-wrapper" style={`--total: ${Math.min(swipers.length, 10)};`}>
        {
          swipers.slice(0, 10).map((swiper, index) => (
            <div class="swipers-slide" style={`--position: ${index + 1};`}>
              <img
                src={
                  typeof swiper.acf?.swiper_image === "object" ? swiper.acf?.swiper_image.url : swiper.acf?.swiper_image
                }
                alt={swiper.acf?.swiper_title ?? ""}
                class="swipers__image"
                width="270"
                height="360"
                loading="lazy"
                decoding="async"
              />
              <img
                src={
                  typeof swiper.acf?.swiper_image === "object" ? swiper.acf?.swiper_image.url : swiper.acf?.swiper_image
                }
                alt={swiper.acf?.swiper_title ?? ""}
                class="swipers__shadow"
                width="270"
                height="360"
                loading="lazy"
                decoding="async"
              />
            </div>
          ))
        }
      </div>
    </div>
  </div>
</section>

<style>
  .swipersDisplay__wrapper {
    width: 1200px;
    max-width: 100%;
    position: relative;
    margin-inline: auto;
  }
  .textArea {
    display: grid;
    place-items: center;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: 34%;
    left: 36%;
    z-index: 5;
  }
  .swipers__header {
    font-size: 2rem;
    color: inherit;
  }
  .swipers__text {
    font-size: 1rem;
    color: inherit;
    margin-block-start: 1rem;
  }
  .swipers {
    width: 100%;
    height: 100vh;
    text-align: center;
    position: relative;
    overflow: hidden;
    border-radius: 0.5rem;
    box-shadow: 0 8px 16px 0 rgba(0 0 0 / 0.6);
    margin-block-start: 4rem;
    padding-block: 4rem;
  }
  .swipers-wrapper {
    width: 200px;
    height: 250px;
    width: 320px;
    width: 300px;
    height: 160px;
    height: 400px;
    position: relative;
    top: 24%;
    left: calc(50% - 160px);
    transform-style: preserve-3d;
    transform: perspective(1600px);
    animation: rotation 32s linear infinite;
  }
  @keyframes rotation {
    from {
      transform: perspective(1600px) rotateX(-24deg) rotateY(0deg);
    }
    to {
      transform: perspective(1600px) rotateX(-24deg) rotateY(360deg);
    }
  }
  .swipers-slide {
    width: 100%;
    height: 100%;
    box-shadow:
      10px 15px 22px -5px rgba(0 0 0 / 0.2),
      0 0 2px rgba(0 0 0 / 0.15);
    border-radius: 0.5rem;
    position: absolute;
    top: 0%;
    left: 0%;
    /* inset: 0 0 0 0; */
    z-index: 20;
    /* aspect-ratio: 2 / 1; */
    /* opacity: 1; */
    transform: rotateY(calc((var(--position) - 1) * (360 / var(--total)) * 1deg)) translateZ(600px) scale(-1, 1);
  }
  .swipers-slide::before {
    content: "";
    width: 100%;
    height: 100%;
    background: radial-gradient(
      ellipse farthest-corner at center,
      rgba(255 255 255 / 0.8) 0%,
      rgba(255 255 255 / 0) 100%
    );
    /* background: linear-gradient(-45deg, #9ccc65 50%, darken(#9ccc65, 20%) 60%, #9ccc65 70%); */
    /* background: linear-gradient(
      -45deg,
      #bdc3c9 50%,
      darken(#bdc3c9, 20%) 60%,
      #bdc3c9 70%
    ); */
    background-size: 600% 100%;
    position: absolute;
    top: 0%;
    left: calc(50% - 160px);
    /* opacity: 0.4; */
    z-index: 20;
    transform: rotateY(calc((var(--position) - 1) * (360 / var(--total)) * 1deg)) translateZ(600px);
    /* transition: opacity 8s cubic-bezier(0.22, 1, 0.36, 1); */
    /* animation: reflection 16s infinite cubic-bezier(0.22, 1, 0.36, 1); */
    animation: reflection 32s linear infinite;
  }
  @keyframes reflection {
    0% {
      transform: translateY(0%);
      background-position-x: 400%;
    }
    24% {
      transform: translateY(0%);
      background-position-x: 240%;
    }
    56% {
      transform: translateY(0%);
      background-position-x: 0%;
    }
    100% {
      transform: translateY(0%);
      background-position-x: -320%;
    }
  }
  .swipers__image {
    width: 100%;
    height: 100%;
    background: linear-gradient(225deg, #bdc3c9 0%, #ffffff 50%, #bdc3c9 100%);
    box-shadow:
      10px 15px 22px -5px rgba(0 0 0 / 0.2),
      0 0 2px rgba(0 0 0 / 0.15);
    border-radius: 0.5rem;
    object-fit: cover;
    position: relative;
    left: calc(50% - 160px);
    z-index: -1;
    overflow: hidden;
    transform-style: preserve-3d;
    transform: perspective(40px) scale(0.96);
    pointer-events: none;
    padding: 1rem;
  }
  .swipers-slide::after {
    content: "";
    width: 100%;
    height: 100%;
    /* background: linear-gradient(180deg, rgba(255, 255, 255, 0) 0%, transparent 1%, #fff 64%); */
    background: linear-gradient(180deg, #ffffff71 10%, transparent 32%, #ffffff 72%);
    background-size: 600% 100%;
    box-shadow: 0 16px 32px 0 rgba(0 0 0 / 0.6);
    filter: blur(2px);
    border-radius: 0.5rem;
    /* position: relative; */
    position: absolute;
    top: 104%;
    /* right: 0; */
    left: calc(50% - 160px);
    z-index: 20;
    transform: rotateY(calc((var(--position) - 1) * (360 / var(--total)) * 1deg)) translateZ(600px);
    animation: reflection 32s linear infinite;
    /* transition: background cubic-bezier(0.22, 1, 0.36, 1); */
  }
  .swipers__shadow {
    width: 100%;
    height: 100%;
    /* box-shadow: 8px 8px 20px 0 rgba(0 0 0 / 0.6); */
    background: linear-gradient(225deg, #bdc3c9 0%, #ffffff 50%, #bdc3c9 100%);
    box-shadow:
      10px 15px 22px -5px rgba(0 0 0 / 0.2),
      0 0 2px rgba(0 0 0 / 0.15);
    border-radius: 0.5rem;
    object-fit: cover;
    position: relative;
    overflow: hidden;
    /* top: 120%; */
    left: calc(50% - 160px);
    z-index: -1;
    transform-style: preserve-3d;
    transform: perspective(40px) scale(0.96, -0.96);
    /* backface-visibility: hidden; */
    pointer-events: none;
    margin-block-start: 1.5rem;
    padding: 1rem;
  }
</style>
