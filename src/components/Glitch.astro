---
import glitchImageSrc from "../assets/glitch-anime.png";
import { getImage } from "astro:assets";
const glitchImage = await getImage({ src: glitchImageSrc });
---

<div class="glitch" style={`background-image: url(${glitchImage.src})`}>
  <div class="glitch-image r"></div>
  <div class="glitch-image g"></div>
  <div class="glitch-image b"></div>
  <div class="glitch-image f"></div>
  <div class="glitch-layer" style={`background-image: url(${glitchImage.src})`}></div>
</div>

<script>
  // デバッグモード（開発環境でのみtrue）
  const DEBUG = import.meta.env.DEV;

  // ローディング終了後にグリッチアニメーションを制御
  function initGlitchAnimation() {
    const glitchImages = document.querySelectorAll(".glitch-image");
    const glitchR = document.querySelector(".glitch-image.r") as HTMLElement;
    const glitchG = document.querySelector(".glitch-image.g") as HTMLElement;
    const glitchB = document.querySelector(".glitch-image.b") as HTMLElement;
    const glitchF = document.querySelector(".glitch-image.f") as HTMLElement;

    if (!glitchImages || glitchImages.length === 0) {
      if (DEBUG) console.warn("Glitch images not found");
      return;
    }

    // 初期状態: すべてのアニメーションをnoneに設定
    glitchImages.forEach((img) => {
      (img as HTMLElement).style.animation = "none";
    });

    // ローディングスクリーンの終了を検知
    const checkLoadingComplete = () => {
      const loadingScreen = document.getElementById("loading-screen");

      if (!loadingScreen) {
        // ローディングスクリーンが存在しない場合は即座に開始
        startGlitchSequence();
        return;
      }

      const computedStyle = window.getComputedStyle(loadingScreen);
      const isVisible =
        loadingScreen.style.display !== "none" &&
        loadingScreen.style.visibility !== "hidden" &&
        computedStyle.display !== "none" &&
        computedStyle.visibility !== "hidden";

      if (isVisible) {
        // まだローディング中なので再チェック
        setTimeout(checkLoadingComplete, 100);
      } else {
        // ローディング終了後にアニメーション開始
        startGlitchSequence();
      }
    };

    // グリッチアニメーションシーケンスを開始
    const startGlitchSequence = () => {
      if (DEBUG) console.log("Starting glitch sequence...");

      // 1. glitchAnimeアニメーションを8秒間実行
      if (glitchR) glitchR.style.animation = "glitchAnime-1 1.2s linear infinite alternate";
      if (glitchG) glitchG.style.animation = "glitchAnime-2 1.4s linear infinite alternate";
      if (glitchB) glitchB.style.animation = "glitchAnime-3 1.6s linear infinite alternate";
      if (glitchF) glitchF.style.animation = "glitchAnime-4 1.8s linear infinite alternate";

      // ② glitchAnime-5を.glitch-layerに適用
      const glitchLayer = document.querySelector(".glitch-layer") as HTMLElement;
      if (glitchLayer) {
        glitchLayer.style.animation = "glitchAnime-5 2s linear infinite alternate";
      }

      // 2. 8秒後にRGBズレアニメーションを終了し、shakeアニメーションに切り替え
      setTimeout(() => {
        if (DEBUG) console.log("Switching to shake animation...");
        glitchImages.forEach((img) => {
          const element = img as HTMLElement;
          // shakeアニメーションのみに切り替え
          element.style.animation = "shake 8s ease-in-out";
        });
      }, 8000); // 8秒後

      // 3. 16秒後（shake終了後）にopacityアニメーションを発動
      setTimeout(() => {
        if (DEBUG) console.log("Starting opacity animation...");
        glitchImages.forEach((img) => {
          const element = img as HTMLElement;
          // opacityアニメーションを追加
          element.style.animation = "opacity 8s linear";
        });
      }, 16000); // 8秒 + 8秒 = 16秒後

      // 4. 24秒後（opacity開始から8秒後）に::beforeアニメーションを停止し、画像を正常表示
      setTimeout(() => {
        if (DEBUG) console.log("Stopping ::before animations and showing final image...");

        // CSSでアニメーションを停止し、エフェクトレイヤーを非表示にする
        const style = document.createElement("style");
        style.id = "glitch-before-stop"; // IDを追加
        style.textContent = `
          .glitch-image.r::before {
            animation: none !important;
            opacity: 0 !important;
            transition: opacity 3s ease-out !important;
          }
          .glitch-image.g::before {
            animation: none !important;
            opacity: 0 !important;
            transition: opacity 3s ease-out !important;
          }
          .glitch-image.b::before {
            animation: none !important;
            opacity: 0 !important;
            transition: opacity 3s ease-out !important;
          }
          .glitch-image.f::before {
            animation: none !important;
            opacity: 0 !important;
            transition: opacity 3s ease-out !important;
          }
        `;
        document.head.appendChild(style);

        // トランジションを設定してから値を変更
        if (glitchR) {
          glitchR.style.transition = "opacity 3s ease-out";
          glitchR.style.opacity = "0";
        }
        if (glitchG) {
          glitchG.style.transition = "opacity 3s ease-out";
          glitchG.style.opacity = "0";
        }
        if (glitchB) {
          glitchB.style.transition = "opacity 3s ease-out";
          glitchB.style.opacity = "0";
        }
        if (glitchF) {
          glitchF.style.transition = "opacity 3s ease-out, mix-blend-mode 0s 3s";
          glitchF.style.animation = "none";
          glitchF.style.opacity = "1";
          // 3秒後にブレンドモードを変更（トランジション完了後）
          setTimeout(() => {
            if (glitchF) glitchF.style.mixBlendMode = "normal";
          }, 3000);
        }

        // ③ glitchAnime-5を停止
        if (glitchLayer) {
          glitchLayer.style.animation = "none";
          glitchLayer.style.opacity = "0";
          glitchLayer.style.transition = "opacity 3s ease-out";
        }

        // ④ .glitchの背景色をふわっと#ffffffに変更
        const glitchContainer = document.querySelector(".glitch") as HTMLElement;
        if (glitchContainer) {
          // 背景画像とサイズを保持したまま背景色のみを変更
          const bgImage = window.getComputedStyle(glitchContainer).backgroundImage;
          glitchContainer.style.transition = "background-color 3s ease-out";
          glitchContainer.style.backgroundColor = "#ffffff";
          glitchContainer.style.backgroundImage = bgImage;
          glitchContainer.style.backgroundSize = "cover";
          glitchContainer.style.backgroundPosition = "center";
          glitchContainer.style.backgroundRepeat = "no-repeat";
        }

        // 5. 3秒後（フェードアウト完了後）に3秒待機してから背景を黒にフェード、その後ループ
        setTimeout(() => {
          if (DEBUG) console.log("Waiting 3 seconds before fading to black...");

          // 3秒待機
          setTimeout(() => {
            if (DEBUG) console.log("Fading background to black...");
            const glitchContainer = document.querySelector(".glitch") as HTMLElement;
            if (glitchContainer) {
              // 背景画像とサイズを保持したまま背景色のみを変更
              const bgImage = window.getComputedStyle(glitchContainer).backgroundImage;
              glitchContainer.style.transition = "background-color 3s ease-out";
              glitchContainer.style.backgroundColor = "#000000";
              glitchContainer.style.backgroundImage = bgImage;
              glitchContainer.style.backgroundSize = "cover";
              glitchContainer.style.backgroundPosition = "center";
              glitchContainer.style.backgroundRepeat = "no-repeat";
            }

            // 背景が黒にフェード完了後、アニメーションをリセットしてループ
            setTimeout(() => {
              if (DEBUG) console.log("Resetting and looping animation...");

              // 動的に追加されたスタイルタグを確実に削除
              const stopStyleElement = document.getElementById("glitch-before-stop");
              if (stopStyleElement) {
                stopStyleElement.remove();
                if (DEBUG) console.log("Removed stop style element");
              }

              // 親コンテナから背景画像を取得し、背景色もリセット
              const containerBgImage = window.getComputedStyle(glitchContainer).backgroundImage;
              if (DEBUG) console.log("Container background image:", containerBgImage);

              // .glitchコンテナの背景色を黒に戻す（背景画像とサイズを保持）
              if (glitchContainer) {
                // 親要素から高さを取得
                const parent = glitchContainer.parentElement;
                const parentHeight = parent ? window.getComputedStyle(parent).height : "100vh";

                glitchContainer.style.transition = "";
                glitchContainer.style.backgroundColor = "#000000";
                glitchContainer.style.backgroundImage = containerBgImage;
                glitchContainer.style.backgroundSize = "cover";
                glitchContainer.style.backgroundPosition = "center";
                glitchContainer.style.backgroundRepeat = "no-repeat";
                glitchContainer.style.height = parentHeight;
              }

              // 要素を完全に初期状態にリセット
              // glitchLayer
              if (glitchLayer) {
                glitchLayer.removeAttribute("style");
                glitchLayer.style.backgroundImage = containerBgImage;
              }

              // R, G, B, F要素のリセット（初期状態に確実に戻す）
              if (glitchR) {
                glitchR.style.backgroundImage = containerBgImage;
                glitchR.style.backgroundSize = "cover";
                glitchR.style.backgroundPosition = "center";
                glitchR.style.backgroundRepeat = "no-repeat";
                glitchR.style.position = "absolute";
                glitchR.style.top = "0";
                glitchR.style.right = "0";
                glitchR.style.bottom = "0";
                glitchR.style.left = "0";
                glitchR.style.mixBlendMode = "screen";
                glitchR.style.removeProperty("opacity");
                glitchR.style.removeProperty("transition");
                glitchR.style.removeProperty("transform");
                glitchR.style.animation = "none";
              }
              if (glitchG) {
                glitchG.style.backgroundImage = containerBgImage;
                glitchG.style.backgroundSize = "cover";
                glitchG.style.backgroundPosition = "center";
                glitchG.style.backgroundRepeat = "no-repeat";
                glitchG.style.position = "absolute";
                glitchG.style.top = "0";
                glitchG.style.right = "0";
                glitchG.style.bottom = "0";
                glitchG.style.left = "0";
                glitchG.style.mixBlendMode = "screen";
                glitchG.style.removeProperty("opacity");
                glitchG.style.removeProperty("transition");
                glitchG.style.removeProperty("transform");
                glitchG.style.animation = "none";
              }
              if (glitchB) {
                glitchB.style.backgroundImage = containerBgImage;
                glitchB.style.backgroundSize = "cover";
                glitchB.style.backgroundPosition = "center";
                glitchB.style.backgroundRepeat = "no-repeat";
                glitchB.style.position = "absolute";
                glitchB.style.top = "0";
                glitchB.style.right = "0";
                glitchB.style.bottom = "0";
                glitchB.style.left = "0";
                glitchB.style.mixBlendMode = "screen";
                glitchB.style.removeProperty("opacity");
                glitchB.style.removeProperty("transition");
                glitchB.style.removeProperty("transform");
                glitchB.style.animation = "none";
              }
              if (glitchF) {
                glitchF.style.backgroundImage = containerBgImage;
                glitchF.style.backgroundSize = "cover";
                glitchF.style.backgroundPosition = "center";
                glitchF.style.backgroundRepeat = "no-repeat";
                glitchF.style.position = "absolute";
                glitchF.style.top = "0";
                glitchF.style.right = "0";
                glitchF.style.bottom = "0";
                glitchF.style.left = "0";
                glitchF.style.mixBlendMode = "screen";
                glitchF.style.removeProperty("opacity");
                glitchF.style.removeProperty("transition");
                glitchF.style.removeProperty("transform");
                glitchF.style.animation = "none";
              }

              // デバッグ情報：要素の状態を確認
              if (DEBUG) {
                console.log("Reset complete. Elements should be visible now.");
                console.log("glitchF opacity:", window.getComputedStyle(glitchF).opacity);
                console.log("glitchF display:", window.getComputedStyle(glitchF).display);
                console.log("glitchF mix-blend-mode:", window.getComputedStyle(glitchF).mixBlendMode);
                console.log(
                  "glitchF backgroundImage:",
                  window.getComputedStyle(glitchF).backgroundImage.substring(0, 50) + "..."
                );
                console.log("glitchF backgroundSize:", window.getComputedStyle(glitchF).backgroundSize);
                console.log("glitchF position:", window.getComputedStyle(glitchF).position);
                console.log(
                  "glitchContainer backgroundColor:",
                  window.getComputedStyle(glitchContainer).backgroundColor
                );
              }

              // 少し待機してからアニメーションを再開
              setTimeout(() => {
                startGlitchSequence();
              }, 100);
            }, 3000); // 黒へのフェード完了まで3秒
          }, 3000); // 3秒待機
        }, 3000); // フェードアウト完了まで3秒
      }, 24000); // 16秒 + 8秒 = 24秒後
    };

    // チェック開始
    setTimeout(checkLoadingComplete, 100);
  }

  // DOM準備完了後に実行
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initGlitchAnimation);
  } else {
    initGlitchAnimation();
  }
</script>

<style is:global>
  .glitch {
    width: 100%;
    max-width: 640px;
    height: 100vh;
    background: #000000;
    background-position: center;
    background-repeat: no-repeat;
    background-size: cover; /* 0 から cover に変更 */
    position: relative;
    overflow: hidden;
    margin-inline: auto;
  }

  @media screen and (max-width: 480px) {
    .glitch {
      max-width: 480px;
      height: 560px;
      /* background-size: contain; */
    }
  }
  .glitch-image {
    background: inherit;
    background-size: cover;
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    mix-blend-mode: screen;
    /* アニメーションはJavaScriptで動的に制御 */
    animation: none;
  }

  @keyframes shake {
    0% {
      transform: translate3d(0, 0, 0);
    }
    25% {
      transform: translate3d(16px, 0, -16px);
      opacity: 0.8;
    }
    50% {
      /* transform: translate(16px, 0); */
      opacity: 0.5;
    }
    75% {
      /* transform: translate(-2px, 0); */
      opacity: 0.25;
    }
    100% {
      transform: translate3d(0, 0, 0);
      opacity: 0.5;
    }
  }

  .glitch-image::before {
    display: block;
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    mix-blend-mode: color-dodge;
  }
  .r::before {
    background: #ff0000;
    filter: drop-shadow(4px 4px 8px #ff0000);
    animation: glitchAnime-1 1.2s infinite linear;
  }
  .g::before {
    background: #00ff00;
    filter: drop-shadow(-4px 4px 8px #00ff00);
    animation: glitchAnime-2 1.4s infinite linear;
  }
  .b::before {
    background: #0000ff;
    filter: drop-shadow(-4px 4px 8px #0000ff);
    animation: glitchAnime-3 1.6s infinite linear;
  }

  .f::before {
    background: rgba(255, 255, 255, 0.1);
    background-blend-mode: overlay;
    animation: glitchAnime-4 1.8s infinite linear;
  }

  .glitch-layer {
    /* background: inherit; */
    background-repeat: no-repeat;
    background-position: 0 0;
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    /* mix-blend-mode: screen; */
    transform: translateX(-5%);
    /* アニメーションはJavaScriptで動的に制御 */
    animation: none;
  }

  @keyframes noise {
    0% {
      background-position: 0 0;
    }
    100% {
      background-position: 100% 100%;
    }
  }
  @keyframes opacity {
    0% {
      opacity: 0.8;
    }
    8% {
      opacity: 0.9;
    }
    24% {
      opacity: 1;
    }
    32% {
      opacity: 0.9;
    }
    48% {
      opacity: 0.8;
    }
    56% {
      opacity: 0.6;
    }
    72% {
      opacity: 0.3;
      opacity: 0.4;
    }
    88% {
      opacity: 0.6;
      opacity: 0.2;
    }
    100% {
      opacity: 0.8;
      opacity: 0.1;
    }
  }

  /* @keyframes bodyLight {
    10% {
      filter: invert(0%);
    }
    20% {
      filter: invert(0%);
    }
    30% {
      filter: invert(14%);
    }
    40% {
      filter: invert(10%);
    }
    50% {
      filter: invert(7%);
    }
    60% {
      filter: invert(10%);
    }
    70% {
      filter: invert(12%);
    }
    80% {
      filter: invert(9%);
    }
    90% {
      filter: invert(14%);
    }
    100% {
      filter: invert(11%);
    }
  } */
  @keyframes glitchAnime-1 {
    0% {
      clip-path: polygon(0 0, 100% 16%, 100% 24%, 0 40%);
      /* opacity: 1; */
      transform: translate(16px, 0);
    }
    2% {
      clip-path: polygon(0 16%, 100% 16%, 100% 16%, 0 18%);
    }
    4% {
      clip-path: polygon(0 16%, 100% 16%, 100% 24%, 0 24%);
    }

    6% {
      clip-path: polygon(0 1%, 100% 1%, 100% 4%, 0 2%);
    }

    8% {
      clip-path: polygon(0 36%, 100% 32%, 100% 32%, 0 40%);
    }

    10% {
      clip-path: polygon(0 40%, 100% 48%, 100% 56%, 0 40%);
    }

    12% {
      clip-path: polygon(0 56%, 100% 56%, 100% 32%, 0 16%);
    }

    14% {
      clip-path: polygon(0 72%, 100% 72%, 100% 72%, 0 72%);
    }

    16% {
      clip-path: polygon(0 80%, 100% 80%, 100% 80%, 0 80%);
    }

    18% {
      clip-path: polygon(0 48%, 100% 48%, 100% 56%, 0 48%);
    }

    20% {
      clip-path: polygon(0 72%, 100% 72%, 100% 72%, 0 88%);
    }

    21.9% {
      /* opacity: 1; */
      transform: translate(16px, 0);
    }

    22%,
    to {
      clip-path: polygon(0 0, 0 0, 0 0, 0 0);
      /* opacity: 0; */
      transform: translate(0, 0);
    }
  }

  @keyframes glitchAnime-2 {
    0% {
      clip-path: polygon(0 24%, 100% 24%, 100% 32%, 0 32%);
      /* opacity: 1; */
      transform: translate(8px, 0);
    }

    3% {
      clip-path: polygon(0 4%, 100% 4%, 100% 4%, 0 4%);
    }

    5% {
      clip-path: polygon(0 4%, 100% 4%, 100% 24%, 0 8%);
    }

    7% {
      clip-path: polygon(0 24%, 100% 24%, 100% 24%, 0 24%);
    }

    9% {
      clip-path: polygon(0 40%, 100% 40%, 100% 40%, 0 42%);
    }

    11% {
      clip-path: polygon(0 56%, 100% 56%, 100% 56%, 0 56%);
    }

    13% {
      clip-path: polygon(0 64%, 100% 64%, 100% 64%, 0 65%);
    }

    15% {
      clip-path: polygon(0 72%, 100% 72%, 100% 72%, 0 72%);
    }

    17% {
      clip-path: polygon(0 64%, 100% 64%, 100% 40%, 0 48%);
    }

    19% {
      clip-path: polygon(0 48%, 100% 48%, 100% 50%, 0 48%);
    }

    20% {
      clip-path: polygon(0 16%, 100% 16%, 100% 40%, 0 24%);
    }

    21.9% {
      /* opacity: 1; */
      transform: translate(8px, 0);
    }

    22%,
    to {
      clip-path: polygon(0 0, 0 0, 0 0, 0 0);
      /* opacity: 0; */
      transform: translate(0, 0);
    }
  }

  @keyframes glitchAnime-3 {
    0% {
      clip-path: polygon(0 1%, 100% 1%, 100% 4%, 0 1%);
      /* opacity: 1; */
      transform: translate(8px, 0);
    }

    1.5% {
      clip-path: polygon(0 8%, 100% 8%, 100% 10%, 0 10%);
    }

    2% {
      clip-path: polygon(0 4%, 100% 4%, 100% 4%, 0 4%);
    }

    2.5% {
      clip-path: polygon(0 24%, 100% 24%, 100% 24%, 0 26%);
    }

    3% {
      clip-path: polygon(0 16%, 100% 16%, 100% 8%, 0 8%);
    }

    5% {
      clip-path: polygon(0 32%, 100% 32%, 100% 24%, 0 24%);
    }

    5.5% {
      clip-path: polygon(0 16%, 100% 16%, 100% 16%, 0 16%);
    }

    7% {
      clip-path: polygon(0 44%, 100% 44%, 100% 40%, 0 40%);
    }

    8% {
      clip-path: polygon(0 24%, 100% 24%, 100% 25%, 0 25%);
    }

    9% {
      clip-path: polygon(0 64%, 100% 64%, 100% 56%, 0 64%);
    }

    10.5% {
      clip-path: polygon(0 32%, 100% 32%, 100% 33%, 0 33%);
    }

    11% {
      clip-path: polygon(0 72%, 100% 72%, 100% 71%, 0 71%);
    }

    13% {
      clip-path: polygon(0 44%, 100% 44%, 100% 45%, 0 45%);
    }

    14% {
      clip-path: polygon(0 88%, 100% 88%, 100% 72%, 0 80%);
    }

    14.5% {
      clip-path: polygon(0 48%, 100% 48%, 100% 49%, 0 49%);
    }

    15% {
      clip-path: polygon(0 88%, 100% 88%, 100% 88%, 0 88%);
    }

    16% {
      clip-path: polygon(0 56%, 100% 56%, 100% 56%, 0 56%);
    }

    18% {
      clip-path: polygon(0 96%, 100% 96%, 100% 95%, 0 92%);
    }

    20% {
      clip-path: polygon(0 72%, 100% 72%, 100% 73%, 0 73%);
    }

    21.9% {
      /* opacity: 1; */
      transform: translate(8px, 0);
    }

    22%,
    to {
      clip-path: polygon(0 0, 0 0, 0 0, 0 0);
      /* opacity: 0; */
      transform: translate(0, 0);
    }
  }

  @keyframes glitchAnime-4 {
    0% {
      opacity: 0.15;
      transform: translate3d(16px, 8px, 0);
    }
    4% {
      opacity: 0.2;
      transform: translate3d(16px, 8px, 0);
    }
    8% {
      opacity: 0;
    }
    to {
      opacity: 0;
    }
  }

  @keyframes glitchAnime-5 {
    0% {
      clip-path: polygon(0 0%, 100% 0%, 100% 5%, 0 5%);
    }
    10% {
      clip-path: polygon(0 15%, 100% 15%, 100% 15%, 0 15%);
    }
    20% {
      clip-path: polygon(0 10%, 100% 10%, 100% 20%, 0 20%);
    }
    30% {
      clip-path: polygon(0 1%, 100% 1%, 100% 2%, 0 2%);
    }
    40% {
      clip-path: polygon(0 35%, 100% 35%, 100% 35%, 0 35%);
    }
    50% {
      clip-path: polygon(0 45%, 100% 45%, 100% 46%, 0 46%);
    }
    60% {
      clip-path: polygon(0 50%, 100% 50%, 100% 70%, 0 70%);
    }
    70% {
      clip-path: polygon(0 70%, 100% 70%, 100% 70%, 0 70%);
    }
    80% {
      clip-path: polygon(0 80%, 100% 80%, 100% 80%, 0 80%);
    }
    90% {
      clip-path: polygon(0 50%, 100% 50%, 100% 55%, 0 55%);
    }
    100% {
      clip-path: polygon(0 60%, 100% 60%, 100% 70%, 0 70%);
    }
  }
</style>
