---
import glitchImageSrc from "../assets/glitch-anime.png";
import { getImage } from "astro:assets";
const glitchImage = await getImage({ src: glitchImageSrc });
---

<div class="glitch" style={`background-image: url(${glitchImage.src})`}>
  <div class="glitch-image r"></div>
  <div class="glitch-image g"></div>
  <div class="glitch-image b"></div>
  <div class="glitch-image f"></div>
</div>

<script>
  // ローディング終了後にグリッチアニメーションを制御
  function initGlitchAnimation() {
    const glitchImages = document.querySelectorAll(".glitch-image");
    const glitchR = document.querySelector(".glitch-image.r") as HTMLElement;
    const glitchG = document.querySelector(".glitch-image.g") as HTMLElement;
    const glitchB = document.querySelector(".glitch-image.b") as HTMLElement;
    const glitchF = document.querySelector(".glitch-image.f") as HTMLElement;

    if (!glitchImages || glitchImages.length === 0) {
      console.warn("Glitch images not found");
      return;
    }

    // 初期状態: すべてのアニメーションをnoneに設定
    glitchImages.forEach((img) => {
      (img as HTMLElement).style.animation = "none";
    });

    // ローディングスクリーンの終了を検知
    const checkLoadingComplete = () => {
      const loadingScreen = document.getElementById("loading-screen");

      if (!loadingScreen) {
        // ローディングスクリーンが存在しない場合は即座に開始
        startGlitchSequence();
        return;
      }

      const computedStyle = window.getComputedStyle(loadingScreen);
      const isVisible =
        loadingScreen.style.display !== "none" &&
        loadingScreen.style.visibility !== "hidden" &&
        computedStyle.display !== "none" &&
        computedStyle.visibility !== "hidden";

      if (isVisible) {
        // まだローディング中なので再チェック
        setTimeout(checkLoadingComplete, 100);
      } else {
        // ローディング終了後にアニメーション開始
        startGlitchSequence();
      }
    };

    // グリッチアニメーションシーケンスを開始
    const startGlitchSequence = () => {
      console.log("Starting glitch sequence...");

      // 1. glitchAnimeとopacityアニメーションを6秒間実行
      if (glitchR) glitchR.style.animation = "opacity 3s linear, glitchAnime-1 1.2s linear infinite";
      if (glitchG) glitchG.style.animation = "opacity 3s linear, glitchAnime-2 1.4s linear infinite";
      if (glitchB) glitchB.style.animation = "opacity 3s linear, glitchAnime-3 1.6s linear infinite";
      if (glitchF) glitchF.style.animation = "opacity 3s linear, glitchAnime-4 1.8s linear infinite";

      // 2. 6秒後にRGBズレアニメーションを終了し、shakeアニメーションに切り替え
      setTimeout(() => {
        console.log("Switching to shake animation...");
        glitchImages.forEach((img) => {
          const element = img as HTMLElement;
          // shakeアニメーションのみに切り替え
          element.style.animation = "shake 8s infinite ease-in-out";
        });
      }, 6000); // 6秒後
    };

    // チェック開始
    setTimeout(checkLoadingComplete, 100);
  }

  // DOM準備完了後に実行
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initGlitchAnimation);
  } else {
    initGlitchAnimation();
  }
</script>

<style is:global>
  .glitch {
    width: 100%;
    max-width: 640px;
    height: 100vh;
    background: #000000;
    background-position: center;
    background-repeat: no-repeat;
    background-size: cover; /* 0 から cover に変更 */
    position: relative;
    overflow: hidden;
    margin-inline: auto;
  }
  .glitch-image {
    background: inherit;
    background-size: cover;
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    mix-blend-mode: screen;
    /* アニメーションはJavaScriptで動的に制御 */
    animation: none;
  }

  @keyframes shake {
    0% {
      transform: translate3d(0, 0, 0);
    }
    25% {
      transform: translate3d(16px, 0, -16px);
      opacity: 0.8;
    }
    50% {
      /* transform: translate(16px, 0); */
      opacity: 0.5;
    }
    75% {
      /* transform: translate(-2px, 0); */
      opacity: 0.25;
    }
    100% {
      transform: translate3d(0, 0, 0);
      opacity: 0;
    }
  }

  .glitch-image::before {
    display: block;
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    mix-blend-mode: color-dodge;
  }
  .r::before {
    background: #ff0000;
    filter: drop-shadow(20px 4px 8px #ff0000) brightness(1.5);
    animation: glitchAnime-1 1.2s infinite linear;
  }
  .g::before {
    background: #00ff00;
    filter: drop-shadow(-20px 4px 8px #00ff00) brightness(1.5);
    animation: glitchAnime-2 1.4s infinite linear;
  }
  .b::before {
    background: #0000ff;
    filter: drop-shadow(-8px 4px 8px #0000ff) brightness(1.5);
    animation: glitchAnime-3 1.6s infinite linear;
  }

  .f::before {
    background: rgba(255, 255, 255, 0.1);
    background-blend-mode: overlay;
    animation: glitchAnime-4 1.8s infinite linear;
  }

  @keyframes noise {
    0% {
      background-position: 0 0;
    }
    100% {
      background-position: 100% 100%;
    }
  }
  @keyframes opacity {
    0% {
      opacity: 0.8;
    }
    8% {
      opacity: 0.9;
    }
    24% {
      opacity: 1;
    }
    32% {
      opacity: 0.85;
    }
    48% {
      opacity: 0.7;
    }
    56% {
      opacity: 0.5;
    }
    72% {
      opacity: 0.3;
    }
    88% {
      opacity: 0.6;
    }
    100% {
      opacity: 0.8;
    }
  }

  /* @keyframes bodyLight {
    10% {
      filter: invert(0%);
    }
    20% {
      filter: invert(0%);
    }
    30% {
      filter: invert(14%);
    }
    40% {
      filter: invert(10%);
    }
    50% {
      filter: invert(7%);
    }
    60% {
      filter: invert(10%);
    }
    70% {
      filter: invert(12%);
    }
    80% {
      filter: invert(9%);
    }
    90% {
      filter: invert(14%);
    }
    100% {
      filter: invert(11%);
    }
  } */

  /* @keyframes glitchAnime-0 {
    0% {
      clip-path: polygon(0 0, 100% 16%, 100% 24%, 0 40%);
      opacity: 1;
      transform: translate3d(16px, 0, 0);
    }
    2% {
      clip-path: polygon(0 15%, 100% 15%, 100% 15%, 0 15%);
    }
    4% {
      clip-path: polygon(0 10%, 100% 10%, 100% 20%, 0 20%);
    }

    6% {
      clip-path: polygon(0 1%, 100% 1%, 100% 2%, 0 2%);
    }

    8% {
      clip-path: polygon(0 33%, 100% 33%, 100% 33%, 0 33%);
    }

    10% {
      clip-path: polygon(0 44%, 100% 44%, 100% 44%, 0 44%);
    }

    12% {
      clip-path: polygon(0 50%, 100% 50%, 100% 20%, 0 20%);
    }

    14% {
      clip-path: polygon(0 70%, 100% 70%, 100% 70%, 0 70%);
    }

    16% {
      clip-path: polygon(0 80%, 100% 80%, 100% 80%, 0 80%);
    }

    18% {
      clip-path: polygon(0 50%, 100% 50%, 100% 55%, 0 55%);
    }

    20% {
      clip-path: polygon(0 70%, 100% 70%, 100% 80%, 0 80%);
    }

    21.9% {
      opacity: 1;
      transform: translate3d(var(--gap-horizontal), 0, 0);
    }

    22%,
    to {
      clip-path: polygon(0 0, 0 0, 0 0, 0 0);
      opacity: 0;
      transform: translateZ(0);
    }
  } */

  @keyframes glitchAnime-1 {
    0% {
      clip-path: polygon(0 0, 100% 16%, 100% 24%, 0 40%);
      opacity: 1;
      transform: translate(16px, 0);
    }
    2% {
      clip-path: polygon(0 16%, 100% 16%, 100% 16%, 0 18%);
    }
    4% {
      clip-path: polygon(0 16%, 100% 16%, 100% 24%, 0 24%);
    }

    6% {
      clip-path: polygon(0 1%, 100% 1%, 100% 4%, 0 2%);
    }

    8% {
      clip-path: polygon(0 36%, 100% 32%, 100% 32%, 0 40%);
    }

    10% {
      clip-path: polygon(0 40%, 100% 48%, 100% 56%, 0 40%);
    }

    12% {
      clip-path: polygon(0 56%, 100% 56%, 100% 32%, 0 16%);
    }

    14% {
      clip-path: polygon(0 72%, 100% 72%, 100% 72%, 0 72%);
    }

    16% {
      clip-path: polygon(0 80%, 100% 80%, 100% 80%, 0 80%);
    }

    18% {
      clip-path: polygon(0 48%, 100% 48%, 100% 56%, 0 48%);
    }

    20% {
      clip-path: polygon(0 72%, 100% 72%, 100% 72%, 0 88%);
    }

    21.9% {
      opacity: 1;
      transform: translate(16px, 0);
    }

    22%,
    to {
      clip-path: polygon(0 0, 0 0, 0 0, 0 0);
      opacity: 0;
      transform: translate(0, 0);
    }
  }

  @keyframes glitchAnime-2 {
    0% {
      clip-path: polygon(0 24%, 100% 24%, 100% 32%, 0 32%);
      opacity: 1;
      transform: translate(16px, 0);
    }

    3% {
      clip-path: polygon(0 4%, 100% 4%, 100% 4%, 0 4%);
    }

    5% {
      clip-path: polygon(0 4%, 100% 4%, 100% 24%, 0 8%);
    }

    7% {
      clip-path: polygon(0 24%, 100% 24%, 100% 24%, 0 24%);
    }

    9% {
      clip-path: polygon(0 40%, 100% 40%, 100% 40%, 0 42%);
    }

    11% {
      clip-path: polygon(0 56%, 100% 56%, 100% 56%, 0 56%);
    }

    13% {
      clip-path: polygon(0 64%, 100% 64%, 100% 64%, 0 65%);
    }

    15% {
      clip-path: polygon(0 72%, 100% 72%, 100% 72%, 0 72%);
    }

    17% {
      clip-path: polygon(0 64%, 100% 64%, 100% 40%, 0 48%);
    }

    19% {
      clip-path: polygon(0 48%, 100% 48%, 100% 50%, 0 48%);
    }

    20% {
      clip-path: polygon(0 16%, 100% 16%, 100% 40%, 0 24%);
    }

    21.9% {
      opacity: 1;
      transform: translate(8px, 0);
    }

    22%,
    to {
      clip-path: polygon(0 0, 0 0, 0 0, 0 0);
      opacity: 0;
      transform: translate(0, 0);
    }
  }

  @keyframes glitchAnime-3 {
    0% {
      clip-path: polygon(0 1%, 100% 1%, 100% 4%, 0 1%);
      opacity: 1;
      transform: translate3d(0, calc(8px * -1), 0) scale3d(-1, -1, 1);
    }

    1.5% {
      clip-path: polygon(0 8%, 100% 8%, 100% 10%, 0 10%);
    }

    2% {
      clip-path: polygon(0 4%, 100% 4%, 100% 4%, 0 4%);
    }

    2.5% {
      clip-path: polygon(0 24%, 100% 24%, 100% 24%, 0 26%);
    }

    3% {
      clip-path: polygon(0 16%, 100% 16%, 100% 8%, 0 8%);
    }

    5% {
      clip-path: polygon(0 32%, 100% 32%, 100% 24%, 0 24%);
    }

    5.5% {
      clip-path: polygon(0 16%, 100% 16%, 100% 16%, 0 16%);
    }

    7% {
      clip-path: polygon(0 44%, 100% 44%, 100% 40%, 0 40%);
    }

    8% {
      clip-path: polygon(0 24%, 100% 24%, 100% 25%, 0 25%);
    }

    9% {
      clip-path: polygon(0 64%, 100% 64%, 100% 56%, 0 64%);
    }

    10.5% {
      clip-path: polygon(0 32%, 100% 32%, 100% 33%, 0 33%);
    }

    11% {
      clip-path: polygon(0 72%, 100% 72%, 100% 71%, 0 71%);
    }

    13% {
      clip-path: polygon(0 44%, 100% 44%, 100% 45%, 0 45%);
    }

    14% {
      clip-path: polygon(0 88%, 100% 88%, 100% 72%, 0 80%);
    }

    14.5% {
      clip-path: polygon(0 48%, 100% 48%, 100% 49%, 0 49%);
    }

    15% {
      clip-path: polygon(0 88%, 100% 88%, 100% 88%, 0 88%);
    }

    16% {
      clip-path: polygon(0 56%, 100% 56%, 100% 56%, 0 56%);
    }

    18% {
      clip-path: polygon(0 96%, 100% 96%, 100% 95%, 0 92%);
    }

    20% {
      clip-path: polygon(0 72%, 100% 72%, 100% 73%, 0 73%);
    }

    21.9% {
      opacity: 1;
      transform: translate3d(0, calc(var(8px * -1), 0)) scale3d(-1, -1, 1);
    }

    22%,
    to {
      clip-path: polygon(0 0, 0 0, 0 0, 0 0);
      opacity: 0;
      transform: translateZ(0);
    }
  }

  @keyframes glitchAnime-4 {
    0% {
      opacity: 0.15;
      transform: translate3d(16px, 8px, 0);
    }
    4% {
      opacity: 0.2;
      transform: translate3d(16px, 8px, 0);
    }
    8% {
      opacity: 0;
    }
    to {
      opacity: 0;
    }
  }
</style>
