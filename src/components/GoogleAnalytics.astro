---
/**
 * Google Analytics 4 (GA4) トラッキングコンポーネント
 *
 * 使用方法:
 * 1. .env ファイルに PUBLIC_GA_MEASUREMENT_ID を設定
 * 2. このコンポーネントを HeadLayout.astro の <head> 内に配置
 *
 * 機能:
 * - 開発環境では Google Analytics を無効化（デバッグログを出力）
 * - 本番環境でのみ GA4 を有効化
 * - Consent Mode v2 対応（プライバシー保護）
 * - Performance と SEO への影響を最小化
 * - requestIdleCallback を使用した遅延読み込み（PageSpeed Insights 最適化）
 */

const GA_MEASUREMENT_ID: string | undefined =
  typeof import.meta.env.PUBLIC_GA_MEASUREMENT_ID === "string"
    ? import.meta.env.PUBLIC_GA_MEASUREMENT_ID
    : undefined;
const isDev: boolean = typeof import.meta.env.DEV === "boolean" ? import.meta.env.DEV : false;

// 開発環境またはMeasurement IDが未設定の場合は何も出力しない
const shouldLoadGA: boolean =
  !isDev &&
  typeof GA_MEASUREMENT_ID === "string" &&
  GA_MEASUREMENT_ID !== "" &&
  GA_MEASUREMENT_ID !== "G-XXXXXXXXXX";
---

{shouldLoadGA && typeof GA_MEASUREMENT_ID === "string" && (
  <script is:inline define:vars={{ GA_MEASUREMENT_ID: GA_MEASUREMENT_ID }}>
    // Consent Mode v2: GDPR対応のため、ユーザーの同意前はデフォルトで拒否設定
    // 必要に応じて Cookie 同意バナーと連携してください
    // Consent Mode v2 のデフォルト設定（初期化のみ、スクリプト読み込みは遅延）
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }

    // デフォルトで全ての同意を拒否（GDPR対応）
    gtag("consent", "default", {
      ad_storage: "denied",
      ad_user_data: "denied",
      ad_personalization: "denied",
      analytics_storage: "denied",
      functionality_storage: "denied",
      personalization_storage: "denied",
      security_storage: "granted", // セキュリティは常に許可
      wait_for_update: 500,
    });

    // 日本国内向けの場合は analytics_storage を自動許可（オプション）
    // プライバシーポリシーに応じて調整してください
    gtag("consent", "update", {
      analytics_storage: "granted",
    });

    // Google Analytics の遅延読み込み
    // requestIdleCallback を使用してブラウザがアイドル状態の時に読み込む
    // これにより初期ページロードのパフォーマンスへの影響を最小化
    function loadGoogleAnalytics() {
      // gtag.js スクリプトの読み込み
      const script = document.createElement("script");
      script.async = true;
      script.src = `https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`;
      document.head.appendChild(script);

      // GA4 設定スクリプト
      script.onload = function () {
        window.dataLayer = window.dataLayer || [];
        function gtag() {
          dataLayer.push(arguments);
        }
        gtag("js", new Date());

        // GA4 設定
        gtag("config", GA_MEASUREMENT_ID, {
          // ページビューの自動送信
          send_page_view: true,
          // IPアドレスの匿名化（プライバシー保護）
          anonymize_ip: true,
          // デバッグモードの無効化
          debug_mode: false,
        });
      };
    }

    // requestIdleCallback がサポートされている場合は使用
    // サポートされていない場合は setTimeout でフォールバック（3秒後）
    if (typeof window.requestIdleCallback === "function") {
      window.requestIdleCallback(
        function () {
          loadGoogleAnalytics();
        },
        { timeout: 3000 } // 最大3秒待機
      );
    } else {
      // requestIdleCallback がサポートされていない場合のフォールバック
      setTimeout(function () {
        loadGoogleAnalytics();
      }, 3000);
    }
  </script>
)}

{typeof isDev === "boolean" && isDev && !shouldLoadGA && (
  <script is:inline>
    console.info(
      "%c[Google Analytics] 開発環境のため無効化されています",
      "color: #4CAF50; font-weight: bold;"
    );
    // 開発環境用のモックgtag関数（エラー防止）
    window.dataLayer = window.dataLayer || [];
    window.gtag =
      window.gtag ||
      function () {
        console.log("[GA Mock]", ...arguments);
      };
  </script>
)}

{typeof isDev === "boolean" && !isDev && !shouldLoadGA && (
  <script is:inline>
    console.warn(
      "%c[Google Analytics] PUBLIC_GA_MEASUREMENT_ID が設定されていません",
      "color: #FF9800; font-weight: bold;"
    );
  </script>
)}
