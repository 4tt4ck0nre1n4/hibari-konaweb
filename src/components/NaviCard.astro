---
interface MenuItem {
  href: string;
  ariaLabel: string;
  ariaTitle: string;
  menuItem: string;
}

const menuItems: MenuItem[] = [
  { href: "/", ariaLabel: "ホーム", ariaTitle: "ホーム", menuItem: "Home" },
  { href: "/about", ariaLabel: "アバウト", ariaTitle: "アバウト", menuItem: "About" },
  { href: "/works", ariaLabel: "ワークス", ariaTitle: "ワークス", menuItem: "Works" },
  { href: "/blog", ariaLabel: "ブログ", ariaTitle: "ブログ", menuItem: "Blog" },
  { href: "/contact", ariaLabel: "お問い合わせ", ariaTitle: "お問い合わせ", menuItem: "Contact" },
];
---

<div class="navi-card__wrapper">
  <button
    class="navi-card__button is-open"
    type="button"
    aria-label="メニューを閉じる"
    aria-expanded="true"
    aria-controls="navi-card__menu"
  >
    <span class="navi-card__button_text">Navigation Menu</span>
  </button>
  <div class="navi-card__overlay">
    <ul id="navi-card__menu" class="navi-card__menu is-open" aria-hidden="false">
      {
        menuItems.map((item, index) => (
          <li class="navi-card__menu_item is-open" data-index={index}>
            <a class="navi-card__menu_link" href={item.href} aria-label={item.ariaLabel} title={item.ariaTitle}>
              <span class="navi-card__menu_text" data-index={index}>
                {item.menuItem}
              </span>
            </a>
          </li>
        ))
      }
    </ul>
  </div>
</div>

<style is:global>
  .navi-card__wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    pointer-events: none !important;
    z-index: 99999;
  }

  .navi-card__wrapper > * {
    pointer-events: auto; /* 子要素はクリック可能 */
  }

  @property --angle {
    syntax: "<angle>";
    inherits: false;
    initial-value: 0deg;
  }

  .navi-card__button {
    width: 200px;
    height: 90px;
    display: flex;
    align-items: center;
    justify-content: center;
    /* position: relative; */
    overflow: hidden;
    /* 洗練されたグラデーション背景 - カードと調和 */
    background-image: conic-gradient(
      from var(--angle),
      var(--color-white),
      rgb(147 51 234 / 0.7),
      rgb(255 255 255 / 0),
      rgb(147 51 234 / 0.7)
    );
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-radius: 1.25rem;
    border: 2px solid rgb(255 255 255 / 0.3);
    box-shadow:
      0 8px 32px rgb(147 51 234 / 0.5),
      inset 0 0 1px rgb(255 255 255 / 0.1),
      0 0 40px rgb(147 51 234 / 0.4),
      0 4px 16px rgb(0 0 0 / 0.3);
    position: absolute;
    top: 88px;
    left: 160px;
    z-index: 10000;
    pointer-events: auto;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    animation:
      naviCardButtonAnimation 6s ease-in-out infinite,
      naviCardButtonGradientAnimation 3s linear infinite;
    /* タッチデバイスでのアニメーション継続を保証 */
    animation-play-state: running;
    will-change: transform, --angle;
  }

  @keyframes naviCardButtonAnimation {
    0%,
    100% {
      transform: translateY(0) scale(1);
    }
    50% {
      transform: translateY(-8px) scale(1.02);
    }
  }

  @keyframes naviCardButtonGradientAnimation {
    from {
      --angle: 0deg;
    }
    to {
      --angle: 360deg;
    }
  }
  .navi-card__button::before {
    content: "";
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgb(255 255 255 / 0.1) 30%, transparent 40%, rgb(255 255 255 / 0.1) 30%);
    border-radius: 10%;
    position: absolute;
    top: 0%;
    left: 0%;
    opacity: 0;
    transition: opacity 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    animation: buttonShine 10s ease-in-out infinite;
  }

  @keyframes buttonShine {
    0%,
    100% {
      opacity: 0.3;
      transform: scale(0.7);
    }
    50% {
      opacity: 0.9;
      transform: scale(1.5);
    }
  }

  .navi-card__button:is(:hover, :focus-visible) {
    background: linear-gradient(
      0 0 48px rgb(147 51 234 / 0.7) 25%,
      0 0 0 10px rgb(255 255 255 / 0.4) inset 25%,
      0 0 60px rgb(147 51 234 / 0.6) 25%,
      0 8px 24px rgb(0 0 0 / 0.4) 25%
    );
    border: 2px solid rgb(255 255 255 / 0.5);

    box-shadow:
      0 8px 24px rgb(0 0 0 / 0.4),
      inset 0 0px 10px rgb(147 51 234 / 0.7);
    transform: translateY(-4px) scale(0.9);
  }

  .navi-card__button:is(:hover, :focus-visible)::before {
    opacity: 0.7;
  }

  .navi-card__button:active {
    transform: translateY(-2px) scale(1.02);
    box-shadow:
      0 6px 24px rgb(147 51 234 / 0.6),
      0 0 0 1px rgb(255 255 255 / 0.3) inset,
      0 0 40px rgb(147 51 234 / 0.5),
      0 8px 24px rgb(0 0 0 / 0.4);
    /* アクティブ状態でもアニメーションを継続 */
    animation-play-state: running;
  }

  .navi-card__button.is-open {
    background: conic-gradient(
      from var(--angle),
      rgb(147 51 234 / 0.7),
      var(--color-white),
      rgb(255 255 255 / 0),
      var(--color-white),
      rgb(147 51 234 / 0.7)
    );
    box-shadow:
      0 8px 32px rgb(147 51 234 / 0.6),
      0 0 0 1px rgb(255 255 255 / 0.2) inset,
      0 0 50px rgb(147 51 234 / 0.5),
      0 4px 16px rgb(0 0 0 / 0.3);
    border: 2px solid rgb(255 255 255 / 0.4);
  }

  .navi-card__button_text {
    font-family: "Marcellus", serif;
    font-size: 1.125rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    color: var(--color-white);
    text-shadow:
      0 2px 8px rgb(0 0 0 / 0.4),
      0 0 12px rgb(255 255 255 / 0.3),
      0 0 20px rgb(147 51 234 / 0.5);
    text-transform: uppercase;
    transition: all 0.3s ease;
  }

  .navi-card__button:is(:hover, :focus-visible) .navi-card__button_text {
    transform: scale(1.05);
  }

  .navi-card__button:active .navi-card__button_text {
    transform: scale(1.05);
  }

  .navi-card__overlay {
    width: 100vw;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    align-items: flex-end;
    position: fixed;
    top: 0;
    left: 0;
    padding-block-end: 28vh;
  }

  .navi-card__menu {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    column-gap: 2rem;
    transform-style: preserve-3d;
    perspective: 1600px;
  }

  .navi-card__menu.is-open {
    opacity: 1;
  }

  .navi-card__menu_item {
    width: 120px;
    height: 180px;
    display: flex;
    justify-content: center;
    align-items: center;
    /* ガラスモーフィズム風のデザイン - 暗い背景に合わせた半透明 */
    background: linear-gradient(135deg, rgb(255 255 255 / 0.15) 0%, rgb(255 255 255 / 0.05) 100%);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: 1rem;
    overflow: visible;
    border: 2px solid rgb(255 255 255 / 0.2);
    transform-style: preserve-3d;
    backface-visibility: hidden;
    will-change: transform, opacity;
    opacity: 1;
    transform: translateY(0);
    transition:
      transform 1s cubic-bezier(0.25, 0.46, 0.45, 0.94),
      opacity 1s cubic-bezier(0.25, 0.94, 0.25, 0.94),
      box-shadow 0.3s ease,
      background 0.4s cubic-bezier(0.25, 0.94, 0.25, 0.94);
    cursor: pointer;
    padding-block: 1rem;
    padding-inline: 0.5rem;
  }

  .navi-card__menu_item.is-open {
    opacity: 1;
    pointer-events: auto;
    cursor: pointer;
    transition:
      transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94),
      opacity 0.8s cubic-bezier(0.25, 0.94, 0.25, 0.94),
      box-shadow 0.4s cubic-bezier(0.25, 0.94, 0.25, 0.94),
      background 0.4s cubic-bezier(0.24, 0.98, 0.24, 0.98);
  }

  /* 閉じる時のアニメーションを確実に適用 */
  .navi-card__menu_item:not(.is-open) {
    opacity: 0;
    transition:
      transform 0.8s cubic-bezier(0.24, 0.98, 0.24, 0.99),
      opacity 0.8s cubic-bezier(0.46, 0.03, 0.52, 0.96),
      box-shadow 0.4s cubic-bezier(0.24, 0.98, 0.24, 0.98),
      background 0.4s cubic-bezier(0.24, 0.98, 0.24, 0.98);
  }

  /* 各カードの開いた状態 */
  .navi-card__menu_item[data-index="0"].is-open {
    background: linear-gradient(135deg, rgb(255 255 255 / 0.05) 0%, rgb(255 255 255 / 0.1) 100%) !important;
    box-shadow: 0 8px 16px rgb(255 255 255 / 0.6);
    pointer-events: auto;
    animation: cardFloat 10s ease-in-out infinite;
    animation-delay: 0s;
    transition: box-shadow 0.4s cubic-bezier(0.24, 0.98, 0.24, 0.98);
  }

  .navi-card__menu_item[data-index="1"].is-open {
    background: linear-gradient(135deg, rgb(144 238 144 / 0.2) 0%, rgb(152 251 152 / 0.1) 100%) !important;
    box-shadow: 0 8px 16px rgb(144 238 144 / 0.6);
    pointer-events: auto;
    animation: cardFloat 10s ease-in-out infinite;
    animation-delay: 0.4s;
    transition: box-shadow 0.4s cubic-bezier(0.24, 0.98, 0.24, 0.98);
  }

  .navi-card__menu_item[data-index="2"].is-open {
    background: linear-gradient(135deg, rgb(147 112 219 / 0.25) 0%, rgb(186 85 211 / 0.15) 100%) !important;
    box-shadow: 0 8px 16px rgb(147 51 234 / 0.6);
    pointer-events: auto;
    animation: cardFloat 10s ease-in-out infinite;
    animation-delay: 0.8s;
    transition: box-shadow 0.4s cubic-bezier(0.24, 0.98, 0.24, 0.98);
  }

  .navi-card__menu_item[data-index="3"].is-open {
    background: linear-gradient(135deg, rgb(255 255 153 / 0.2) 0%, rgb(255 255 182 / 0.1) 100%) !important;
    box-shadow: 0 8px 16px rgb(255 255 153 / 0.6);
    pointer-events: auto;
    animation: cardFloat 10s ease-in-out infinite;
    animation-delay: 1.2s;
    transition: box-shadow 0.4s cubic-bezier(0.24, 0.98, 0.24, 0.98);
  }

  .navi-card__menu_item[data-index="4"].is-open {
    background: linear-gradient(135deg, rgb(255 182 193 / 0.2) 0%, rgb(255 192 203 / 0.1) 100%) !important;
    box-shadow: 0 8px 16px rgb(255 182 193 / 0.6);
    pointer-events: auto;
    animation: cardFloat 10s ease-in-out infinite;
    animation-delay: 1.6s;
    transition: box-shadow 0.4s cubic-bezier(0.24, 0.98, 0.24, 0.98);
  }

  /* カードの上下揺れアニメーション */
  @keyframes cardFloat {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(16px);
    }
  }

  .navi-card__menu_item[data-index="0"].is-open:is(:hover, :focus-visible) {
    box-shadow: 0 0 8px rgb(255 255 255 / 0.8);
    filter: brightness(1.2);
  }

  .navi-card__menu_item[data-index="1"].is-open:is(:hover, :focus-visible) {
    box-shadow: 0 0 8px rgb(144 238 144 / 0.8);
    filter: brightness(1.2);
  }

  .navi-card__menu_item[data-index="2"].is-open:is(:hover, :focus-visible) {
    box-shadow: 0 16px 24px rgb(147 51 234 / 0.8);
    filter: brightness(1.2);
  }

  .navi-card__menu_item[data-index="3"].is-open:is(:hover, :focus-visible) {
    box-shadow: 0 0 8px rgb(255 255 153 / 0.8);
    filter: brightness(1.2);
  }

  .navi-card__menu_item[data-index="4"].is-open:is(:hover, :focus-visible) {
    box-shadow: 0 0 8px rgb(255 182 193 / 0.8);
    filter: brightness(1.2);
  }

  .navi-card__menu_link {
    display: block;
    width: 100%;
    height: 100%;
    border-radius: 10%;
    position: relative;
    z-index: 100001 !important;
    overflow: visible;
    pointer-events: auto !important;
    cursor: pointer !important;
    transition: all 0.6s cubic-bezier(0.25, 0.94, 0.25, 0.94);
  }

  .navi-card__menu_item[data-index="0"]:is(:hover, :focus-visible) .navi-card__menu_link {
    box-shadow: 0 8px 16px rgb(255 255 255 / 0.8);
  }

  .navi-card__menu_item[data-index="1"]:is(:hover, :focus-visible) .navi-card__menu_link {
    box-shadow: 0 8px 16px rgb(144 238 144 / 0.8);
  }

  .navi-card__menu_item[data-index="2"]:is(:hover, :focus-visible) .navi-card__menu_link {
    box-shadow: 0 8px 16px rgb(147 112 219 / 0.8);
  }
  .navi-card__menu_item[data-index="3"]:is(:hover, :focus-visible) .navi-card__menu_link {
    box-shadow: 0 8px 16px rgb(255 255 153 / 0.8);
  }

  .navi-card__menu_item[data-index="4"]:is(:hover, :focus-visible) .navi-card__menu_link {
    box-shadow: 0 8px 16px rgb(255 182 193 / 0.8);
  }

  .navi-card__menu_text {
    font-family: "Marcellus", serif;
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--color-white);
    text-shadow:
      0 2px 8px rgb(0 0 0 / 0.5),
      0 0 10px rgb(147 51 234 / 0.5),
      0 0 20px rgb(147 51 234 / 0.3);
    pointer-events: none !important;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .navi-card__menu_link:is(:hover, :focus-visible) .navi-card__menu_text {
    color: #e9d5ff;
    transform: translate(-50%, -50%) scale(1.15);
    text-shadow:
      0 2px 12px rgb(0 0 0 / 0.6),
      0 0 15px rgb(147 51 234 / 0.7),
      0 0 30px rgb(147 51 234 / 0.5);
  }

  html.dark .navi-card__menu_item {
    background: linear-gradient(135deg, rgb(255 255 255 / 0.15) 0%, rgb(255 255 255 / 0.05) 100%);
    border-color: rgb(255 255 255 / 0.2);
  }

  html.dark .navi-card__menu_text {
    color: var(--color-white);
    text-shadow:
      0 2px 8px rgb(0 0 0 / 0.5),
      0 0 10px rgb(168 85 247 / 0.5),
      0 0 20px rgb(168 85 247 / 0.3);
  }

  html.dark .navi-card__menu_link:is(:hover, :focus-visible) .navi-card__menu_text {
    color: var(--color-white);
    text-shadow:
      0 2px 12px rgb(0 0 0 / 0.8),
      0 0 15px rgb(168 85 247 / 0.7),
      0 0 30px rgb(168 85 247 / 0.5);
  }

  /* レスポンシブ対応 */
  @media (width <= 1024px) {
    .navi-card__button {
      top: 88px;
      left: 50%;
      transform: translateX(-50%);
    }

    @keyframes naviCardButtonAnimation {
      0%,
      100% {
        transform: translateX(-50%) translateY(0) scale(1);
      }
      50% {
        transform: translateX(-50%) translateY(-8px) scale(1.02);
      }
    }

    .navi-card__button:is(:hover, :focus-visible) {
      transform: translateX(-50%) translateY(-4px) scale(0.9);
    }

    .navi-card__button:active {
      transform: translateX(-50%) translateY(-2px) scale(1.02);
    }
  }

  @media (width <= 768px) {
    .navi-card__button {
      /* スマホサイズでもアニメーションを確実に動作させる */
      animation-play-state: running;
    }

    .navi-card__button:is(:hover, :focus-visible) {
      animation-play-state: running;
    }

    .navi-card__button:active {
      /* アクティブ状態でもアニメーションを継続 */
      animation-play-state: running;
    }

    .navi-card__button_text {
      font-size: 1rem;
    }

    .navi-card__menu {
      perspective: 1200px;
      column-gap: 1rem;
    }

    .navi-card__menu_item {
      width: 90px;
      height: 140px;
    }

    /* モバイル版 - 3D扇形配置 */
    .navi-card__menu_item[data-index="0"].is-open {
    }

    .navi-card__menu_item[data-index="1"].is-open {
    }

    .navi-card__menu_item[data-index="2"].is-open {
    }

    .navi-card__menu_item[data-index="3"].is-open {
    }

    .navi-card__menu_item[data-index="4"].is-open {
    }

    .navi-card__menu_text {
      font-size: 1.125rem;
    }
  }

  @media (width <= 480px) {
    .navi-card__button {
      height: 80px;
      /* 小画面サイズでもアニメーションを確実に動作させる */
      animation-play-state: running;
    }

    .navi-card__button:is(:hover, :focus-visible) {
      animation-play-state: running;
    }

    .navi-card__button:active {
      /* アクティブ状態でもアニメーションを継続 */
      animation-play-state: running;
    }

    .navi-card__button_text {
      font-size: 0.875rem;
    }

    .navi-card__menu {
      perspective: 1000px;
      column-gap: 0.5rem;
      grid-template-columns: repeat(5, 1fr);
    }

    .navi-card__menu_item {
      width: 72px;
      height: 120px;
    }

    /* 小画面版 - 3D配置 */
    .navi-card__menu_item[data-index="0"].is-open {
    }

    .navi-card__menu_item[data-index="1"].is-open {
    }

    .navi-card__menu_item[data-index="2"].is-open {
    }

    .navi-card__menu_item[data-index="3"].is-open {
    }

    .navi-card__menu_item[data-index="4"].is-open {
    }

    .navi-card__menu_text {
      font-size: 0.875rem;
    }
  }
</style>

<script>
  function initNaviCard() {
    const button = document.querySelector(".navi-card__button") as HTMLButtonElement;
    const menu = document.querySelector(".navi-card__menu") as HTMLUListElement;
    const menuItems = document.querySelectorAll(".navi-card__menu_item") as NodeListOf<HTMLLIElement>;
    const glitchContainer = document.querySelector(".glitch-container") as HTMLElement;

    if (!button || !menu || !menuItems.length) {
      console.error("NaviCard: Required elements not found!");
      return;
    }

    // 初期状態は開いている（カードが表示されている）
    let isOpen = true;

    // タッチイベント後にアニメーションを確実に再開する処理
    const ensureAnimationRunning = () => {
      // アニメーションを強制的に再開
      button.style.animationPlayState = "running";
      // 少し遅延させて確実に再開
      requestAnimationFrame(() => {
        button.style.animationPlayState = "running";
      });
    };

    // タッチイベントの処理（スマホ対応）
    button.addEventListener(
      "touchend",
      () => {
        // タッチ終了後にアニメーションを確実に再開
        ensureAnimationRunning();
      },
      { passive: true }
    );

    button.addEventListener("click", () => {
      isOpen = !isOpen;

      // ARIA属性の更新
      button.setAttribute("aria-expanded", String(isOpen));
      button.setAttribute("aria-label", isOpen ? "メニューを閉じる" : "メニューを開く");
      menu.setAttribute("aria-hidden", String(!isOpen));

      // クラスの切り替え
      button.classList.toggle("is-open", isOpen);
      menu.classList.toggle("is-open", isOpen);

      // クリック後にもアニメーションを確実に再開
      ensureAnimationRunning();

      // main要素内のglitch-container以外の要素のpointer-eventsを制御
      // ただし、カード要素とボタン要素は除外
      const main = document.querySelector("main") as HTMLElement;
      if (main && isOpen) {
        // main要素内の直接の子要素のみを制御（再帰的にはしない）
        const mainChildren = Array.from(main.children) as HTMLElement[];
        mainChildren.forEach((child) => {
          // glitch-containerは除外
          if (!child.classList.contains("glitch-container") && !child.querySelector(".glitch-container")) {
            child.style.pointerEvents = "none";
          }
        });
      } else if (main && !isOpen) {
        // メニューが閉じている時は、すべての要素のpointer-eventsをリセット
        const mainChildren = Array.from(main.children) as HTMLElement[];
        mainChildren.forEach((child) => {
          child.style.pointerEvents = "";
        });
      }

      // glitch-containerとその子要素のpointer-eventsとz-indexを制御
      // 画像は表示し続けるが、pointer-eventsをnoneにしてカードのクリックを可能にする
      if (glitchContainer) {
        // glitch-container自体のpointer-eventsを制御
        glitchContainer.style.pointerEvents = "none"; // 常にnone（元々none）

        // .glitch要素を取得
        const glitchElement = glitchContainer.querySelector(".glitch") as HTMLElement;
        if (glitchElement) {
          // .glitch要素のz-indexを0に設定（カードより後ろに配置）
          glitchElement.style.setProperty("z-index", "0", "important");
        }

        // glitch-containerの子要素のpointer-eventsとz-indexを制御
        // NaviCardとGlitchコンポーネントを区別
        const glitchChildren = glitchContainer.querySelectorAll("*") as NodeListOf<HTMLElement>;
        glitchChildren.forEach((child) => {
          // NaviCardコンポーネント（navi-card__wrapper）は除外
          const isNaviCard = child.classList.contains("navi-card__wrapper") || child.closest(".navi-card__wrapper");
          if (!isNaviCard) {
            // メニューが開いている時はpointer-eventsをnoneにする（画像は表示し続ける）
            child.style.pointerEvents = isOpen ? "none" : "auto";
            // z-indexを明示的に設定してカードより後ろに配置
            if (child.classList.contains("glitch") || child.closest(".glitch")) {
              child.style.setProperty("z-index", "0", "important");
            } else {
              child.style.setProperty("z-index", "0", "important");
            }
          }
        });
      }

      // 各アイテムのアニメーション
      if (isOpen) {
        // 1枚ずつ時間差で表示（よりゆっくり、ふわっと）
        menuItems.forEach((item, index) => {
          setTimeout(() => {
            item.classList.add("is-open");
            // CSSのtransitionを待たずに、JavaScriptで直接opacityを強制設定
            (item as HTMLElement).style.setProperty("opacity", "1", "important");
          }, index * 600);
        });
      } else {
        // 閉じる時もゆっくり消えるように
        menuItems.forEach((item, index) => {
          const delay = (menuItems.length - index - 1) * 0.2; // 0.08s → 0.2s に延長
          item.style.transitionDelay = `${delay}s`;
          item.classList.remove("is-open");
          // transition完了後にopacityを0に設定（念のため）
          setTimeout(
            () => {
              (item as HTMLElement).style.setProperty("opacity", "0", "important");
              item.style.transitionDelay = "";
            },
            (delay + 1.5) * 1000
          ); // transition時間(1.5s) + delay 後にリセット
        });
      }
    });

    // メニュー外クリックで閉じる（カードとボタンは除外）
    // バブリングフェーズで処理（カードのキャプチャより後）
    document.addEventListener(
      "click",
      (e) => {
        // カードクリックイベントで既に処理済み（defaultPrevented またはカスタムプロパティ）の場合は何もしない
        if ((e as any).__naviCardHandled || e.defaultPrevented) {
          return;
        }

        const target = e.target as HTMLElement;

        // カードまたはその子要素をクリックした場合は閉じない
        // より広範囲にチェック（カードの全子孫要素を含む）
        const clickedCard = target.closest(".navi-card__menu_item");
        const clickedButton = button.contains(target) || target.closest(".navi-card__button");
        const clickedMenu = target.closest(".navi-card__menu");
        const clickedLink = target.closest(".navi-card__menu_link");
        const clickedText = target.closest(".navi-card__menu_text");
        const clickedWrapper = target.closest(".navi-card__wrapper");

        // カードの実際のクリック位置を確認（リンク要素の拡大領域も考慮）
        let isWithinCardArea = false;
        const allCards = document.querySelectorAll(".navi-card__menu_item");
        const clickX = (e as MouseEvent).clientX;
        const clickY = (e as MouseEvent).clientY;

        // 強制リフローを避けるため、バッチ処理でgetBoundingClientRectを実行
        // クリックイベント内では既にレイアウトが確定しているため、直接呼び出しでも問題は少ないが、
        // パフォーマンス最適化のため、一度に全ての読み取りを実行（レイアウトスラッシングを避ける）
        const linkRects: Array<{ left: number; right: number; top: number; bottom: number }> = [];
        allCards.forEach((card) => {
          if (card.classList.contains("is-open")) {
            const link = card.querySelector(".navi-card__menu_link") as HTMLElement;
            if (link) {
              // 読み取りを一度に実行（レイアウトスラッシングを避ける）
              const linkRect = link.getBoundingClientRect();
              linkRects.push({
                left: linkRect.left,
                right: linkRect.right,
                top: linkRect.top,
                bottom: linkRect.bottom,
              });
            }
          }
        });

        // 読み取り後に判定を実行（書き込みと読み取りを分離）
        linkRects.forEach((linkRect) => {
          if (
            clickX >= linkRect.left &&
            clickX <= linkRect.right &&
            clickY >= linkRect.top &&
            clickY <= linkRect.bottom
          ) {
            isWithinCardArea = true;
          }
        });

        // カード関連の要素、ボタン、メニュー、またはカード領域内をクリックした場合は閉じない
        if (
          isOpen &&
          (clickedCard ||
            clickedLink ||
            clickedText ||
            clickedButton ||
            clickedMenu ||
            clickedWrapper ||
            isWithinCardArea)
        ) {
          return;
        }

        // メニュー外クリックの場合のみ閉じる
        if (isOpen) {
          button.click();
        }
      },
      false
    ); // バブリングフェーズで処理
  }

  // 初期化
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initNaviCard);
  } else {
    initNaviCard();
  }

  // View Transitions対応: ページ遷移時に再初期化
  document.addEventListener("astro:after-swap", () => {
    initNaviCard();
  });
</script>
