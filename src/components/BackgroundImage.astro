---
import { Icon } from "astro-icon/components";

const offBackgroundIcon = "fluent-emoji-high-contrast:mobile-phone-with-arrow";
const onBackgroundIcon = "fluent-emoji:mobile-phone";
---

<button
  id="toggleBackgroundButton"
  type="button"
  aria-label="背景色を切り替える（背景色あり）"
  title="背景色を切り替える（背景色あり）"
>
  <Icon
    class="offBackgroundIcon background-visible"
    name={offBackgroundIcon}
    width="50"
    height="50"
    aria-hidden="true"
    role="presentation"
  />
  <Icon
    class="onBackgroundIcon background-hidden"
    name={onBackgroundIcon}
    width="50"
    height="50"
    aria-hidden="true"
    role="presentation"
  />
</button>
<p id="ariaLiveStatus__background" class="screenReader-only" role="status" aria-live="polite"></p>

<!-- 開発環境フラグを設定（ビルド時に置換される） -->
<script is:inline define:vars={{ isDev: import.meta.env.DEV }}>
  // @ts-nocheck
  // 開発環境判定（Astroのビルド時に置換される）
  // window.__DEV__ が既に設定されている場合は上書きしない
  if (typeof window.__DEV__ === "undefined") {
    window.__DEV__ = isDev;
  }
</script>

<script>
  // @ts-nocheck
  // 開発環境でのみログを出力する関数（重複宣言を防ぐため、既存チェック）
  if (typeof window.devLog === "undefined") {
    window.devLog = (...args) => {
      if (window.__DEV__) {
        console.log(...args);
      }
    };
  }
  if (typeof window.devError === "undefined") {
    window.devError = (...args) => {
      // エラーは常に出力（本番環境でも必要）
      console.error(...args);
    };
  }
  const devLog = window.devLog;
  const devError = window.devError;

  // 即座に実行（DOMContentLoadedを待たない）
  (() => {
    const initBackgroundToggle = () => {
      const mainBackground = document.getElementById("main-background");
      const backgroundButton = document.getElementById("toggleBackgroundButton");
      const ariaLiveStatus = document.getElementById("ariaLiveStatus__background");

      // 要素が存在しない場合は静かに終了（エラーを出力しない）
      if (!mainBackground || !backgroundButton || !ariaLiveStatus) {
        return;
      }

      // ボタン内のアイコンだけを取得
      const offIcon = backgroundButton.querySelector(".offBackgroundIcon");
      const onIcon = backgroundButton.querySelector(".onBackgroundIcon");

      // アイコンが存在しない場合は静かに終了（エラーを出力しない）
      if (!offIcon || !onIcon) {
        return;
      }

      let isImageOff = false;
      let ariaLabel = "背景画像を切り替える（背景画像あり）";
      let title = "背景画像を切り替える（背景画像あり）";

      const updateAccessibility = () => {
        backgroundButton.setAttribute("aria-label", ariaLabel);
        backgroundButton.setAttribute("title", title);
      };

      const updateIcons = () => {
        if (isImageOff) {
          offIcon.classList.replace("background-visible", "background-hidden");
          onIcon.classList.replace("background-hidden", "background-visible");
        } else {
          onIcon.classList.replace("background-visible", "background-hidden");
          offIcon.classList.replace("background-hidden", "background-visible");
        }
      };

      updateIcons();

      backgroundButton.addEventListener("click", () => {
        devLog("BackgroundImage: ボタンがクリックされました");
        devLog("mainBackground before toggle:", mainBackground.className);

        isImageOff = mainBackground.classList.toggle("is-notImage");

        devLog("mainBackground after toggle:", mainBackground.className);
        devLog("isImageOff:", isImageOff);

        if (isImageOff) {
          ariaLabel = "背景画像を切り替える（背景画像なし）";
          title = "背景画像を切り替える（背景画像なし）";
          ariaLiveStatus.textContent = "背景画像なしに切り替えました";
        } else {
          ariaLabel = "背景画像を切り替える（背景画像あり）";
          title = "背景画像を切り替える（背景画像あり）";
          ariaLiveStatus.textContent = "背景画像ありに切り替えました";
        }

        updateAccessibility();
        updateIcons();

        devLog("BackgroundImage: 切り替え完了");
      });

      devLog("BackgroundImage: 初期化完了", {
        mainBackground: mainBackground,
        backgroundButton: backgroundButton,
        offIcon: offIcon,
        onIcon: onIcon,
      });
    };

    // DOMContentLoadedまたは即座に実行
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initBackgroundToggle);
    } else {
      initBackgroundToggle();
    }

    // View Transitions対応: ページ遷移時に再初期化
    document.addEventListener("astro:after-swap", () => {
      initBackgroundToggle();
    });
  })();
</script>

<style>
  #toggleBackgroundButton {
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: var(--color-white);
    border: transparent 1px solid;
    border-radius: 1rem;
    box-shadow: 0 8px 16px rgb(0 0 0 / 0.6);
    position: relative;
    width: 100%;
    height: 100%;
    min-height: 60px;
    transition:
      transform 0.1s ease,
      background 0.4s ease-in-out,
      box-shadow 0.4s ease;
  }
  #toggleBackgroundButton:is(:hover, :focus-visible) {
    background: transparent;
    box-shadow: 0 16px 8px rgb(0 0 0 / 0.6);
  }
  #toggleBackgroundButton:active {
    background: transparent;
    box-shadow: 0 4px 8px rgb(0 0 0 / 0.4);
    transform: scale(0.8);
  }
  #toggleBackgroundButton svg {
    width: 50px;
    height: 50px;
    display: inline-flex;
    filter: drop-shadow(10px 20px 20px rgb(160 160 160 / 0.7));
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    transition:
      opacity 1.8s ease,
      transform 0.35s ease;
  }
  .offBackgroundIcon {
    color: slategray;
    opacity: 1;
    z-index: 2;
    transition:
      opacity 1.8s ease,
      transform 0.35s ease;
  }
  .onBackgroundIcon {
    filter: drop-shadow(10px 20px 20px rgb(160 160 160 / 0.7));
    opacity: 0;
    z-index: 1;
    transition:
      transform 0.35s ease,
      box-shadow 0.4s ease,
      opacity 1.8s ease;
  }
  .offBackgroundIcon:is(:hover, :focus-visible) {
    transform: scale(1.1);
  }
  .onBackgroundIcon:is(:hover, :focus-visible) {
    transform: scale(1.1);
  }
  .background-visible {
    opacity: 1;
  }
  .background-hidden {
    opacity: 0;
  }
</style>
