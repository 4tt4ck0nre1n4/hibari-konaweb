---
import LogoSvg from "/public/favicon.svg";
import TextSvg from "/public/logo_text.svg";
import WhiteTextSvg from "/public/logo_whiteText.svg";
import { Image } from "astro:assets";

import Navigation from "../components/Navigation.astro";

const logo = {
  href: "/",
  ariaLabel: "ホームに戻る",
  ariaTitle: "ホームに戻る",
};
---

<header class="header">
  <div class="header__wrapper">
    <div class="header__inner">
      <h1 class="header__logo">
        <a class="header__logo_link" href={logo.href} aria-label={logo.ariaLabel} title={logo.ariaTitle}>
          <div class="header__logo_container">
            <Image
              class="header__logo_image"
              src={LogoSvg}
              alt="ロゴ画像"
              width="40"
              height="40"
              decoding="async"
              loading="eager"
              fetchpriority="high"
            />
            <svg class="header__clock_animation" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
              <circle
                class="clock-circle"
                cx="30"
                cy="30"
                r="28"
                fill="none"
                stroke-width="2"
                stroke-dasharray="176"
                stroke-dashoffset="176"></circle>
            </svg>
          </div>
          <Image
            class="header__logo_text"
            src={TextSvg}
            alt="ロゴ画像"
            width="280"
            height="50"
            decoding="async"
            loading="eager"
            fetchpriority="high"
          />
          <Image
            class="header__logo_whiteText"
            src={WhiteTextSvg}
            alt="ロゴ画像"
            width="280"
            height="50"
            decoding="async"
            loading="eager"
            fetchpriority="high"
          />
        </a>
      </h1>
      <nav class="header__nav">
        <Navigation />
      </nav>
    </div>
  </div>
</header>

<script>
  // 時計アニメーションの初期化と管理
  function initClockAnimation() {
    const clockCircle = document.querySelector<SVGCircleElement>(".clock-circle");
    if (!clockCircle) return;

    const radius = 28;
    const circumference = 2 * Math.PI * radius;
    let colorIndex = 0;

    // SVG circle の設定
    if (clockCircle.style) {
      clockCircle.style.strokeDasharray = circumference.toString();
    }

    function updateClock() {
      if (!clockCircle) return;

      const now = new Date();
      const seconds = now.getSeconds();

      // 15秒ごとに完全な円を描く
      const progress = (seconds % 15) / 15;
      const offset = circumference * (1 - progress);

      clockCircle.style.strokeDashoffset = offset.toString();

      // 15秒完了時に色をチェンジ（順番に）
      if (seconds % 15 === 0 && seconds !== 0) {
        const newColor = getNextColor();
        if (newColor) {
          clockCircle.style.stroke = newColor;
        }
      }
    }

    function getNextColor() {
      const colors = ["#4ecdc4", "#45b7d1", "#96ceb4", "#ffeaa7", "#fd79a8", "#fdcb6e", "#6c5ce7", "#a29bfe"];
      const color = colors[colorIndex];
      colorIndex = (colorIndex + 1) % colors.length;
      return color;
    }

    // 初回実行
    updateClock();

    // 1秒ごとに更新
    setInterval(updateClock, 1000);
  }

  // スクロールイベントハンドラー
  function handleScroll() {
    const header = document.querySelector<HTMLElement>(".header");
    const logoImage = document.querySelector<HTMLElement>(".header__logo_image");
    const headerMenuItems = document.querySelectorAll<HTMLElement>(".header__menu_item");

    if (!header || !logoImage || !headerMenuItems) return;

    if (window.scrollY > 50) {
      header.classList.add("is-scroll");
      logoImage.classList.add("is-scroll");
      headerMenuItems.forEach((headerMenuItem) => {
        headerMenuItem.classList.add("is-scroll");
      });
    } else {
      header.classList.remove("is-scroll");
      logoImage.classList.remove("is-scroll");
      headerMenuItems.forEach((headerMenuItem) => {
        headerMenuItem.classList.remove("is-scroll");
      });
    }
  }

  // メインスレッド処理の最適化: スロットルでスクロールイベントの実行頻度を制限
  const throttledScroll = (() => {
    let inThrottle = false;
    return () => {
      if (!inThrottle) {
        handleScroll();
        inThrottle = true;
        setTimeout(() => {
          inThrottle = false;
        }, 100); // 100msでスロットル
      }
    };
  })();

  // イベントリスナーの設定
  window.addEventListener("scroll", throttledScroll, { passive: true });

  // DOMが読み込まれた後に時計アニメーションを初期化
  document.addEventListener("DOMContentLoaded", initClockAnimation);

  // Astroの場合は、コンポーネントがマウントされた後に初期化
  if (typeof window !== "undefined") {
    initClockAnimation();
  }
</script>
