---
import Favicon from "../components/Favicon.astro";
// reset.css と global.css を通常通りインポート（Astroが最適化）
import "../styles/reset.css";
import "../styles/global.css";
import globalText from "../data/globalText.json";

interface Props {
  title: string;
  description: string;
  ogType: string;
  ogTitle: string;
  ogDescription: string;
  twitterTitle: string;
  twitterDescription: string;

  jsonLd?: string | undefined;
}

const { title, description, ogType, ogTitle, ogDescription, twitterTitle, twitterDescription, jsonLd } = Astro.props;
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'wasm-unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://hibari-konaweb.netlify.app https://hibari-konaweb.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; img-src 'self' data: blob: http://hibari-konaweb.local https://cdn.jsdelivr.net https://hibari-konaweb.com https://hibari-konaweb.netlify.app; font-src 'self' https://fonts.gstatic.com data:; connect-src 'self' blob: data: https://unpkg.com https://cdn.jsdelivr.net https://api.iconify.design https://hibari-konaweb.com https://hibari-konaweb.netlify.app; worker-src 'self' blob:; media-src 'self' blob:; object-src 'none';"
    />
    <title>{title}</title>
    <meta name="description" content={description} />
    <Favicon />
    <link rel="sitemap" href={globalText.link.sitemap} />
    <meta name="generator" content={Astro.generator} />
    <meta name="keywords" content={globalText.global.keywords} />
    <meta name="color-scheme" content={globalText.global.colorScheme} />
    <meta name="referrer" content={globalText.global.referrer} />
    <meta name="theme-color" content={globalText.global.themeColor} />
    <meta name="author" content={globalText.global.author} />
    <meta name="creator" content={globalText.global.creator} />
    <meta name="publisher" content={globalText.global.publisher} />
    <meta name="robots" content={globalText.global.robots} />
    <meta name="format-detection" content={globalText.global.formatDetection} />
    <link rel="canonical" href={globalText.link.canonical} />
    <link rel="author" href={globalText.link.author} />
    <meta name="application-name" content={globalText.global.applicationName} />
    <meta name="mobile-web-app-capable" content={globalText.global.mobileWebAppCapable} />
    <meta name="apple-mobile-web-app-title" content={globalText.global.appleMobileWebAppTitle} />
    <meta property="og:local" content={globalText.og.local} />
    <meta property="og:title" content={ogTitle} />
    <meta property="og:description" content={ogDescription} />
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={globalText.og.url} />
    <meta property="og:image" content={globalText.og.image} />
    <meta property="og:site_name" content={globalText.og.site_name} />
    <meta name="twitter:card" content={globalText.twitter.card} />
    <meta name="twitter:title" content={twitterTitle} />
    <meta name="twitter:description" content={twitterDescription} />
    <meta name="twitter:site" content={globalText.twitter.site} />
    <meta name="twitter:image" content={globalText.twitter.image} />

    <!-- Critical CSS インライン化（CLS対策強化版） -->
    <style>
      /* CLS対策: 最小限のクリティカルCSS */
      *,
      *::before,
      *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      :root {
        --gradient: linear-gradient(
          90deg,
          rgb(238 161 255 / 1) 0%,
          rgb(147 183 255 / 1) 55%,
          rgb(170 244 254 / 1) 100%
        );
        --color-white: #f1f5f9;
        --color-purple: rgb(102 51 153);
        --color-red: #ff4f48;
      }
      html {
        font-family:
          Poppins,
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          "Helvetica Neue",
          Arial,
          sans-serif;
        color: #020202;
        background-color: var(--color-white);
        text-size-adjust: none;
        scrollbar-gutter: stable;
        block-size: 100%;
      }
      html.dark {
        color: var(--color-white);
        background-color: #0d0950;
      }
      html.dark header {
        background-color: transparent;
      }
      html.dark footer {
        background-color: transparent;
      }
      body {
        min-height: 100vh;
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizespeed;
      }
      img,
      svg,
      video {
        max-width: 100%;
        display: block;
        height: auto;
      }
      a {
        color: inherit;
        text-decoration: none;
      }
      #outer-container {
        height: 100%;
      }
      #page-wrap {
        margin-block-start: 3rem;
        position: relative;
        z-index: 1;
      }
      @media (width <= 480px) {
        #page-wrap {
          margin-block-start: 7rem;
        }
      }

      /* CLS対策: ヘッダーのサイズ固定 */
      .header {
        width: 100%;
        height: 70px;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 800;
        margin-inline: auto;
        padding: 0.5rem;
      }
      @media (width <= 480px) {
        .header {
          height: 128px;
        }
      }

      /* CLS対策: フッターの基本サイズ */
      .footer {
        width: 94%;
        height: auto;
        min-height: 200px;
        margin-block-start: 3rem;
        margin-inline: auto;
        padding-block: 2rem;
        padding-inline: 3rem;
      }
      @media (width <= 480px) {
        .footer {
          width: 100%;
          padding-inline: 1rem;
        }
      }

      /* CLS対策: メインコンテナの最小高さ */
      #main-container {
        min-height: 600px;
        display: grid;
        grid-template-columns: 24% 50% 24%;
        gap: 1%;
        padding-block: 1.5rem;
        position: relative;
      }
      @media (width <= 768px) {
        #main-container {
          display: flex;
          flex-direction: column;
          min-height: auto;
          padding-block: 1rem;
          padding-inline: 1rem;
        }
      }
      @media (width <= 480px) {
        #main-container {
          padding-inline: 0.5rem;
          gap: 0.5rem;
        }
      }

      /* CLS対策: グリッドメニューの最小高さ */
      .grid__menu {
        min-height: 408px;
        width: 100%;
        height: 100%;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-gap: 1rem;
        padding-block: 2rem;
        position: relative;
      }
      @media (width <= 768px) {
        .grid__menu {
          grid-template-columns: repeat(2, 1fr);
          min-height: auto;
        }
      }
      @media (width <= 480px) {
        .grid__menu {
          grid-template-columns: 1fr;
          gap: 0.25rem;
        }
      }

      /* CLS対策: ツールバーとサイドバーの最小高さ */
      .toolbar,
      .sidebar {
        min-height: 400px;
      }
      @media (width <= 768px) {
        .toolbar,
        .sidebar {
          min-height: auto;
        }
      }

      /* CLS対策: パンくずリストのサイズ */
      .breadcrumbs__wrapper {
        width: 100%;
        max-width: 700px;
        margin-block-start: 4rem;
        margin-inline: auto;
        padding-block: 1.25rem;
      }
      .breadcrumbs__wrapper.breadcrumbs__wrapper_top {
        margin-block-start: 0.5rem;
        padding-block-start: 0;
      }
      .breadcrumbs ol {
        display: flex;
        font-size: 0.75rem;
        list-style: none;
        gap: 0.5rem;
        margin-inline-start: 1rem;
      }

      /* CLS対策: フォント読み込み時のレイアウトシフト防止 */
      h1,
      h2,
      h3,
      h4,
      h5,
      h6,
      p,
      a,
      span,
      div {
        font-family:
          Poppins,
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          "Helvetica Neue",
          Arial,
          sans-serif;
        line-height: 1.5;
      }

      /* CLS対策: 画像のアスペクト比を保持 */
      img {
        aspect-ratio: auto;
        object-fit: contain;
      }
    </style>

    {
      typeof jsonLd === "string" && jsonLd.trim() !== "" && (
        <script is:inline type="application/ld+json" set:html={jsonLd} />
      )
    }
    <!-- <link rel="preload" href="/wasm/rive.wasm" as="fetch" type="application/wasm" crossorigin="anonymous" /> -->

    <!-- フォントは@fontsource/poppinsをLayout.astroでインポート済み -->

    <!-- ページ固有の追加head要素（LCP最適化など） -->
    <slot name="head" />

    <!-- media="print" hack のフォールバックスクリプト（古いブラウザ対応） -->
    <script is:inline>
      // onloadがサポートされていないブラウザのフォールバック
      (function () {
        const links = document.querySelectorAll('link[rel="stylesheet"][media="print"]');
        links.forEach(function (link) {
          // onloadがサポートされていない場合は、即座にmedia="all"に変換
          if (!("onload" in link)) {
            link.media = "all";
          } else {
            // onloadがサポートされている場合は、onloadイベントを設定
            link.onload = function () {
              this.media = "all";
            };
          }
        });
      })();
    </script>
  </head>
</html>
