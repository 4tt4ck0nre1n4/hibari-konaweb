---
import Favicon from "../components/Favicon.astro";
import GoogleAnalytics from "../components/GoogleAnalytics.astro";
// reset.css と global.css を通常通りインポート（Astroが最適化）
import "../styles/reset.css";
import "../styles/global.css";
import globalText from "../data/globalText.json";

interface Props {
  title: string;
  description: string;
  ogType: string;
  ogTitle: string;
  ogDescription: string;
  twitterTitle: string;
  twitterDescription: string;

  jsonLd?: string | undefined;
}

const { title, description, ogType, ogTitle, ogDescription, twitterTitle, twitterDescription, jsonLd } = Astro.props;

// 開発環境と本番環境でCSPを切り替え
const isDev = import.meta.env.DEV;
const cspContent = isDev
  ? // 開発環境：localhostとWebSocketを許可
    "default-src 'self' http://localhost:* http://127.0.0.1:* ws://localhost:* ws://127.0.0.1:*; script-src 'self' 'wasm-unsafe-eval' 'unsafe-inline' http://localhost:* http://127.0.0.1:* https://cdn.jsdelivr.net https://unpkg.com https://hibari-konaweb.netlify.app https://hibari-konaweb.com https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' http://localhost:* http://127.0.0.1:* https://fonts.googleapis.com https://cdn.jsdelivr.net; img-src 'self' data: blob: http://localhost:* http://127.0.0.1:* http://hibari-konaweb.local https://cdn.jsdelivr.net https://hibari-konaweb.com https://hibari-konaweb.netlify.app https://www.google-analytics.com https://www.googletagmanager.com; font-src 'self' https://fonts.gstatic.com data:; connect-src 'self' blob: data: http://localhost:* http://127.0.0.1:* ws://localhost:* ws://127.0.0.1:* https://unpkg.com https://cdn.jsdelivr.net https://api.iconify.design https://hibari-konaweb.com https://hibari-konaweb.netlify.app https://www.google-analytics.com https://analytics.google.com https://region1.google-analytics.com; worker-src 'self' blob:; media-src 'self' blob:; object-src 'none';"
  : // 本番環境：より厳格なCSP（Google Analytics対応）
    "default-src 'self'; script-src 'self' 'wasm-unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://hibari-konaweb.netlify.app https://hibari-konaweb.com https://www.googletagmanager.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; img-src 'self' data: blob: http://hibari-konaweb.local https://cdn.jsdelivr.net https://hibari-konaweb.com https://hibari-konaweb.netlify.app https://www.google-analytics.com https://www.googletagmanager.com; font-src 'self' https://fonts.gstatic.com data:; connect-src 'self' blob: data: https://unpkg.com https://cdn.jsdelivr.net https://api.iconify.design https://hibari-konaweb.com https://hibari-konaweb.netlify.app https://www.google-analytics.com https://analytics.google.com https://region1.google-analytics.com; worker-src 'self' blob:; media-src 'self' blob:; object-src 'none';";
---

<!doctype html>
<html lang="ja">
  <head>
    <!-- Google Analytics 4 (GA4) - できるだけ早く読み込む -->
    <GoogleAnalytics />

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Security-Policy" content={cspContent} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <Favicon />
    <link rel="sitemap" href={globalText.link.sitemap} />
    <meta name="generator" content={Astro.generator} />
    <meta name="keywords" content={globalText.global.keywords} />
    <meta name="color-scheme" content={globalText.global.colorScheme} />
    <meta name="theme-color" content={globalText.global.themeColor} />
    <meta name="author" content={globalText.global.author} />
    <meta name="robots" content={globalText.global.robots} />
    <meta name="format-detection" content={globalText.global.formatDetection} />
    <link rel="canonical" href={globalText.link.canonical} />
    <link rel="author" href={globalText.link.author} />
    <meta property="og:local" content={globalText.og.local} />
    <meta property="og:title" content={ogTitle} />
    <meta property="og:description" content={ogDescription} />
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={globalText.og.url} />
    <meta property="og:image" content={globalText.og.image} />
    <meta property="og:site_name" content={globalText.og.site_name} />
    <meta name="twitter:card" content={globalText.twitter.card} />
    <meta name="twitter:title" content={twitterTitle} />
    <meta name="twitter:description" content={twitterDescription} />
    <meta name="twitter:site" content={globalText.twitter.site} />
    <meta name="twitter:image" content={globalText.twitter.image} />

    <!-- Critical CSS インライン化 -->
    <style>
      /* 最小限のクリティカルCSS */
      *,
      *::before,
      *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html {
        font-family: system-ui, sans-serif;
        color: #020202;
        background-color: #f1f5f9;
        text-size-adjust: none;
        scrollbar-gutter: stable;
        block-size: 100%;
        color-scheme: dark light;
        tab-size: 2;
      }
      html.dark {
        color: #f1f5f9;
        background-color: #0d0950;
      }
      body {
        min-height: 100vh;
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizespeed;
        min-block-size: 100%;
      }
      img,
      svg {
        max-width: 100%;
        display: block;
        vertical-align: middle;
      }

      ul {
        list-style: none;
      }
      a {
        color: inherit;
        text-decoration: none;
      }

      a[href],
      button,
      button[type],
      [tabindex]:not([tabindex*="-"]) {
        cursor: pointer;
        touch-action: manipulation;
      }

      .logo__wrapper {
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        position: fixed;
        top: 0;
        left: 0;
        z-index: 9999;
        opacity: 1;
        visibility: visible;
        transition:
          opacity 0.8s ease-in-out,
          visibility 0.8s ease-in-out;
      }

      .logo__wrapper.hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }

      html.dark .logo__wrapper {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      }

      .loading-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        width: 100%;
        max-width: 500px;
        min-height: 400px; /* CLSを防ぐために最小高さを設定 */
        padding: 2rem;
      }

      .logo-container {
        position: relative;
        margin-bottom: 2rem;
      }

      .logo-image {
        width: 120px;
        height: auto;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        will-change: transform;
      }

      .title {
        margin-bottom: 2rem;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        will-change: transform, opacity;
      }

      .title-row {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .text-stroke {
        font-family: "Poppins", sans-serif;
        font-size: 3rem;
        font-weight: 700;
        line-height: 1.2;
        color: transparent;
        text-align: center;
        position: relative;
        -webkit-text-stroke: 2px #ffffff;
        text-stroke: 2px #ffffff;
        paint-order: stroke;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        display: inline-block;
      }

      html.dark .text-stroke {
        color: #f1f5f9;
        background-image: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-size: 180%;
        background-position: 0%;
        animation: flowingGradation 6s ease-in infinite;
      }

      .text-gradient {
        display: inline-block;
        font-size: 3rem;
        font-weight: 700;
        text-align: center;
        background-image: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-size: 180%;
        background-position: 0%;
        z-index: 3;
        animation: flowingGradation 6s ease-in infinite;
      }

      .loading-spinner {
        margin-top: 1rem;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid #ffffff;
        border-radius: 50%;
        will-change: transform, opacity;
        /* CSS animation disabled - using GSAP instead */
      }

      html.dark .spinner {
        border: 3px solid rgba(241, 245, 249, 0.3);
        border-top: 3px solid #f1f5f9;
      }

      @keyframes flowingGradation {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* レスポンシブデザイン */
      @media (max-width: 768px) {
        .text-stroke,
        .text-gradient {
          font-size: 2.5rem;
        }

        .logo-image {
          width: 100px;
        }

        .title {
          gap: 0.3rem;
        }
      }

      @media (max-width: 480px) {
        .text-stroke,
        .text-gradient {
          font-size: 2rem;
        }

        .logo-image {
          width: 80px;
        }

        .title {
          gap: 0.2rem;
        }
      }

      #outer-container {
        height: 100%;
      }
      #page-wrap {
        margin-block-start: 3rem;
        position: relative;
        z-index: 1;
      }
    </style>

    {
      typeof jsonLd === "string" && jsonLd.trim() !== "" && (
        <script is:inline type="application/ld+json" set:html={jsonLd} />
      )
    }
    <!-- <link rel="preload" href="/wasm/rive.wasm" as="fetch" type="application/wasm" crossorigin="anonymous" /> -->

    <!-- フォントは@fontsource/poppinsをLayout.astroでインポート済み -->

    <!-- ページ固有の追加head要素（LCP最適化など） -->
    <slot name="head" />

    <!-- Swiper CSS非同期読み込みのフォールバックスクリプト -->
    <script is:inline>
      // media="print" hack のフォールバック（Swiper CSS用）
      (function () {
        const links = document.querySelectorAll('link[rel="stylesheet"][media="print"]');
        links.forEach(function (link) {
          const href = link.getAttribute("href");
          // Swiper CSSのみを処理
          if (href && href.includes("swiper")) {
            // onloadがサポートされていない場合は、即座にmedia="all"に変換
            if (!("onload" in link)) {
              link.media = "all";
            } else {
              // onloadがサポートされている場合は、onloadイベントを設定
              link.onload = function () {
                this.media = "all";
              };
            }
          }
        });
      })();
    </script>
  </head>
</html>
