---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import type { GetStaticPaths, PaginateFunction } from "astro";
import SafeIcon from "../../components/SafeIcon.astro";
import { generateBreadcrumbs } from "../../util/generateBreadcrumbs";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
// import "../../../app/public/wp-includes/css/dist/block-library/style.min.css";
// import "../../../app/public/wp-content/themes/arkhe/dist/css/main.css";
import globalText from "../../data/globalText.json";
import { BLOG_PAGE_API } from "../../api/headlessCms";
import FlowingLinesWrapper from "../../components/FlowingLinesWrapper.astro";
import { Image } from "astro:assets";
import { getOptimizedWordPressImage, getWordPressImageUrl } from "../../util/optimizeWordPressImage";

interface CategoryInfo {
  id: number;
  slug: string;
  name: string;
  url: string;
}

interface PostDataObject {
  id: number;
  title: {
    rendered: string;
  };
  slug: string;
  data: string;
  date: number;

  acf?: {
    blog_link?: string;
    blog_image?: string;
    blog_title?: string;
    blog_category?: string;
  };
  cat_info?: CategoryInfo[];
}

interface PageDataObject {
  url: {
    first: string | undefined;
    prev: string | undefined;
    current: string | undefined;
    next: string | undefined;
    last: string | undefined;
    base: string;
  };
  start: number;
  end: number;
  total: number;
  data: PostDataObject[];
  currentPage: number;
  size: number;
  lastPage: number;

  baseUrl: string;
}

export const getStaticPaths: GetStaticPaths = async ({ paginate }: { paginate: PaginateFunction }) => {
  try {
    console.log("üîç [Blog Pagination] Fetching posts from:", BLOG_PAGE_API);
    const dataPage = await fetch(BLOG_PAGE_API);

    if (!dataPage.ok) {
      console.error(`‚ùå [Blog Pagination] Failed to fetch posts: ${dataPage.status} ${dataPage.statusText}`);
      console.error(`‚ùå [Blog Pagination] API URL: ${BLOG_PAGE_API}`);
      throw new Error(`Failed to fetch posts: ${dataPage.status} ${dataPage.statusText}`);
    }

    const allPosts: PostDataObject[] = (await dataPage.json()) as unknown as PostDataObject[];
    console.log(`‚úÖ [Blog Pagination] Successfully fetched ${allPosts.length} posts`);

    if (!Array.isArray(allPosts) || allPosts.length === 0) {
      console.warn("‚ö†Ô∏è [Blog Pagination] No posts found. Returning empty paths.");
      console.warn("‚ö†Ô∏è [Blog Pagination] This will result in 404 errors for blog pages.");
      return [];
    }

    const paginatedPages = paginate(allPosts, { pageSize: 6 });

    console.log(`üìÑ [Blog Pagination] Generated ${paginatedPages.length} paginated pages`);

    const paths = paginatedPages.map((path) => ({
      params: { page: path.params?.page },
      props: path.props,
    }));

    const hasPage1: boolean = paths.some((p) => p.params.page === "1");

    if (!hasPage1 === false && paths.length > 0 && typeof paths[0]?.props !== "undefined") {
      const defaultPostsPageProps = paths[0].props;
      paths.unshift({
        params: { page: undefined },
        props: defaultPostsPageProps,
      });
      paths.unshift({
        params: { page: "1" },
        props: defaultPostsPageProps,
      });
    }

    console.log(`‚úÖ [Blog Pagination] Generated ${paths.length} total paths (including /blog and /blog/1)`);

    return paths;
  } catch (error) {
    console.error("‚ùå [Blog Pagination] Error in getStaticPaths:", error);
    console.error("‚ùå [Blog Pagination] API URL:", BLOG_PAGE_API);
    if (error instanceof Error) {
      console.error("‚ùå [Blog Pagination] Error message:", error.message);
      console.error("‚ùå [Blog Pagination] Error stack:", error.stack);
    }
    return [];
  }
};

const { page } = Astro.props as { page: PageDataObject };
console.log("Astro props:", JSON.stringify(page, null, 2));

const posts = Array.isArray(page.data) ? page.data : [];

// WordPressÁîªÂÉè„ÇíÊúÄÈÅ©ÂåñÔºà„Éì„É´„ÉâÊôÇ„Å´Âá¶ÁêÜÔºâ
const optimizedBlogImages = await Promise.all(
  posts.map(async (post) => {
    const optimizedImage = await getOptimizedWordPressImage(post.acf?.blog_image, {
      width: 800,
      height: 600,
      quality: 85,
      format: "webp",
    });
    // ÊúÄÈÅ©Âåñ„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØÂÖÉ„ÅÆURL„Çí‰ΩøÁî®
    const fallbackUrl =
      typeof post.acf?.blog_image === "string" ? post.acf.blog_image : getWordPressImageUrl(post.acf?.blog_image) ?? "";
    return {
      ...post,
      optimizedImage,
      fallbackUrl,
    };
  })
);

const hasNextPage = page.size < page.total ? true : false;
const blogTitle = "Blog";
const blogText = "„Éñ„É≠„Ç∞Ë®ò‰∫ã„ÅÆ‰∏ÄË¶ß„Åß„Åô„ÄÇ";
const errorBlogText = "„Éñ„É≠„Ç∞Ë®ò‰∫ã„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ";
const errorCategoryText = "„Ç´„ÉÜ„Ç¥„É™„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ";
const postAriaLabel = "„ÅÆË®ò‰∫ã„Å∏";
const postAriaTitle = "„ÅÆË®ò‰∫ã„Å∏";
const categoryAriaLabel = "„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÉºË®ò‰∫ã„Å∏";
const categoryAriaTitle = "„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÉºË®ò‰∫ã„Å∏";
const datetime = "ÊäïÁ®øÊó•:";
const category = "„Ç´„ÉÜ„Ç¥„É™„Éº:";

const dateIcon = {
  icon: "emojione-v1:alarm-clock",
  width: 24,
  height: 24,
};

const categoryIcon = {
  icon: "emojione-v1:bookmark",
  width: 24,
  height: 24,
};

const postPagination = {
  first: "ÊúÄÂàù„ÅÆ„Éö„Éº„Ç∏„Å∏",
  prev: "Ââç„ÅÆ„Éö„Éº„Ç∏„Å∏",
  current: "ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏",
  next: "Ê¨°„ÅÆ„Éö„Éº„Ç∏„Å∏",
  last: "ÊúÄÂæå„ÅÆ„Éö„Éº„Ç∏„Å∏",
};

const crumbs = generateBreadcrumbs(Astro.url.pathname);
---

<Layout
  title={globalText.blog.title}
  description={globalText.blog.description}
  ogType={globalText.local.type}
  ogTitle={globalText.blog.title}
  ogDescription={globalText.blog.description}
  twitterTitle={globalText.blog.title}
  twitterDescription={globalText.blog.description}
>
  <div id="outer-container">
    <Header />
    <main id="page-wrap">
      <div class="breadcrumbs__wrapper">
        <Breadcrumbs {crumbs} />
      </div>
      <div id="main-container">
        <div class="blog__wrapper">
          <FlowingLinesWrapper>
            <h1 class="blog__title">
              {blogTitle}
            </h1>
            <p class="blog__text">
              {blogText}
            </p>
          </FlowingLinesWrapper>
          <ul class="blog__menu">
            {
              optimizedBlogImages.length > 0 ? (
                optimizedBlogImages.map((postData) => (
                  <li class="blog__menu_item">
                    <article
                      class="blog__menu_article"
                      aria-labelledby={`blog-post-${postData.id ?? postData.slug}-${postData.acf?.blog_title ?? postData.title.rendered}`}
                    >
                      <a
                        class="blog__menu_link"
                        href={`/blog/${postData.slug ?? ""}`}
                        aria-label={`${postData.slug}${postAriaLabel}`}
                        title={`${postData.slug}${postAriaTitle}`}
                      >
                        <div class="blog__contents">
                          <h2
                            id={`blog-post-${postData.id ?? postData.slug}-${postData.acf?.blog_title ?? postData.title.rendered}`}
                            class="blog__header"
                          >
                            {postData.acf?.blog_title ?? postData.title.rendered}
                          </h2>
                        </div>
                        <div class="blog__thumbnail">
                          {postData.optimizedImage ? (
                            <Image
                              class="blog__menu_image"
                              src={postData.optimizedImage.src}
                              alt={postData.title.rendered}
                              width={800}
                              height={600}
                              loading="lazy"
                              decoding="async"
                            />
                          ) : (
                            <img
                              class="blog__menu_image"
                              src={postData.fallbackUrl}
                              alt={postData.title.rendered}
                              decoding="async"
                              loading="lazy"
                            />
                          )}
                        </div>
                      </a>
                      <div class="blog__footer">
                        <div class="blog__times">
                          <SafeIcon name={dateIcon.icon} width={dateIcon.width} height={dateIcon.height} />
                          <span class="blog__datetime_span screenReader-only">{datetime}</span>
                          <time
                            class="blog__dateTime"
                            datetime={new Date(postData.date)
                              .toLocaleDateString("ja-JP", {
                                year: "numeric",
                                month: "2-digit",
                                day: "2-digit",
                              })
                              .replaceAll("/", "-")}
                            set:html={new Date(postData.date)
                              .toLocaleDateString("ja-JP", {
                                year: "numeric",
                                month: "2-digit",
                                day: "2-digit",
                              })
                              .replaceAll("/", "-")}
                          />
                        </div>
                        <div class="blog__category">
                          {Array.isArray(postData.cat_info) && postData.cat_info.length > 0 ? (
                            <a
                              class="category__link"
                              href={`/blog/category/${decodeURIComponent(postData.cat_info[0]?.slug ?? "")}`}
                              aria-label={`${postData.cat_info[0]?.name}${categoryAriaLabel}`}
                              title={`${postData.cat_info[0]?.name}${categoryAriaTitle}`}
                            >
                              <SafeIcon
                                name={categoryIcon.icon}
                                width={categoryIcon.width}
                                height={categoryIcon.height}
                              />
                              <span class="blog__category_span screenReader-only">{category}</span>
                              <span class="category__link_span" set:html={postData.cat_info[0]?.name} />
                            </a>
                          ) : (
                            <span>{errorCategoryText}</span>
                          )}
                        </div>
                      </div>
                    </article>
                  </li>
                ))
              ) : (
                <p>{errorBlogText}</p>
              )
            }
          </ul>

          <div class="pagination">
            {
              hasNextPage && (
                <ul class="pagination__menu">
                  {page.url.first !== "" && page.currentPage > 1 ? (
                    <li class="pagination__menu_item">
                      <a
                        class="pagination__link_current"
                        href={page.url.first}
                        aria-label={postPagination.first}
                        title={postPagination.first}
                      >
                        1
                      </a>
                    </li>
                  ) : (
                    <li class="pagination__menu_item">
                      <span class="pagination__link_empty" />
                    </li>
                  )}
                  {page.url.prev !== "" && page.currentPage > 1 ? (
                    <li class="pagination__menu_item">
                      <a
                        class="pagination__link"
                        href={page.url.prev}
                        aria-label={`${postPagination.prev}(${page.currentPage - 1})`}
                        title={postPagination.prev}
                      >
                        &larr;
                      </a>
                    </li>
                  ) : (
                    <li class="pagination__menu_item">
                      <span class="pagination__link_empty" />
                    </li>
                  )}

                  <li class="pagination__menu_item">
                    <a
                      class="pagination__link_current"
                      href={page.url.current}
                      aria-label={`${postPagination.current}(${page.currentPage})`}
                      title={`${postPagination.current}(${page.currentPage})`}
                    >
                      {typeof page.currentPage === "number" && page.currentPage > 0 ? page.currentPage : "1"}
                    </a>
                  </li>
                  {page.url.next !== "" && page.currentPage < page.lastPage ? (
                    <li class="pagination__menu_item">
                      <a
                        class="pagination__link"
                        href={page.url.next}
                        aria-label={`${postPagination.next}(${page.currentPage + 1})`}
                        title={postPagination.next}
                      >
                        &rarr;
                      </a>
                    </li>
                  ) : (
                    <li class="pagination__menu_item">
                      <span class="pagination__link_empty" />
                    </li>
                  )}
                  {page.url.last !== "" && page.currentPage !== page.lastPage ? (
                    <li class="pagination__menu_item">
                      <a
                        class="pagination__link_current"
                        href={page.url.last}
                        aria-label={`${postPagination.last}(${page.lastPage})`}
                        title={`${postPagination.last}(${page.lastPage})`}
                      >
                        {page.lastPage}
                      </a>
                    </li>
                  ) : (
                    <li class="pagination__menu_item">
                      <span class="pagination__link_empty" />
                    </li>
                  )}
                </ul>
              )
            }
          </div>
        </div>
        <!-- </div> -->
      </div>
      <Footer />
    </main>
  </div>
</Layout>

<style>
  .blog__wrapper {
    width: 700px;
    max-width: calc(100% - 2rem);
    margin-inline: auto;
  }

  .blog__title {
    font-size: 2rem;
    text-align: center;
    padding-inline: 1rem;
  }
  .blog__text {
    font-size: 1rem;
    line-height: 1.8;
    letter-spacing: 0.2em;
    color: inherit;
    text-align: center;
    padding-inline: 1rem;
  }
  .blog__menu {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    /* grid-template-columns: repeat(auto-fill, minmax(20ch, 1fr)); */
    gap: 1.5rem;
    color: white;
    list-style: none;
    margin-block-start: 3rem;
    padding-inline-start: 0;
  }

  .blog__menu_item {
    display: flex;
    flex-direction: column;
    height: 100%;
    color: rebeccapurple;
    background-color: darkgray;
    background-color: aliceblue;
    border: 1px solid rebeccapurple;
    border: none;
    box-shadow: 0 0 8px rgb(0 0 0 / 0.6);
    border-radius: 1rem;
    overflow: hidden;
    position: relative;
    padding-block: 1rem;
    padding-inline: 1rem;
    transition: all 0.4s ease;
  }
  .blog__menu_item:is(:hover, :focus-visible) {
    border: transparent 1px solid;
    box-shadow: 0 10px 10px rgb(0 0 0 / 0.6);
  }

  .blog__menu_article {
    display: flex;
    flex-direction: column;
    height: 100%;
    text-decoration: none;
  }

  .blog__menu_link {
    display: flex;
    flex-direction: column;
    flex: 1;
    text-decoration: none;
    pointer-events: none;
  }

  .blog__contents {
    flex: 1;
    display: flex;
    flex-direction: column;
    transition: opacity 0.25s;
  }

  .blog__contents:is(:hover, :focus-visible) {
    opacity: 0.5;
  }

  .blog__header {
    flex: 1;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    font-size: 1rem;
    line-height: 1.5;
    letter-spacing: 0.02em;
    color: inherit;
    text-align: justify;
    overflow: hidden;
    margin-block-start: 1rem;
  }
  .blog__thumbnail {
    width: 100%;
    position: relative;
    aspect-ratio: 2 / 1;
    order: -1;
    overflow: hidden;
  }

  .blog__menu_image {
    width: 100%;
    height: auto;
    display: flex;
    flex-shrink: 0;
    box-shadow: 0 8px 8px rgb(0 0 0 / 0.6);
    object-fit: contain;
    overflow: hidden;
    transition: transform 0.5s ease;
    margin-block-start: 1rem;
    padding-inline: 0.25rem;
  }

  .blog__menu_image:is(:hover, :focus-visible) {
    transform: scale(1.2);
  }

  .blog__footer {
    display: flex;
    align-items: center;
    flex-wrap: nowrap;
    margin-block-start: 1rem;
    margin-top: auto;
    padding-top: 1rem;
  }

  .blog__times {
    display: flex;
    align-items: center;
  }

  .blog__dateTime {
    font-size: 0.75rem;
    color: inherit;
    align-self: flex-end;
    margin-inline-start: 0.25rem;
  }

  .blog__category {
    overflow: hidden;
    margin-inline-start: 0.5rem;
  }

  .category__link {
    display: flex;
    align-items: center;
    font-size: 0.75rem;
    color: inherit;
    text-decoration: none;
    margin-inline-start: 0.5rem;
  }

  .category__link_span {
    font-size: 0.75rem;
    color: inherit;
    align-self: flex-start;
    margin-block-start: 0.25rem;
  }
  ul.footer__contactMenu {
    padding-inline-start: 0;
  }
</style>

<script>
  import { setupFlowingLinesAnimation } from "../../scripts/flowingLines";
  setupFlowingLinesAnimation();
</script>
