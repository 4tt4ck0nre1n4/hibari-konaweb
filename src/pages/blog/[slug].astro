---
import Layout from "../../layouts/Layout.astro";
import type { GetStaticPaths } from "astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import globalText from "../../data/globalText.json";
// import "../../../app/public/wp-includes/css/dist/block-library/style.min.css";
// import "../../../app/public/wp-content/themes/arkhe/dist/css/main.css";
import { BLOG_POST_API, BLOG_SLUG_API } from "../../api/headlessCms";
import SafeIcon from "../../components/SafeIcon.astro";

interface Post {
  id: number;
  title: {
    rendered: string;
  };
  slug: string;
  date: string;
  categories: number[];
  cat_info?: {
    id: number;
    slug: string;
    name: string;
  }[];
  content: {
    rendered: string;
  };
  _embedded?: {
    author?: {
      name: string;
      link: string;
    }[];
    "wp:term"?: Array<
      Array<{
        id: number;
        name: string;
      }>
    >;
  };
  acf?: {
    blog_image?: string;
  };
}

const dateIcon = {
  icon: "emojione-v1:alarm-clock",
  width: 24,
  height: 24,
};

const categoryIcon = {
  icon: "emojione-v1:bookmark",
  width: 24,
  height: 24,
};

export const getStaticPaths: GetStaticPaths = async () => {
  try {
    console.log("Fetching blog slugs from API:", BLOG_POST_API);

    const response = await fetch(
      // `${headlessCmsUrl}${headlessCmsApiPrefix}posts?context=embed&acf_format=standard`;
      BLOG_POST_API
    );

    if (!response.ok) {
      throw new Error(`Failed to fetch blog slugs: ${response.status}`);
    }

    const dataPosts = (await response.json()) as Post[];

    if (!Array.isArray(dataPosts) || dataPosts.length === 0) {
      console.warn("No posts found, returning empty paths.");
      return [];
    }

    const paths = dataPosts.map((post: Post) => ({
      params: {
        slug: post.slug,
      },
    }));

    console.log("Generated paths:", paths);

    return paths;
  } catch (error) {
    console.error("Error fetching static paths:", error);
    return [];
  }
};

const { slug } = Astro.params;
let post: Post | undefined;

// リトライ機構付きのフェッチ関数
async function fetchWithRetry(url: string, retries = 3, delay = 1000): Promise<Response> {
  for (let i = 0; i < retries; i++) {
    try {
      const response = await fetch(url);

      // 5xx エラーの場合はリトライ
      if (response.status >= 500 && i < retries - 1) {
        console.warn(`Server error ${response.status}, retrying... (${i + 1}/${retries})`);
        await new Promise((resolve) => setTimeout(resolve, delay * (i + 1)));
        continue;
      }

      return response;
    } catch (error) {
      if (i < retries - 1) {
        console.warn(`Fetch failed, retrying... (${i + 1}/${retries})`, error);
        await new Promise((resolve) => setTimeout(resolve, delay * (i + 1)));
        continue;
      }
      throw error;
    }
  }
  throw new Error("Max retries reached");
}

try {
  console.log(`Fetching blog post data for slug: ${slug}`);

  const resPosts = await fetchWithRetry(`${BLOG_SLUG_API}${slug}`);

  if (!resPosts.ok) {
    console.error(`Failed to fetch post data for slug "${slug}": ${resPosts.status} ${resPosts.statusText}`);
    throw new Error(`Failed to fetch post data: ${resPosts.status}`);
  }

  const dataPosts = (await resPosts.json()) as Post[];

  if (!Array.isArray(dataPosts) || dataPosts.length === 0) {
    console.error("No Post data found for slug:", slug);
    throw new Error("Post not found");
  }

  post = dataPosts[0];
} catch (error) {
  console.error("Error fetching post data:", error);
  throw new Error("Post not found");
}

const postId = post?.id ?? 0;
const postSlugTitle = post?.title?.rendered;
const title = post?.title?.rendered ?? "記事が見つかりません";
const publishedDate = typeof post?.date === "string" && post.date !== "" ? new Date(post.date).toISOString() : "";
const postDate = post?.date ?? "";
const content = post?.content?.rendered ?? "この記事の内容は表示できません";
const postUrl = `${globalText.url}/blog/${post?.slug}`;
const errorCategoryText = "カテゴリーが見つかりませんでした。";
const datetime = "投稿日:";
const categoryLabel = "カテゴリー:";
const categoryAriaLabel = "のカテゴリー記事へ";
const categoryAriaTitle = "のカテゴリー記事へ";
export const prerender = true;

const jsonLd = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: title,
  description: post?.content?.rendered.replace(/(<([^>]+)>)/gi, "").trim() ?? "",
  dataPublished: publishedDate,
  url: `${globalText.url}/blog/${post?.slug}`,
  author: {
    "@type": "Person",
    name: `${globalText.global.author}`,
  },
  image: post?.acf?.blog_image ?? "",
});

const crumbs = [{ name: "Home", path: "/" }, { name: "Blog", path: "/blog" }, { name: postSlugTitle }];
---

<Layout
  title={title ?? "Blog Title Not Found"}
  description={globalText.blog.description}
  ogType={globalText.local.type}
  ogTitle={title ?? "Blog Title Not Found"}
  ogDescription={globalText.blog.description}
  twitterTitle={title ?? "Blog Title Not Found"}
  twitterDescription={globalText.blog.description}
  jsonLd={jsonLd}
>
  <div class="breadcrumbs__wrapper">
    <Breadcrumbs {crumbs} />
  </div>
  <div class="blog-detail__wrapper">
    <div class="blog-detail__container">
      <article id={postId.toString()} class="blog-detail__article">
        <header class="blog-detail__header">
          <h1 class="blog-detail__title" set:html={title} />
          <div class="blog-detail__meta">
            <div class="blog-detail__times">
              <SafeIcon name={dateIcon.icon} width={dateIcon.width} height={dateIcon.height} />
              <span class="blog-detail__datetime_span screenReader-only">{datetime}</span>
              {
                postDate !== "" && (
                  <time
                    class="blog-detail__dateTime"
                    datetime={new Date(postDate)
                      .toLocaleDateString("ja-JP", {
                        year: "numeric",
                        month: "2-digit",
                        day: "2-digit",
                      })
                      .replaceAll("/", "-")}
                  >
                    {new Date(postDate).toLocaleDateString("ja-JP", {
                      year: "numeric",
                      month: "2-digit",
                      day: "2-digit",
                    })}
                  </time>
                )
              }
            </div>
            <div class="blog-detail__category">
              {
                Array.isArray(post?.cat_info) && post.cat_info.length > 0 ? (
                  <a
                    class="blog-detail__category-link"
                    href={`/blog/category/${decodeURIComponent(post.cat_info[0]?.slug ?? "")}`}
                    aria-label={`${post.cat_info[0]?.name}${categoryAriaLabel}`}
                    title={`${post.cat_info[0]?.name}${categoryAriaTitle}`}
                  >
                    <SafeIcon name={categoryIcon.icon} width={categoryIcon.width} height={categoryIcon.height} />
                    <span class="blog-detail__category_span screenReader-only">{categoryLabel}</span>
                    <span class="blog-detail__category-link_span">{post.cat_info[0]?.name}</span>
                  </a>
                ) : (
                  <span>{errorCategoryText}</span>
                )
              }
            </div>
          </div>
        </header>

        <!-- 広告エリア（上部） -->
        <div class="blog-detail__ad-top" id="ad-top">
          <!-- 将来的な広告表示エリア -->
        </div>

        <!-- メインコンテンツ -->
        <div class="blog-detail__content" set:html={content} />

        <!-- 広告エリア（コンテンツ中） -->
        <div class="blog-detail__ad-middle" id="ad-middle">
          <!-- 将来的な広告表示エリア -->
        </div>

        <!-- フッター情報 -->
        <footer class="blog-detail__footer">
          <div class="blog-detail__share">
            <h2 class="blog-detail__share-title">シェアする</h2>
            <div class="blog-detail__share-buttons">
              <a
                href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(postUrl)}&text=${encodeURIComponent(title)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="blog-detail__share-button blog-detail__share-button--twitter"
                aria-label="Twitterでシェア"
              >
                Twitter
              </a>
              <a
                href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(postUrl)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="blog-detail__share-button blog-detail__share-button--facebook"
                aria-label="Facebookでシェア"
              >
                Facebook
              </a>
              <a
                href={`https://b.hatena.ne.jp/add?mode=confirm&url=${encodeURIComponent(postUrl)}&title=${encodeURIComponent(title)}`}
                target="_blank"
                rel="noopener noreferrer"
                class="blog-detail__share-button blog-detail__share-button--hatena"
                aria-label="はてなブックマークに追加"
              >
                はてブ
              </a>
            </div>
          </div>
        </footer>
      </article>

      <!-- サイドバー -->
      <aside class="blog-detail__sidebar">
        <!-- 広告エリア（サイドバー上部） -->
        <div class="blog-detail__ad-sidebar-top" id="ad-sidebar-top">
          <!-- 将来的な広告表示エリア -->
        </div>

        <!-- 目次エリア（将来的に追加可能） -->
        <div class="blog-detail__toc" id="table-of-contents">
          <!-- 将来的に目次を自動生成 -->
        </div>

        <!-- 関連記事エリア（将来的に追加可能） -->
        <div class="blog-detail__related" id="related-posts">
          <!-- 将来的に関連記事を表示 -->
        </div>

        <!-- 広告エリア（サイドバー下部） -->
        <div class="blog-detail__ad-sidebar-bottom" id="ad-sidebar-bottom">
          <!-- 将来的な広告表示エリア -->
        </div>
      </aside>
    </div>
  </div>
</Layout>

<style>
  /* メインラッパー */
  .blog-detail__wrapper {
    width: 100%;
    max-width: 1200px;
    margin-inline: auto;
    padding-inline: 1rem;
    padding-block: 2rem;
  }

  /* コンテナ（2カラムレイアウト） */
  .blog-detail__container {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 2rem;
    align-items: start;
  }

  /* メイン記事 */
  .blog-detail__article {
    background-color: var(--color-white, #f1f5f9);
    border-radius: 0.5rem;
    padding: 2rem;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  }

  /* ヘッダー */
  .blog-detail__header {
    margin-block-end: 2rem;
    padding-block-end: 1.5rem;
    border-bottom: 2px solid var(--color-purple, #639);
  }

  .blog-detail__title {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1.5;
    margin-block-end: 1rem;
    color: var(--color-purple, #639);
  }

  /* メタ情報 */
  .blog-detail__meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
    font-size: 0.875rem;
    color: var(--color-gray, #666);
  }

  .blog-detail__times {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .blog-detail__dateTime {
    color: inherit;
  }

  .blog-detail__category {
    display: flex;
    align-items: center;
  }

  .blog-detail__category-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    color: inherit;
    transition: opacity 0.2s;
  }

  .blog-detail__category-link:hover {
    opacity: 0.7;
  }

  .blog-detail__category-link_span {
    color: inherit;
  }

  /* 広告エリア */
  .blog-detail__ad-top,
  .blog-detail__ad-middle,
  .blog-detail__ad-sidebar-bottom {
    min-height: 100px;
    background-color: var(--color-gray-light, #f5f5f5);
    border: 1px dashed var(--color-gray, #ccc);
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-gray, #999);
    font-size: 0.875rem;
    margin-block: 1.5rem;
  }

  .blog-detail__ad-sidebar-top {
    min-height: 100px;
    background-color: var(--color-gray-light, #f5f5f5);
    border: 1px dashed var(--color-gray, #ccc);
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-gray, #999);
    font-size: 0.875rem;
  }

  .blog-detail__ad-top::before,
  .blog-detail__ad-middle::before,
  .blog-detail__ad-sidebar-top::before,
  .blog-detail__ad-sidebar-bottom::before {
    content: "広告表示エリア";
  }

  /* メインコンテンツ */
  .blog-detail__content {
    font-size: 1rem;
    line-height: 1.8;
    color: var(--color-text, #333);
    margin-block: 2rem;
  }

  /* WordPressコンテンツのスタイル調整 */
  .blog-detail__content :global(h2) {
    font-size: 1.5rem;
    font-weight: 700;
    margin-block-start: 2rem;
    margin-block-end: 1rem;
    padding-block-end: 0.5rem;
    border-bottom: 2px solid var(--color-purple, #639);
    color: var(--color-purple, #639);
  }

  .blog-detail__content :global(h3) {
    font-size: 1.25rem;
    font-weight: 600;
    margin-block-start: 1.5rem;
    margin-block-end: 0.75rem;
    color: var(--color-purple, #639);
  }

  .blog-detail__content :global(h4) {
    font-size: 1.125rem;
    font-weight: 600;
    margin-block-start: 1.25rem;
    margin-block-end: 0.5rem;
  }

  .blog-detail__content :global(p) {
    margin-block-end: 1rem;
  }

  .blog-detail__content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin-block: 1.5rem;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  }

  .blog-detail__content :global(ul),
  .blog-detail__content :global(ol) {
    margin-block: 1rem;
    padding-inline-start: 2rem;
  }

  .blog-detail__content :global(li) {
    margin-block-end: 0.5rem;
  }

  .blog-detail__content :global(blockquote) {
    border-inline-start: 4px solid var(--color-purple, #639);
    padding-inline-start: 1rem;
    margin-block: 1.5rem;
    font-style: italic;
    color: var(--color-gray, #666);
  }

  .blog-detail__content :global(code) {
    background-color: var(--color-gray-light, #f5f5f5);
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
    font-family: monospace;
    font-size: 0.9em;
  }

  .blog-detail__content :global(pre) {
    background-color: var(--color-gray-light, #f5f5f5);
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-block: 1.5rem;
  }

  .blog-detail__content :global(pre code) {
    background-color: transparent;
    padding: 0;
  }

  .blog-detail__content :global(a) {
    color: var(--color-purple, #639);
    text-decoration: underline;
    transition: opacity 0.2s;
  }

  .blog-detail__content :global(a:hover) {
    opacity: 0.7;
  }

  /* フッター */
  .blog-detail__footer {
    margin-block-start: 3rem;
    padding-block-start: 2rem;
    border-top: 2px solid var(--color-purple, #639);
  }

  .blog-detail__share {
    margin-block-start: 1.5rem;
  }

  .blog-detail__share-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-block-end: 1rem;
    color: var(--color-purple, #639);
  }

  .blog-detail__share-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .blog-detail__share-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s;
    color: var(--color-white, #f1f5f9);
  }

  .blog-detail__share-button--twitter {
    background-color: #1da1f2;
  }

  .blog-detail__share-button--twitter:hover {
    background-color: #0d8bd9;
  }

  .blog-detail__share-button--facebook {
    background-color: #1877f2;
  }

  .blog-detail__share-button--facebook:hover {
    background-color: #166fe5;
  }

  .blog-detail__share-button--hatena {
    background-color: #00a4de;
  }

  .blog-detail__share-button--hatena:hover {
    background-color: #0093cc;
  }

  /* サイドバー */
  .blog-detail__sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .blog-detail__toc,
  .blog-detail__related {
    background-color: var(--color-white, #f1f5f9);
    border-radius: 0.5rem;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
    min-height: 200px;
  }

  /* レスポンシブデザイン */
  @media (max-width: 768px) {
    .blog-detail__container {
      grid-template-columns: 1fr;
    }

    .blog-detail__article {
      padding: 1.5rem;
      order: 1;
    }

    .blog-detail__title {
      font-size: 1.5rem;
    }

    .blog-detail__meta {
      flex-direction: column;
      align-items: flex-start;
    }

    .blog-detail__sidebar {
      order: 2;
    }
  }

  /* スクリーンリーダー用 */
  /* .screenReader-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  } */
</style>
