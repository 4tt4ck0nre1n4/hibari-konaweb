---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Logo from "../components/Logo.astro";
import Breadcrumbs from "../components/Breadcrumbs.astro";
import Aside from "../components/Aside.astro";
import SwiperMenu from "../components/SwiperMenu.astro";
import globalText from "../data/globalText.json";
import SwiperDisplay from "../components/SwiperDisplay.astro";
import gridBackgroundImageSrc from "../assets/gridBackground.webp";
import { getImage } from "astro:assets";
import FirstView from "../components/FirstView.astro";
import GridMenu from "../components/GridMenu.astro";
import ControlMenu from "../components/ControlMenu.astro";
const gridBackgroundImage = await getImage({ src: gridBackgroundImageSrc });
---

<Layout
  title={globalText.top.title}
  description={globalText.top.description}
  ogType={globalText.og.type}
  ogTitle={globalText.top.title}
  ogDescription={globalText.top.description}
  twitterTitle={globalText.top.title}
  twitterDescription={globalText.top.description}
>
  <!-- LCPèƒŒæ™¯ç”»åƒã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆPageSpeed Insightsæœ€é©åŒ–ï¼‰ -->
  <link slot="head" rel="preload" href={gridBackgroundImage.src} as="image" fetchpriority="low" />

  <div id="outer-container">
    <Header />
    <main id="page-wrap">
      <Logo />
      <div class="breadcrumbs__wrapper breadcrumbs__wrapper_top">
        <Breadcrumbs crumbs={[]} />
      </div>

      <FirstView />

      <div class="swiper-display-container swiper-display-container--mobile">
        <SwiperDisplay />
      </div>
      <div id="main-container" style={`background-image: url(${gridBackgroundImage.src})`}>
        <aside class="toolbar">
          <Aside />
        </aside>
        <div id="js-grid" class="grid">
          <div class="wrapper">
            <GridMenu />
            <ControlMenu />
          </div>
        </div>
        <div class="sidebar">
          <SwiperMenu />
        </div>
      </div>
      <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ï¼šfooterç›´ä¸Šã«é…ç½® -->
      <div class="swiper-display-container swiper-display-container--desktop">
        <SwiperDisplay />
      </div>
    </main>
    <Footer />
    <canvas id="canvas" class="canvas" width="800" height="600"></canvas>
  </div>
</Layout>

<style is:global>
  #main-container {
    min-height: 600px; /* CLSã‚’é˜²ããŸã‚ã«æœ€å°é«˜ã•ã‚’è¨­å®š */
    display: grid;
    grid-template-columns: 24% 50% 24%;
    gap: 1%;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    position: relative;
    padding-block: 1.5rem;
    z-index: 1;
  }

  .toolbar {
    min-height: 400px; /* CLSã‚’é˜²ããŸã‚ã«æœ€å°é«˜ã•ã‚’è¨­å®š */
  }

  .sidebar {
    min-height: 400px; /* CLSã‚’é˜²ããŸã‚ã«æœ€å°é«˜ã•ã‚’è¨­å®š */
  }
  .swiper-display-container--mobile {
    display: none; /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯éè¡¨ç¤º */
  }

  .swiper-display-container--desktop {
    display: block; /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã¯è¡¨ç¤º */
    width: 100%;
  }

  /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºã§ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  @media (width <= 768px) {
    /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¹ãƒãƒ›ã§ã¯#main-containerã®ç›´ä¸Šã«é…ç½® */
    .swiper-display-container--mobile {
      display: block; /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¹ãƒãƒ›ã§ã¯è¡¨ç¤º */
      width: 100%;
      margin-bottom: 0.5rem;
    }

    .swiper-display-container--desktop {
      display: none; /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¹ãƒãƒ›ã§ã¯éè¡¨ç¤º */
    }

    #main-container {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding-block: 1rem;
      padding-inline: 1rem;
      min-height: auto;
      z-index: 1; /* tsParticlesã‚ˆã‚Šä¸Šã«è¡¨ç¤º */
    }

    .toolbar {
      order: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      min-height: auto;
    }

    .grid {
      order: 3;
      width: 100%;
      height: auto;
      min-height: auto;
    }

    .sidebar {
      order: 2;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-height: auto;
    }
  }

  /* 480pxä»¥ä¸‹ã§ã®è¶…å°å‹ã‚¹ãƒãƒ›æœ€é©åŒ– */
  @media (width <= 480px) {
    #main-container {
      padding-inline: 0.5rem;
      gap: 0.5rem;
      min-height: auto;
    }

    .toolbar {
      grid-template-columns: 1fr;
      gap: 0.25rem;
      min-height: auto;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      margin-block-end: 0;
      gap: 0.35rem;
      min-height: auto;
    }

    .grid {
      margin-block-start: 1rem; /* ã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºã§ã®ä½™ç™½èª¿æ•´ */
    }
  }
  #main-container.is-notImage {
    background-image: none !important;
    background-color: transparent !important;
  }
  .is-notImage {
    transition: background 2s ease-in-out;
  }
  .toolbar {
    /* grid-area: 1 / 1 / 2 / 2; */
    /* grid-area: 1 / 1 / 1 / 1; */
    display: flex;
    flex-direction: column;
    row-gap: 0.75rem;
    color: inherit;
    position: relative;
  }
  .grid {
    grid-area: 1 / 2 / 2 / 3;
    width: 100%;
    height: 100%;
    position: relative;
    background-color: transparent;
    transition:
      5s height ease-out,
      5s opacity ease-out;
  }
  .canvas {
    width: 100%;
    height: 100%;
    background-color: transparent;
    position: fixed;
    top: 0;
    left: 0;
    pointer-events: none;
    z-index: 9999;
    /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ãƒ•ãƒˆé˜²æ­¢: åˆæœŸã‚µã‚¤ã‚ºã‚’æ˜ç¤ºçš„ã«è¨­å®š */
    min-width: 100vw;
    min-height: 100vh;
  }

  /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã‚µã‚¤ã‚ºã§ã®canvasæœ€é©åŒ– */
  @media (width <= 1024px) and (width > 768px) {
    .canvas {
      min-width: 1024px;
      min-height: 768px;
    }
  }

  /* ã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºã§ã®canvasæœ€é©åŒ– */
  @media (width <= 768px) {
    .canvas {
      min-width: 100vw;
      min-height: 100vh;
      /* ã‚¹ãƒãƒ›ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º/éè¡¨ç¤ºã«å¯¾å¿œ */
      min-height: -webkit-fill-available;
    }
  }

  /* è¶…å°å‹ã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºã§ã®canvasæœ€é©åŒ– */
  @media (width <= 480px) {
    .canvas {
      min-width: 100vw;
      min-height: 100vh;
      /* ã‚¹ãƒãƒ›ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º/éè¡¨ç¤ºã«å¯¾å¿œ */
      min-height: -webkit-fill-available;
    }
  }
  .wrapper {
    width: 100%;
    max-width: 700px;
    margin-inline: auto;
  }

  .sidebar {
    grid-area: 1 / 3 / 2 / 4;
    display: grid;
  }
  /* .particles-container {
    width: 100%;
    height: 200px;
    border: rebeccapurple 1px solid;
    position: relative;
  } */
  #tsparticles {
    width: 100%;
    height: 500px;
    display: block;
    /* ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€éã—ã¦ã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ãªã‚‹ã‚ˆã†ã«ã™ã‚‹ */
    pointer-events: none;
  }

  /* ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã«pointer-events: autoã‚’è¨­å®šã—ã¦ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹ */
  /* tsParticlesãŒå…¨ç”»é¢ã‚’è¦†ã£ã¦ã‚‚ã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ãªã‚‹ã‚ˆã†ã«ã™ã‚‹ */
  button,
  #toggleBackgroundButton,
  #clockIcon,
  #toggleLogoSvgButton,
  .particlesButton,
  #confettiButton,
  .particlesButton__inner,
  .tools__wrapper,
  .particles__wrapper {
    pointer-events: auto;
    position: relative;
    z-index: 10; /* tsParticlesï¼ˆz-index: 2ï¼‰ã‚ˆã‚Šä¸Šã«è¡¨ç¤º */
  }

  /* tsParticlesã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã¯pointer-events: noneã ãŒã€ãã®ä¸­ã®ãƒœã‚¿ãƒ³ã¯ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ */
  .particles__inner {
    pointer-events: none;
  }

  .particles__inner > * {
    pointer-events: auto;
  }
</style>

<!-- é–‹ç™ºç’°å¢ƒãƒ•ãƒ©ã‚°ã‚’è¨­å®šï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ã«ç½®æ›ã•ã‚Œã‚‹ï¼‰ -->
<script is:inline define:vars={{ isDev: import.meta.env.DEV }}>
  // @ts-nocheck
  // é–‹ç™ºç’°å¢ƒåˆ¤å®šï¼ˆAstroã®ãƒ“ãƒ«ãƒ‰æ™‚ã«ç½®æ›ã•ã‚Œã‚‹ï¼‰
  window.__DEV__ = isDev;
</script>

<script is:inline>
  // @ts-nocheck
  // é–‹ç™ºç’°å¢ƒã§ã®ã¿ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹é–¢æ•°
  const devLog = (...args) => {
    if (window.__DEV__) {
      console.log(...args);
    }
  };
  const devWarn = (...args) => {
    if (window.__DEV__) {
      console.warn(...args);
    }
  };
  const devError = (...args) => {
    // ã‚¨ãƒ©ãƒ¼ã¯å¸¸ã«å‡ºåŠ›ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã‚‚å¿…è¦ï¼‰
    console.error(...args);
  };

  // GSAPã¨ScrollTriggerã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤
  function initializeApp() {
    devLog("ğŸ” Initializing app...");

    // gsapã¨ScrollTriggerã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§åˆ©ç”¨å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦ã„ã¾ã™
    if (typeof gsap === "undefined") {
      devWarn("âš ï¸ GSAP not loaded yet, retrying in 100ms...");
      setTimeout(initializeApp, 100);
      return;
    }

    devLog("âœ… GSAP loaded successfully");

    if (typeof ScrollTrigger !== "undefined") {
      gsap.registerPlugin(ScrollTrigger);
      devLog("âœ… ScrollTrigger registered");
    }

    const buttonSound = new Audio("/sounds/buttonSound.mp3");

    function playSound() {
      const isSoundOn = localStorage.getItem("sound-enabled") === "true";

      if (isSoundOn) {
        try {
          buttonSound.currentTime = 0;
          void buttonSound.play();
        } catch (error) {
          devError("Sound playback failed:", error);
        }
      }
    }

    const tweens = [];

    function createTween(gsap, selector, props) {
      tweens.push(
        gsap.to(selector, {
          ...props,
          paused: true,
        })
      );
    }

    // ç”»é¢ã‚µã‚¤ã‚ºã¨ãƒ‡ãƒã‚¤ã‚¹ã«å¿œã˜ãŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
    const getAnimationSettings = () => {
      const screenWidth = window.innerWidth;
      const isMobile = screenWidth <= 768;
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isAndroid = /Android/.test(navigator.userAgent);

      let item4X;
      let item6X;

      if (isMobile) {
        if (isIOS) {
          // iPhone: ã¯ã¿å‡ºã—ã‚’é˜²ããŸã‚å°‘ã—å°ã•ã‚ã«èª¿æ•´
          item4X = 250;
          item6X = -250;
        } else if (isAndroid) {
          // Android: è¶³ã‚Šãªã„åˆ†ã‚’è£œã†ãŸã‚å°‘ã—å¤§ãã‚ã«èª¿æ•´
          item4X = 264;
          item6X = -264;
        } else {
          // ãã®ä»–ã®ãƒ‡ãƒã‚¤ã‚¹
          item4X = 254;
          item6X = -254;
        }
      } else {
        // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—
        item4X = 440;
        item6X = -440;
      }

      return [
        [".item-1", { y: 230, rotation: 720, duration: 1.2 }],
        [".item-2", { y: 230, rotation: 360, duration: 1.6 }],
        [".item-3", { y: 230, rotation: 720, duration: 2 }],
        [".item-4", { x: item4X, rotation: 360, duration: 2.3 }],
        [".item-5", { x: 0, rotation: 1080, duration: 2.6 }],
        [".item-6", { x: item6X, rotation: 360, duration: 2.3 }],
        [".item-7", { y: -230, rotation: 720, duration: 1.4 }],
        [".item-8", { y: -230, rotation: 360, duration: 1.8 }],
        [".item-9", { y: -230, rotation: 720, duration: 2.2 }],
        [".item-10", { y: -230, rotation: 720, duration: 1.4 }],
        [".item-11", { y: -230, rotation: 360, duration: 1.8 }],
        [".item-12", { y: -230, rotation: 720, duration: 2.2 }],
      ];
    };

    const animationSettings = getAnimationSettings();

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã‚’é©ç”¨
    animationSettings.forEach(([selector, props]) => createTween(gsap, selector, props));

    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã‚’å†ç”Ÿæˆ
    window.addEventListener("resize", () => {
      // æ—¢å­˜ã®tweenã‚’ã‚¯ãƒªã‚¢
      tweens.forEach((tween) => tween.kill());
      tweens.length = 0;

      // æ–°ã—ã„è¨­å®šã§tweenã‚’ä½œæˆ
      const newAnimationSettings = getAnimationSettings();
      newAnimationSettings.forEach(([selector, props]) => createTween(gsap, selector, props));
    });

    // restartãƒœã‚¿ãƒ³ã®å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆGSAPã‚’ä½¿ç”¨ï¼‰
    const rotateRestartButton = () => {
      const restartButton = document.getElementById("restart");
      if (!restartButton) return;

      gsap.fromTo(
        restartButton,
        {
          rotation: 0,
          scale: 1,
        },
        {
          rotation: 720,
          scale: 1.3,
          duration: 1.5,
          ease: "power2.inOut",
          onComplete: () => {
            gsap.set(restartButton, {
              clearProps: "rotation, scale",
            });
          },
        }
      );
    };

    let lastTriggeredSecond = null;

    const rotateRestartButtonTimeInterval = () => {
      setInterval(() => {
        const now = new Date();
        const seconds = now.getSeconds();

        if ((seconds === 0 || seconds === 30) && seconds !== lastTriggeredSecond) {
          rotateRestartButton();

          lastTriggeredSecond = seconds;
        } else if (seconds !== 0 && seconds !== 30) {
          lastTriggeredSecond = null;
        }
      }, 1000);
    };

    // æ™‚åˆ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
    rotateRestartButtonTimeInterval();

    function initButtonEvents() {
      function updateTooltipClassByPosition() {
        const item4 = document.querySelector(".item-4");
        const item6 = document.querySelector(".item-6");
        if (!item4 || !item6) return;

        const rect4 = item4.getBoundingClientRect();
        const rect6 = item6.getBoundingClientRect();

        const tooltip4 = item4.querySelector(".item__tooltip_left, .item__tooltip_right");
        const tooltip6 = item6.querySelector(".item__tooltip_left, .item__tooltip_right");

        if (tooltip4) {
          tooltip4.classList.remove("item__tooltip_left", "item__tooltip_right");
          tooltip4.classList.add(rect4.left < rect6.left ? "item__tooltip_left" : "item__tooltip_right");
        }

        if (tooltip6) {
          tooltip6.classList.remove("item__tooltip_left", "item__tooltip_right");
          tooltip6.classList.add(rect6.left < rect4.left ? "item__tooltip_left" : "item__tooltip_right");
        }
      }

      function playAll() {
        tweens.forEach((tween) => tween.play());
        updateTooltipClassByPosition();
        playSound();
      }
      function pauseAll() {
        tweens.forEach((tween) => tween.pause());
        updateTooltipClassByPosition();
        playSound();
      }
      function reverseAll() {
        tweens.forEach((tween) => tween.reverse());
        updateTooltipClassByPosition();
        playSound();
      }
      function restartAll() {
        tweens.forEach((tween) => tween.restart());
        updateTooltipClassByPosition();
        playSound();
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹ï¼ˆHTMLã®onclickå±æ€§ã‹ã‚‰å‘¼ã³å‡ºã™ãŸã‚ï¼‰
      window.playAll = playAll;
      window.pauseAll = pauseAll;
      window.reverseAll = reverseAll;
      window.restartAll = restartAll;

      document.getElementById("play")?.addEventListener("click", playAll);
      document.getElementById("pause")?.addEventListener("click", pauseAll);
      document.getElementById("reverse")?.addEventListener("click", reverseAll);
      document.getElementById("restart")?.addEventListener("click", restartAll);

      const controlMenu = document.querySelector(".control__menu");
      const buttons = document.querySelectorAll(".button");

      // å„ãƒœã‚¿ãƒ³ã®å›è»¢ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ç®¡ç†ã™ã‚‹Map
      const buttonRotationTimeouts = new Map();

      buttons.forEach((button) => {
        button.addEventListener("mouseenter", () => {
          // æ—¢å­˜ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
          const existingTimeout = buttonRotationTimeouts.get(button);
          if (existingTimeout) {
            clearTimeout(existingTimeout);
            buttonRotationTimeouts.delete(button);
          }

          button.classList.remove("reset-rotation");
          button.classList.add("is-rotating");

          // 3ç§’å¾Œã«è‡ªå‹•çš„ã«å›è»¢ã‚’åœæ­¢
          const timeoutId = setTimeout(() => {
            button.classList.remove("is-rotating");
            button.classList.add("reset-rotation");
            button.addEventListener(
              "transitionend",
              () => {
                button.classList.remove("reset-rotation");
              },
              {
                once: true,
              }
            );
            buttonRotationTimeouts.delete(button);
          }, 3000);

          buttonRotationTimeouts.set(button, timeoutId);
        });

        button.addEventListener("mouseleave", () => {
          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
          const timeoutId = buttonRotationTimeouts.get(button);
          if (timeoutId) {
            clearTimeout(timeoutId);
            buttonRotationTimeouts.delete(button);
          }

          button.classList.remove("is-rotating");
        });
      });

      controlMenu?.addEventListener("mouseleave", () => {
        buttons.forEach((button) => {
          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
          const timeoutId = buttonRotationTimeouts.get(button);
          if (timeoutId) {
            clearTimeout(timeoutId);
            buttonRotationTimeouts.delete(button);
          }

          button.classList.remove("is-rotating");
          button.classList.add("reset-rotation");
          button.addEventListener(
            "transitionend",
            () => {
              button.classList.remove("reset-rotation");
            },
            {
              once: true,
            }
          );
        });
      });
    }

    // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã®åˆæœŸåŒ–
    initButtonEvents();
  } // initializeApp() ã®çµ‚ã‚ã‚Š

  // GSAPãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰åˆæœŸåŒ–ã‚’é–‹å§‹
  function waitForGSAPAndInit() {
    if (typeof gsap !== "undefined" && typeof ScrollTrigger !== "undefined") {
      devLog("âœ… GSAP and ScrollTrigger are ready, initializing app...");
      if (document.readyState === "loading") {
        devLog("ğŸ” Document still loading, waiting for DOMContentLoaded...");
        document.addEventListener("DOMContentLoaded", initializeApp);
      } else {
        devLog("ğŸ” Document already loaded, initializing immediately...");
        initializeApp();
      }
    } else {
      devLog("â³ Waiting for GSAP to load...");
      setTimeout(waitForGSAPAndInit, 100);
    }
  }

  // window.onloadã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  window.addEventListener("load", () => {
    devLog("ğŸ” Window load event fired");
    waitForGSAPAndInit();
  });

  // å³åº§ã«ã‚‚è©¦è¡Œï¼ˆæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
  waitForGSAPAndInit();
</script>

<script is:inline>
  // @ts-nocheck
  // JSConfettiã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§åˆ©ç”¨å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦ã„ã¾ã™

  function initConfetti() {
    const confetti = document.getElementById("confettiButton");
    const canvasElement = document.getElementById("canvas");
    const textCanvasElement = document.getElementById("confetti-text-canvas");

    if (canvasElement instanceof HTMLCanvasElement && textCanvasElement instanceof HTMLCanvasElement) {
      const devicePixelRatio = window.devicePixelRatio ?? 1;

      const rect = canvasElement.getBoundingClientRect();
      canvasElement.width = rect.width * devicePixelRatio;
      canvasElement.height = rect.height * devicePixelRatio;

      const textRect = textCanvasElement.getBoundingClientRect();
      textCanvasElement.width = textRect.width * devicePixelRatio;
      textCanvasElement.height = textRect.height * devicePixelRatio;

      const jsConfetti = new JSConfetti({ canvas: canvasElement });
      const context = textCanvasElement.getContext("2d");

      if (context) {
        let isAnimating = false;
        let currentOpacity = 0;

        const drawText = (opacity = 1) => {
          context.clearRect(0, 0, textCanvasElement.width, textCanvasElement.height);
          context.globalAlpha = opacity;
          currentOpacity = opacity;

          const screenWidth = window.innerWidth;
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isAndroid = /Android/.test(navigator.userAgent);

          let fontSize;

          if (screenWidth <= 480) {
            if (isIOS) {
              fontSize = 44;
            } else if (isAndroid) {
              fontSize = 44;
            } else {
              fontSize = 40;
            }
          } else if (screenWidth <= 768) {
            fontSize = 48;
          } else {
            fontSize = 20;
          }

          context.font = `${fontSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
          context.fillStyle = "#00FFFF"; // aquaã‚«ãƒ©ãƒ¼
          context.textAlign = "center";
          context.textBaseline = "middle";

          const text = "Thank you for viewing my portfolio site!";
          const maxWidth = textCanvasElement.width * 0.9;
          const textMetrics = context.measureText(text);

          if (textMetrics.width > maxWidth) {
            const ratio = maxWidth / textMetrics.width;
            const minFontSize = screenWidth > 768 ? 28 : 28;
            fontSize = Math.max(minFontSize, fontSize * ratio);
            context.font = `${fontSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
          }

          // ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»ï¼ˆfillStyleã‚’å†è¨­å®šã—ã¦ç¢ºå®Ÿã«aquaã‚«ãƒ©ãƒ¼ã‚’é©ç”¨ï¼‰
          context.fillStyle = "#00FFFF"; // aquaã‚«ãƒ©ãƒ¼
          const centerX = textCanvasElement.width / 2;
          const centerY = textCanvasElement.height / 2;
          context.fillText(text, centerX, centerY);
        };

        window.addEventListener("resize", () => {
          const newDevicePixelRatio = window.devicePixelRatio ?? 1;

          const rect = canvasElement.getBoundingClientRect();
          canvasElement.width = rect.width * newDevicePixelRatio;
          canvasElement.height = rect.height * newDevicePixelRatio;

          const textRect = textCanvasElement.getBoundingClientRect();
          textCanvasElement.width = textRect.width * newDevicePixelRatio;
          textCanvasElement.height = textRect.height * newDevicePixelRatio;

          if (isAnimating && currentOpacity > 0) {
            drawText(currentOpacity);
          } else if (!isAnimating && currentOpacity > 0) {
            drawText();
          }
        });

        if (confetti) {
          // console.log("Adding click listener to confetti button");
          confetti.addEventListener("click", () => {
            // console.log("Confetti button clicked!");

            context.clearRect(0, 0, textCanvasElement.width, textCanvasElement.height);
            currentOpacity = 0;
            isAnimating = true;

            jsConfetti
              .addConfetti({
                emojis: ["ğŸ’œ", "ğŸ’–", "ğŸŒˆ", "âœ¨", "ğŸ’«", "ğŸŒ¸", "thanks", "ğŸ’›", "ğŸ’—", "ğŸ’˜", "ğŸŒŸ", "happy"],
              })
              .then(() => jsConfetti.addConfetti({ confettiRadius: 3 }))
              .then(() => {
                let opacity = 0;
                const fadeIn = setInterval(() => {
                  if (opacity < 1) {
                    opacity += 0.05;
                    drawText(opacity);
                  } else {
                    clearInterval(fadeIn);

                    setTimeout(() => {
                      let fadeOpacity = 1;
                      const fadeOut = setInterval(() => {
                        if (fadeOpacity > 0) {
                          fadeOpacity -= 0.05;
                          drawText(fadeOpacity);
                        } else {
                          clearInterval(fadeOut);
                          context.clearRect(0, 0, textCanvasElement.width, textCanvasElement.height);
                          currentOpacity = 0;
                          isAnimating = false;
                        }
                      }, 50);
                    }, 3000);
                  }
                }, 50);
              })
              .catch((error) => {
                devError("Confetti animation failed:", error);
                isAnimating = false;
              });
          });
        } else {
          devError("confettiButton element not found!");
        }
      }
    } else {
      if (!canvasElement) {
        devError("Full-screen canvas element (#canvas) not found!");
      }
      if (!textCanvasElement) {
        devError("Text canvas element (#confetti-text-canvas) not found!");
      }
    }
  }

  // JSConfettiãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰åˆæœŸåŒ–
  function waitForJSConfettiAndInit() {
    if (typeof JSConfetti !== "undefined") {
      devLog("âœ… JSConfetti is ready, initializing confetti...");
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initConfetti);
      } else {
        initConfetti();
      }
    } else {
      devLog("â³ Waiting for JSConfetti to load...");
      setTimeout(waitForJSConfettiAndInit, 100);
    }
  }

  // window.onloadã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  window.addEventListener("load", () => {
    waitForJSConfettiAndInit();
  });

  // å³åº§ã«ã‚‚è©¦è¡Œï¼ˆæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
  waitForJSConfettiAndInit();
</script>
