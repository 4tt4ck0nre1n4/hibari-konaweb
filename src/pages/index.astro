---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Logo from "../components/Logo.astro";
import Breadcrumbs from "../components/Breadcrumbs.astro";
import Aside from "../components/Aside.astro";
import ResponsiveFv from "../components/ResponsiveFv.astro";
import GridRive from "../components/GridRive.astro";
import GridSvg from "../components/GridSvg.astro";
import gridText from "../data/gridText.json";
import SafeIcon from "../components/SafeIcon.astro";
import SwiperMenu from "../components/SwiperMenu.astro";
import { hrefLink } from "../scripts/constLinks";
import globalText from "../data/globalText.json";
import SwiperDisplay from "../components/SwiperDisplay.astro";
import { play, pause, reverse, restart } from "../scripts/constButton";
import AboutCat from "../assets/svg/aboutCat.svg";
import blogCat from "../assets/svg/blogCat.svg";
import sodenoura from "../assets/svg/sodenoura.svg";
import gaura from "../assets/svg/gauraStudio.svg";
import pikucha from "../assets/svg/pikucha.svg";
import sodenoura2 from "../assets/svg/sodenoura2.svg";
import gaura2 from "../assets/svg/gauraStudio2.svg";
import pikucha2 from "../assets/svg/pikucha2.svg";
import contactCat from "../assets/svg/contact_cat.svg";
import backgroundImageSrc from "../assets/background.webp";
import { getImage } from "astro:assets";

const backgroundImage = await getImage({ src: backgroundImageSrc });
const portfolioRiv = "/riv/my-portfolio.riv";
const welcomeRiv = "/riv/working-office.riv";
const webDesignerRiv = "/riv/designer-life.riv";
---

<Layout
  title={globalText.top.title}
  description={globalText.top.description}
  ogType={globalText.og.type}
  ogTitle={globalText.top.title}
  ogDescription={globalText.top.description}
  twitterTitle={globalText.top.title}
  twitterDescription={globalText.top.description}
>
  <!-- LCPèƒŒæ™¯ç”»åƒã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆPageSpeed Insightsæœ€é©åŒ–ï¼‰ -->
  <link slot="head" rel="preload" href={backgroundImage.src} as="image" fetchpriority="high" />

  <div id="outer-container">
    <Header />
    <main id="page-wrap">
      <Logo />
      <div class="breadcrumbs__wrapper breadcrumbs__wrapper_top">
        <Breadcrumbs crumbs={[]} />
      </div>
      <div id="main-container" style={`background-image: url(${backgroundImage.src})`}>
        <ResponsiveFv />
        <aside class="toolbar">
          <Aside />
        </aside>
        <div id="js-grid" class="grid">
          <div class="wrapper">
            <ul id="js-grid__menu" class="grid__menu">
              <GridSvg
                className="item-1"
                href={hrefLink.about}
                ariaLabel={gridText.gridItem1.ariaLabel}
                ariaTitle={gridText.gridItem1.ariaTitle}
                imageSrc={AboutCat}
                imageMeta={gridText.gridItem1.Alt}
                tooltipText={gridText.gridItem1.tooltipText}
                tooltipPosition={gridText.gridItem1.tooltipPosition}
              />
              <GridSvg
                className="item-2"
                href={hrefLink.blog}
                ariaLabel={gridText.gridItem2.ariaLabel}
                ariaTitle={gridText.gridItem2.ariaTitle}
                imageSrc={blogCat}
                imageMeta={gridText.gridItem2.Alt}
                tooltipText={gridText.gridItem2.tooltipText}
                tooltipPosition={gridText.gridItem2.tooltipPosition}
              />
              <GridSvg
                className="item-3"
                href={hrefLink.contact}
                ariaLabel={gridText.gridItem3.ariaLabel}
                ariaTitle={gridText.gridItem3.ariaTitle}
                imageSrc={contactCat}
                imageMeta={gridText.gridItem3.Alt}
                stateMachines="State Machine 1"
                tooltipText={gridText.gridItem3.tooltipText}
                tooltipPosition={gridText.gridItem3.tooltipPosition}
              />
              <GridRive
                className="item-4"
                href={hrefLink.works}
                ariaLabel={gridText.gridItem4.ariaLabel}
                ariaTitle={gridText.gridItem4.ariaTitle}
                src={portfolioRiv}
                stateMachines="State Machine 1"
                tooltipText={gridText.gridItem4.tooltipText}
                tooltipPosition={gridText.gridItem4.tooltipPosition}
              />
              <GridRive
                className="item-5"
                href={hrefLink.home}
                ariaLabel={gridText.gridItem5.ariaLabel}
                ariaTitle={gridText.gridItem5.ariaTitle}
                src={welcomeRiv}
                stateMachines="State Machine 1"
                tooltipText={gridText.gridItem5.tooltipText}
                tooltipPosition={gridText.gridItem5.tooltipPosition}
              />
              <GridRive
                className="item-6"
                href={hrefLink.works}
                ariaLabel={gridText.gridItem6.ariaLabel}
                ariaTitle={gridText.gridItem6.ariaTitle}
                src={webDesignerRiv}
                stateMachines="State Machine 1"
                tooltipText={gridText.gridItem6.tooltipText}
                tooltipPosition={gridText.gridItem6.tooltipPosition}
              />
              <GridSvg
                className="item-7 logoSvg-visible"
                href={hrefLink.work1}
                ariaLabel={gridText.gridItem7.ariaLabel}
                ariaTitle={gridText.gridItem7.ariaTitle}
                imageSrc={sodenoura}
                imageMeta={gridText.gridItem7.Alt}
                tooltipText={gridText.gridItem7.tooltipText}
                tooltipPosition={gridText.gridItem7.tooltipPosition}
              />
              <GridSvg
                className="item-8  logoSvg-visible"
                href={hrefLink.work2}
                ariaLabel={gridText.gridItem8.ariaLabel}
                ariaTitle={gridText.gridItem8.ariaTitle}
                imageSrc={gaura}
                imageMeta={gridText.gridItem8.Alt}
                tooltipText={gridText.gridItem8.tooltipText}
                tooltipPosition={gridText.gridItem8.tooltipPosition}
              />
              <GridSvg
                className="item-9  logoSvg-visible"
                href={hrefLink.work3}
                ariaLabel={gridText.gridItem9.ariaLabel}
                ariaTitle={gridText.gridItem9.ariaTitle}
                imageSrc={pikucha}
                imageMeta={gridText.gridItem9.Alt}
                tooltipText={gridText.gridItem9.tooltipText}
                tooltipPosition={gridText.gridItem9.tooltipPosition}
              />
              <GridSvg
                className="item-10 logoSvg-hidden"
                href={hrefLink.work1}
                ariaLabel={gridText.gridItem10.ariaLabel}
                ariaTitle={gridText.gridItem10.ariaTitle}
                imageSrc={sodenoura2}
                imageMeta={gridText.gridItem10.Alt}
                tooltipText={gridText.gridItem10.tooltipText}
                tooltipPosition={gridText.gridItem10.tooltipPosition}
              />
              <GridSvg
                className="item-11 logoSvg-hidden"
                href={hrefLink.work2}
                ariaLabel={gridText.gridItem11.ariaLabel}
                ariaTitle={gridText.gridItem11.ariaTitle}
                imageSrc={gaura2}
                imageMeta={gridText.gridItem11.Alt}
                tooltipText={gridText.gridItem11.tooltipText}
                tooltipPosition={gridText.gridItem11.tooltipPosition}
              />
              <GridSvg
                className="item-12 logoSvg-hidden"
                href={hrefLink.work3}
                ariaLabel={gridText.gridItem12.ariaLabel}
                ariaTitle={gridText.gridItem12.ariaTitle}
                imageSrc={pikucha2}
                imageMeta={gridText.gridItem12.Alt}
                tooltipText={gridText.gridItem12.tooltipText}
                tooltipPosition={gridText.gridItem12.tooltipPosition}
              />
            </ul>
            <ul class="control__menu">
              <li class="control__menu_item">
                <button
                  id="play"
                  class="button"
                  type="button"
                  onclick="playAll()"
                  aria-label={gridText.play}
                  title={gridText.play}
                >
                  <SafeIcon class="button__image" name={play.icon} />
                </button>
              </li>
              <li>
                <button
                  id="pause"
                  class="button"
                  type="button"
                  onclick="pauseAll()"
                  aria-label={gridText.pause}
                  title={gridText.pause}
                >
                  <SafeIcon class="button__image" name={pause.icon} />
                </button>
              </li>
              <li>
                <button
                  id="reverse"
                  class="button"
                  type="button"
                  onclick="reverseAll()"
                  aria-label={gridText.reverse}
                  title={gridText.reverse}
                >
                  <SafeIcon class="button__image" name={reverse.icon} />
                </button>
              </li>
              <li>
                <button
                  id="restart"
                  class="button"
                  type="button"
                  onclick="restartAll()"
                  aria-label={gridText.restart}
                  title={gridText.restart}
                >
                  <SafeIcon class="button__image" name={restart.icon} />
                </button>
              </li>
            </ul>
          </div>
        </div>
        <div class="sidebar">
          <SwiperMenu />
        </div>
      </div>

      <div class="swiper-display-container">
        <SwiperDisplay />
      </div>
    </main>
    <Footer />
    <canvas id="canvas" class="canvas"></canvas>
  </div>
</Layout>

<script>
  import JSConfetti from "js-confetti";

  function initConfetti() {
    console.log("initConfetti called");
    const confetti: HTMLElement | null = document.getElementById("confettiButton");
    const canvasElement = document.getElementById("canvas");
    const textCanvasElement = document.getElementById("confetti-text-canvas");

    console.log("confettiButton:", confetti);
    console.log("canvas:", canvasElement);
    console.log("textCanvas:", textCanvasElement);

    if (canvasElement instanceof HTMLCanvasElement && textCanvasElement instanceof HTMLCanvasElement) {
      console.log("Canvas elements found, initializing...");
      const devicePixelRatio = window.devicePixelRatio ?? 1;

      const rect = canvasElement.getBoundingClientRect();
      canvasElement.width = rect.width * devicePixelRatio;
      canvasElement.height = rect.height * devicePixelRatio;

      const textRect = textCanvasElement.getBoundingClientRect();
      textCanvasElement.width = textRect.width * devicePixelRatio;
      textCanvasElement.height = textRect.height * devicePixelRatio;

      const jsConfetti = new JSConfetti({ canvas: canvasElement });
      const context = textCanvasElement.getContext("2d");

      if (context) {
        let isAnimating = false;
        let currentOpacity = 0;

        const drawText = (opacity: number = 1) => {
          context.clearRect(0, 0, textCanvasElement.width, textCanvasElement.height);
          context.globalAlpha = opacity;
          currentOpacity = opacity;

          const screenWidth = window.innerWidth;
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const isAndroid = /Android/.test(navigator.userAgent);

          let fontSize: number;

          if (screenWidth <= 480) {
            if (isIOS) {
              fontSize = 44;
            } else if (isAndroid) {
              fontSize = 44;
            } else {
              fontSize = 40;
            }
          } else if (screenWidth <= 768) {
            fontSize = 48;
          } else {
            fontSize = 20;
          }

          context.font = `${fontSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
          const isDarkMode = document.documentElement.classList.contains("dark");
          context.fillStyle = isDarkMode ? "#f1f5f9" : "#020202";
          context.textAlign = "center";
          context.textBaseline = "middle";

          context.shadowColor = isDarkMode ? "rgba(0, 0, 0, 0.8)" : "rgba(255, 255, 255, 0.8)";
          context.shadowBlur = 2;
          context.shadowOffsetX = 1;
          context.shadowOffsetY = 1;

          const text = "Thank you for viewing my portfolio site!";
          const maxWidth = textCanvasElement.width * 0.9;
          const textMetrics = context.measureText(text);

          if (textMetrics.width > maxWidth) {
            const ratio = maxWidth / textMetrics.width;
            const minFontSize = screenWidth > 768 ? 28 : 28;
            fontSize = Math.max(minFontSize, fontSize * ratio);
            context.font = `${fontSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
          }

          context.fillText(text, textCanvasElement.width / 2, textCanvasElement.height / 2);

          context.shadowColor = "transparent";
          context.shadowBlur = 0;
          context.shadowOffsetX = 0;
          context.shadowOffsetY = 0;
        };

        window.addEventListener("resize", () => {
          const newDevicePixelRatio = window.devicePixelRatio ?? 1;

          const rect = canvasElement.getBoundingClientRect();
          canvasElement.width = rect.width * newDevicePixelRatio;
          canvasElement.height = rect.height * newDevicePixelRatio;

          const textRect = textCanvasElement.getBoundingClientRect();
          textCanvasElement.width = textRect.width * newDevicePixelRatio;
          textCanvasElement.height = textRect.height * newDevicePixelRatio;

          if (isAnimating && currentOpacity > 0) {
            drawText(currentOpacity);
          } else if (!isAnimating && currentOpacity > 0) {
            drawText();
          }
        });

        if (confetti) {
          console.log("Adding click listener to confetti button");
          confetti.addEventListener("click", () => {
            console.log("Confetti button clicked!");

            context.clearRect(0, 0, textCanvasElement.width, textCanvasElement.height);
            currentOpacity = 0;
            isAnimating = true;

            jsConfetti
              .addConfetti({
                emojis: ["ğŸ’œ", "ğŸ’–", "ğŸŒˆ", "âœ¨", "ğŸ’«", "ğŸŒ¸", "thanks", "ğŸ’›", "ğŸ’—", "ğŸ’˜", "ğŸŒŸ", "happy"],
              })
              .then(() => jsConfetti.addConfetti({ confettiRadius: 3 }))
              .then(() => {
                let opacity = 0;
                const fadeIn = setInterval(() => {
                  if (opacity < 1) {
                    opacity += 0.05;
                    drawText(opacity);
                  } else {
                    clearInterval(fadeIn);

                    setTimeout(() => {
                      let fadeOpacity = 1;
                      const fadeOut = setInterval(() => {
                        if (fadeOpacity > 0) {
                          fadeOpacity -= 0.05;
                          drawText(fadeOpacity);
                        } else {
                          clearInterval(fadeOut);
                          context.clearRect(0, 0, textCanvasElement.width, textCanvasElement.height);
                          currentOpacity = 0;
                          isAnimating = false;
                        }
                      }, 50);
                    }, 3000);
                  }
                }, 50);
              })
              .catch((error) => {
                console.error("Confetti animation failed:", error);
                isAnimating = false;
              });
          });
        } else {
          console.error("confettiButton element not found!");
        }
      }
    } else {
      if (!canvasElement) {
        console.error("Full-screen canvas element (#canvas) not found!");
      }
      if (!textCanvasElement) {
        console.error("Text canvas element (#confetti-text-canvas) not found!");
      }
    }
  }

  // ã‚ˆã‚Šç¢ºå®ŸãªåˆæœŸåŒ–æ–¹æ³•
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initConfetti);
  } else {
    // DOMæ—¢ã«ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ã®å ´åˆã¯å³åº§ã«å®Ÿè¡Œ
    initConfetti();
  }
</script>

<style is:global>
  /* ResponsiveFvã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è¡¨ç¤ºåˆ¶å¾¡ */
  .responsive-fv {
    display: none;
  }

  #main-container {
    display: grid;
    grid-template-columns: 24% 50% 24%;
    gap: 1%;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    position: relative;
    padding-block: 1.5rem;
    min-height: 600px; /* CLSã‚’é˜²ããŸã‚ã«æœ€å°é«˜ã•ã‚’è¨­å®š */
  }

  .toolbar {
    min-height: 400px; /* CLSã‚’é˜²ããŸã‚ã«æœ€å°é«˜ã•ã‚’è¨­å®š */
  }

  .sidebar {
    min-height: 400px; /* CLSã‚’é˜²ããŸã‚ã«æœ€å°é«˜ã•ã‚’è¨­å®š */
  }

  /* ã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºã§ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  @media screen and (max-width: 768px) {
    .responsive-fv {
      display: block;
      order: 1;
      width: 100%;
      margin-bottom: 0.5rem;
    }
    #main-container {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding-block: 1rem;
      padding-inline: 1rem;
      min-height: auto;
    }

    .toolbar {
      order: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      min-height: auto;
    }

    .grid {
      order: 4;
      width: 100%;
      height: auto;
      min-height: auto;
    }

    .sidebar {
      order: 3;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-height: auto;
    }

    .swiper-display-container {
      order: 5;
      width: 100%;
      margin-bottom: 0.5rem;
    }

    .grid__menu {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }

    .control__menu {
      flex-direction: row;
      justify-content: center;
      gap: 0.5rem;
    }
  }

  /* 480pxä»¥ä¸‹ã§ã®è¶…å°å‹ã‚¹ãƒãƒ›æœ€é©åŒ– */
  @media screen and (max-width: 480px) {
    #main-container {
      padding-inline: 0.5rem;
      gap: 0.5rem;
      min-height: auto;
    }

    .toolbar {
      grid-template-columns: 1fr;
      gap: 0.25rem;
      min-height: auto;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      margin-block-end: 0;
      gap: 0.35rem;
      min-height: auto;
    }

    .grid {
      margin-block-start: 1rem; /* ã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºã§ã®ä½™ç™½èª¿æ•´ */
    }

    .grid__menu {
      grid-template-columns: 1fr;
      gap: 0.25rem;
    }

    .control__menu {
      flex-direction: row;
      gap: 0.25rem;
      padding-inline: 1rem;
    }
  }
  #main-container.is-notImage {
    background-image: none !important;
    background-color: transparent !important;
  }
  .is-notImage {
    transition: background 2s ease-in-out;
  }
  .toolbar {
    /* grid-area: 1 / 1 / 2 / 2; */
    /* grid-area: 1 / 1 / 1 / 1; */
    display: flex;
    flex-direction: column;
    row-gap: 0.75rem;
    color: inherit;
    position: relative;
  }
  .grid {
    grid-area: 1 / 2 / 2 / 3;
    width: 100%;
    height: 100%;
    position: relative;
    background-color: transparent;
    transition:
      5s height ease-out,
      5s opacity ease-out;
  }
  .canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: transparent;
    pointer-events: none;
    z-index: 9999;
  }
  .wrapper {
    width: 100%;
    max-width: 700px;
    margin-inline: auto;
  }
  .grid__menu {
    width: 100%;
    height: 100%;
    min-height: 408px; /* CLSå¯¾ç­–: ã‚°ãƒªãƒƒãƒ‰ã‚¢ã‚¤ãƒ†ãƒ (100px x 4è¡Œ) + gap + padding */
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-gap: 1rem;
    justify-items: center;
    list-style: none;
    box-shadow: 0 8px 16px rgba(0 0 0 / 0.6);
    border-radius: 8%;
    position: relative;
    z-index: 1;
    overflow: hidden;
    padding-block: 2rem;
    transform-origin: center;
    /* transform-style: preserve-3d;
    transform: perspective(1600px); */
    transition: box-shadow 0.4s ease;
  }
  .grid__menu:is(:hover, :focus-visible) {
    box-shadow: 0 16px 8px rgba(0 0 0 / 0.6);
  }
  html.dark .grid__menu:is(:hover, :focus-visible) {
    box-shadow: 0 16px 8px rgba(255 255 255 / 0.6);
  }
  .grid__menu::before {
    content: "";
    width: 100%;
    max-width: 560px;
    height: 100%;
    max-height: 480px;
    display: block;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(236, 159, 255, 1),
      #ffffff71,
      rgba(147, 183, 255, 1),
      #ffffff71,
      rgba(170, 244, 254, 1),
      transparent
    );
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
    transform: translateX(-200px) skew(-16deg);
    animation: shineGrid 6s linear infinite;
  }
  @keyframes shineGrid {
    0% {
      transform: translateX(-200px) skew(-16deg);
      opacity: 0;
    }
    8% {
      opacity: 1;
    }
    48% {
      transform: translateX(200px) skew(-16deg);
      opacity: 0.9;
    }
    56% {
      opacity: 0.3;
    }
    100% {
      transform: translateX(-200px) skew(-16deg);
      opacity: 0;
    }
  }
  .grid__menu_item {
    width: 100px;
    height: 100px;
    border-radius: 0.625rem;
    box-shadow: 0 8px 16px rgba(0 0 0 / 0.6);
    position: relative;
  }
  .grid__menu_item:is(:hover, :focus-visible) {
    background: transparent;
  }
  .grid__menu_item .grid__menu_link {
    display: block;
  }
  .grid__menu_item .grid__menu_link::before {
    position: absolute;
    content: "";
    transform: scale(0);
    opacity: 0;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
  }
  .grid__menu_item .grid__menu_svg {
    width: 100%;
    height: 100%;
    aspect-ratio: 1 / 1;
    overflow: hidden;
    /* perspective: 1000px; */
    transition: transform 0.4s ease;
  }
  .item-1,
  .item-2,
  .item-3 {
    background: #ffffff;
  }
  .item-7,
  .item-8,
  .item-9 {
    background: transparent;
  }
  .grid__menu_item .grid__menu_svg:is(:hover, :focus-visible) {
    /* border-radius: 100%; */
    transform: scale(1.1);
  }

  .grid__menu_svg img {
    width: 100%;
    height: 100%;
    border-radius: 0.625rem;
    object-fit: contain;
    image-rendering: high-quality;
    image-rendering: -webkit-optimize-contrast;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  .grid__menu_item:not(.item-4, .item-5, .item-6) .grid__menu_svg {
    /* background: transparent; */
    box-shadow: 0 0 0 rgba(0 0 0 / 0.1);
    animation: translateGridImage 20s linear infinite;
    animation-play-state: running;
  }
  .grid__menu_item:not(.item-4, .item-5, .item-6):is(:hover, :focus-visible) .grid__menu_svg {
    animation-play-state: paused;
    box-shadow: 0 12px 12px rgba(0 0 0 / 0.6);
    border-radius: 0.5rem;
    transition:
      border-radius 0.4s ease,
      box-shadow 0.4s ease;
  }
  @keyframes translateGridImage {
    0% {
      transform: translateY(0);
    }
    25% {
      transform: translateY(-8px);
    }
    50% {
      transform: translateY(0);
    }
    75% {
      transform: translateY(8px);
    }
    100% {
      transform: translateY(0);
    }
  }
  .item__tooltip_right {
    font-size: 0.875rem;
    color: #010101;
    background-color: #fff;
    item-shadow: 0px 10px 20px rgba(0, 0, 0, 0.6);
    white-space: nowrap;
    border: #ccc 1px solid;
    border-radius: 0.625rem;
    pointer-events: none;
    position: absolute;
    bottom: -10%;
    left: 120%;
    opacity: 0;
    transform: translateX(-50%);
    transition: opacity 0.3s ease;
    padding: 0.5rem;
  }
  .item__tooltip_left {
    font-size: 0.875rem;
    color: #010101;
    background-color: #fff;
    item-shadow: 0px 10px 20px rgba(0, 0, 0, 0.6);
    white-space: nowrap;
    border: #ccc 1px solid;
    border-radius: 0.625rem;
    pointer-events: none;
    position: absolute;
    bottom: -10%;
    left: -25%;
    opacity: 0;
    transform: translateX(-50%);
    transition: opacity 0.3s ease;
    padding: 0.5rem;
  }
  .item__tooltip_right::before {
    display: inline-block;
    content: "";
    border: transparent 12px solid;
    border-left: #fff 12px solid;
    position: absolute;
    bottom: 68%;
    right: 36%;
  }
  .item__tooltip_left::before {
    display: inline-block;
    content: "";
    border: transparent 12px solid;
    border-right: #fff 12px solid;
    position: absolute;
    bottom: 68%;
    left: 36%;
  }
  .control__menu {
    display: flex;
    justify-content: center;
    align-items: center;
    background: transparent;
    list-style: none;
    box-shadow: 0 8px 16px rgba(0 0 0 / 0.6);
    border-radius: 1rem;
    position: relative;
    z-index: 1;
    overflow: hidden;
    margin-block-start: 1rem;
    padding-block: 1rem;
    padding-inline: 3rem;
    transition: all 0.3s ease-in;
  }
  .control__menu:is(:hover, :focus-visible) {
    box-shadow: 0 16px 8px rgba(0 0 0 / 0.6);
  }
  html.dark .control__menu:is(:hover, :focus-visible) {
    box-shadow: 0 16px 8px rgba(255 255 255 / 0.6);
  }
  .control__menu::before {
    content: "";
    width: 100%;
    max-width: 560px;
    height: 100%;
    max-height: 120px;
    display: block;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(236, 159, 255, 1),
      #ffffff71,
      rgba(147, 183, 255, 1),
      #ffffff71,
      rgba(170, 244, 254, 1),
      transparent
    );
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1;
    transform: translateX(-200px) skew(-16deg);
    animation: shineController 6s linear infinite;
    animation-delay: 0.6s;
  }
  @keyframes shineController {
    0% {
      transform: translateX(-200px) skew(-16deg);
      opacity: 0;
    }
    16% {
      opacity: 1;
    }
    48% {
      transform: translateX(200px) skew(-16deg);
      opacity: 0.9;
    }
    56% {
      opacity: 0.3;
    }
    100% {
      transform: translateX(-200px) skew(-16deg);
      opacity: 0;
    }
  }
  .button {
    display: block;
    width: 60px;
    height: 60px;
    background: linear-gradient(180deg, rgba(0, 19, 172, 1) 0%, rgba(100, 255, 209, 1) 55%, rgba(43, 255, 152, 1) 100%);
    background: linear-gradient(
      135deg,
      rgba(236, 159, 255, 1) 30%,
      rgba(147, 183, 255, 1) 55%,
      rgba(170, 244, 254, 1) 78%
    );
    box-shadow: 0 18px 20px rgba(0 0 0 / 0.6);
    border: #fff 1px solid;
    border-radius: 0.675rem;
    overflow: hidden;
    aspect-ratio: 1 / 1;
    top: 1px;
    transform: rotate(0deg);
    transition:
      transform 0.1s ease,
      top 0.2s cubic-bezier(0.22, 1, 0.36, 1),
      border-radius 0.3s ease,
      box-shadow 0.6s ease;
    margin-inline: 1rem;
    padding: 0.5rem;
  }
  @media screen and (max-width: 480px) and (-webkit-min-device-pixel-ratio: 2) {
    .grid__menu {
      padding-inline: 0.5rem;
    }
    .button {
      margin-inline: 0.25rem;
    }
  }
  .button.is-rotating {
    background: linear-gradient(
      45deg,
      rgba(236, 159, 255, 1) 30%,
      rgba(147, 183, 255, 1) 55%,
      rgba(170, 244, 254, 1) 78%
    );
    top: -10px;
    border-radius: 50%;
    box-shadow:
      1px 2px 4px 0 var(--clay-box-shadow),
      2px 4px 8px 0 var(--clay-box-shadow),
      inset 2px 2px 8px var(--outset-shadow),
      inset -2px -2px 8px var(--inset-shadow);
    animation: rotateButton 2.5s linear infinite;
  }
  .button.reset-rotation {
    animation: none;
    transition: transform 0.6s ease;
    transform: rotate(0deg);
  }
  @keyframes rotateButton {
    to {
      transform: rotate(360deg);
    }
  }
  .button:active {
    transform: scale(0.8);
    box-shadow: 0 8px 8px rgba(0 0 0 / 0.4);
  }
  .button__image {
    width: 40px;
    height: 40px;
    object-fit: cover;
  }

  #play svg,
  #pause svg,
  #reverse svg,
  #restart svg {
    color: rgb(255, 255, 255);
    fill: rgb(255, 255, 255);
  }

  .sidebar {
    grid-area: 1 / 3 / 2 / 4;
    display: grid;
  }
  /* .particles-container {
    width: 100%;
    height: 200px;
    border: rebeccapurple 1px solid;
    position: relative;
  } */
  #tsparticles {
    width: 100%;
    height: 500px;
    display: block;
  }
</style>

<script>
  const buttonSound = new Audio("/sounds/buttonSound.mp3");

  function playSound() {
    const isSoundOn = localStorage.getItem("sound-enabled") === "true";

    if (isSoundOn) {
      try {
        buttonSound.currentTime = 0;
        void buttonSound.play();
      } catch (error) {
        console.error("Sound playback failed:", error);
      }
    }
  }

  const tweens: gsap.core.Tween[] = [];

  function createTween(gsap: any, selector: string, props: gsap.TweenVars) {
    tweens.push(
      gsap.to(selector, {
        ...props,
        paused: true,
      })
    );
  }

  // GSAPã‚’å‹•çš„ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
  // ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã«ãªã£ã¦ã‹ã‚‰èª­ã¿è¾¼ã‚€
  const initGSAP = async () => {
    const [{ gsap }, { ScrollTrigger }] = await Promise.all([import("gsap"), import("gsap/ScrollTrigger")]);

    gsap.registerPlugin(ScrollTrigger);

    // åˆæœŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ï¼ˆCLSå¯¾ç­–ï¼‰
    // gsap
    //   .timeline()
    //   .from(grid, {
    //     scale: 0.4,
    //     duration: 1,
    //     ease: "power1.in",
    //   })
    //   .from(
    //     gridMenu,
    //     {
    //       y: -200,
    //       duration: 1,
    //       ease: "power1.inOut",
    //     },
    //     "-=0.3"
    //   );

    // Astroè¦ç´ ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const pageContainer: HTMLElement | null = document.getElementById("page-wrap");
    const astroElement: HTMLElement | null = document.querySelector(".astro-a");

    if (astroElement && pageContainer) {
      gsap.to(astroElement, {
        y: () => pageContainer.offsetHeight * 0.2,
        ease: "power1.out",
        scrollTrigger: {
          trigger: pageContainer,
          start: "top top",
          end: "center end",
          scrub: true,
        },
      });
    }

    // Tooltipã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    document.querySelectorAll(".grid__menu_item").forEach((item) => {
      const tooltipRight = item.querySelector(".item__tooltip_right") as HTMLElement;
      const tooltipLeft = item.querySelector(".item__tooltip_left") as HTMLElement;

      item.addEventListener("mouseenter", () => {
        [tooltipRight, tooltipLeft].forEach((tooltip) => {
          if (tooltip) {
            gsap.to(tooltip, {
              opacity: 1,
              y: -10,
              duration: 0.3,
              ease: "power1.out",
            });
          }
        });
      });

      item.addEventListener("mouseleave", () => {
        [tooltipRight, tooltipLeft].forEach((tooltip) => {
          if (tooltip) {
            gsap.to(tooltip, {
              opacity: 0,
              y: 0,
              duration: 0.3,
              ease: "power1.in",
            });
          }
        });
      });
    });

    // ç”»é¢ã‚µã‚¤ã‚ºã¨ãƒ‡ãƒã‚¤ã‚¹ã«å¿œã˜ãŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
    const getAnimationSettings = (): [string, gsap.TweenVars][] => {
      const screenWidth = window.innerWidth;
      const isMobile = screenWidth <= 768;
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isAndroid = /Android/.test(navigator.userAgent);

      let item4X: number;
      let item6X: number;

      if (isMobile) {
        if (isIOS) {
          // iPhone: ã¯ã¿å‡ºã—ã‚’é˜²ããŸã‚å°‘ã—å°ã•ã‚ã«èª¿æ•´
          item4X = 250;
          item6X = -250;
        } else if (isAndroid) {
          // Android: è¶³ã‚Šãªã„åˆ†ã‚’è£œã†ãŸã‚å°‘ã—å¤§ãã‚ã«èª¿æ•´
          item4X = 264;
          item6X = -264;
        } else {
          // ãã®ä»–ã®ãƒ‡ãƒã‚¤ã‚¹
          item4X = 254;
          item6X = -254;
        }
      } else {
        // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—
        item4X = 440;
        item6X = -440;
      }

      return [
        [".item-1", { y: 230, rotation: 720, duration: 1.2 }],
        [".item-2", { y: 230, rotation: 360, duration: 1.6 }],
        [".item-3", { y: 230, rotation: 720, duration: 2 }],
        [".item-4", { x: item4X, rotation: 360, duration: 2.3 }],
        [".item-5", { x: 0, rotation: 1080, duration: 2.6 }],
        [".item-6", { x: item6X, rotation: 360, duration: 2.3 }],
        [".item-7", { y: -230, rotation: 720, duration: 1.4 }],
        [".item-8", { y: -230, rotation: 360, duration: 1.8 }],
        [".item-9", { y: -230, rotation: 720, duration: 2.2 }],
        [".item-10", { y: -230, rotation: 720, duration: 1.4 }],
        [".item-11", { y: -230, rotation: 360, duration: 1.8 }],
        [".item-12", { y: -230, rotation: 720, duration: 2.2 }],
      ];
    };

    const animationSettings = getAnimationSettings();

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã‚’é©ç”¨
    animationSettings.forEach(([selector, props]) => createTween(gsap, selector, props));

    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã‚’å†ç”Ÿæˆ
    window.addEventListener("resize", () => {
      // æ—¢å­˜ã®tweenã‚’ã‚¯ãƒªã‚¢
      tweens.forEach((tween) => tween.kill());
      tweens.length = 0;

      // æ–°ã—ã„è¨­å®šã§tweenã‚’ä½œæˆ
      const newAnimationSettings = getAnimationSettings();
      newAnimationSettings.forEach(([selector, props]) => createTween(gsap, selector, props));
    });

    // restartãƒœã‚¿ãƒ³ã®å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆGSAPã‚’ä½¿ç”¨ï¼‰
    const rotateRestartButton = () => {
      const restartButton = document.getElementById("restart");
      if (!restartButton) return;

      gsap.fromTo(
        restartButton,
        {
          rotation: 0,
          scale: 1,
        },
        {
          rotation: 720,
          scale: 1.3,
          duration: 1.5,
          ease: "power2.inOut",
          onComplete: () => {
            gsap.set(restartButton, {
              clearProps: "rotation, scale",
            });
          },
        }
      );
    };

    let lastTriggeredSecond: number | null = null;

    const rotateRestartButtonTimeInterval = () => {
      setInterval(() => {
        const now = new Date();
        const seconds = now.getSeconds();

        if ((seconds === 0 || seconds === 30) && seconds !== lastTriggeredSecond) {
          rotateRestartButton();

          lastTriggeredSecond = seconds;
        } else if (seconds !== 0 && seconds !== 30) {
          lastTriggeredSecond = null;
        }
      }, 1000);
    };

    // æ™‚åˆ»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
    rotateRestartButtonTimeInterval();
  };

  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã«ãªã£ã¦ã‹ã‚‰èª­ã¿è¾¼ã‚€
  if (typeof window !== "undefined" && "requestIdleCallback" in window) {
    (window as Window & typeof globalThis).requestIdleCallback(() => {
      void initGSAP();
    }, { timeout: 2000 });
  } else if (typeof window !== "undefined") {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: requestIdleCallbackãŒä½¿ãˆãªã„å ´åˆã¯å°‘ã—é…å»¶
    setTimeout(() => {
      void initGSAP();
    }, 1000);
  }

  // DOMContentLoadedã§ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆæœŸåŒ–ï¼ˆGSAPã«ä¾å­˜ã—ãªã„ï¼‰
  document.addEventListener("DOMContentLoaded", () => {
    function updateTooltipClassByPosition(): void {
      const item4 = document.querySelector(".item-4");
      const item6 = document.querySelector(".item-6");
      if (!item4 || !item6) return;

      const rect4 = item4.getBoundingClientRect();
      const rect6 = item6.getBoundingClientRect();

      const tooltip4 = item4.querySelector(".item__tooltip_left, .item__tooltip_right");
      const tooltip6 = item6.querySelector(".item__tooltip_left, .item__tooltip_right");

      if (tooltip4) {
        tooltip4.classList.remove("item__tooltip_left", "item__tooltip_right");
        tooltip4.classList.add(rect4.left < rect6.left ? "item__tooltip_left" : "item__tooltip_right");
      }

      if (tooltip6) {
        tooltip6.classList.remove("item__tooltip_left", "item__tooltip_right");
        tooltip6.classList.add(rect6.left < rect4.left ? "item__tooltip_left" : "item__tooltip_right");
      }
    }

    function playAll(): void {
      tweens.forEach((tween) => tween.play());
      updateTooltipClassByPosition();
      playSound();
    }
    function pauseAll(): void {
      tweens.forEach((tween) => tween.pause());
      updateTooltipClassByPosition();
      playSound();
    }
    function reverseAll(): void {
      tweens.forEach((tween) => tween.reverse());
      updateTooltipClassByPosition();
      playSound();
    }
    function restartAll(): void {
      tweens.forEach((tween) => tween.restart());
      updateTooltipClassByPosition();
      playSound();
    }

    document.getElementById("play")?.addEventListener("click", playAll);
    document.getElementById("pause")?.addEventListener("click", pauseAll);
    document.getElementById("reverse")?.addEventListener("click", reverseAll);
    document.getElementById("restart")?.addEventListener("click", restartAll);

    const controlMenu = document.querySelector(".control__menu");
    const buttons = document.querySelectorAll(".button");

    // å„ãƒœã‚¿ãƒ³ã®å›è»¢ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ç®¡ç†ã™ã‚‹Map
    const buttonRotationTimeouts = new Map();

    buttons.forEach((button) => {
      button.addEventListener("mouseenter", () => {
        // æ—¢å­˜ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
        const existingTimeout = buttonRotationTimeouts.get(button);
        if (existingTimeout) {
          clearTimeout(existingTimeout);
          buttonRotationTimeouts.delete(button);
        }

        button.classList.remove("reset-rotation");
        button.classList.add("is-rotating");

        // 3ç§’å¾Œã«è‡ªå‹•çš„ã«å›è»¢ã‚’åœæ­¢
        const timeoutId = setTimeout(() => {
          button.classList.remove("is-rotating");
          button.classList.add("reset-rotation");
          button.addEventListener(
            "transitionend",
            () => {
              button.classList.remove("reset-rotation");
            },
            {
              once: true,
            }
          );
          buttonRotationTimeouts.delete(button);
        }, 3000);

        buttonRotationTimeouts.set(button, timeoutId);
      });

      button.addEventListener("mouseleave", () => {
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
        const timeoutId = buttonRotationTimeouts.get(button);
        if (timeoutId) {
          clearTimeout(timeoutId);
          buttonRotationTimeouts.delete(button);
        }

        button.classList.remove("is-rotating");
      });
    });

    controlMenu?.addEventListener("mouseleave", () => {
      buttons.forEach((button) => {
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
        const timeoutId = buttonRotationTimeouts.get(button);
        if (timeoutId) {
          clearTimeout(timeoutId);
          buttonRotationTimeouts.delete(button);
        }

        button.classList.remove("is-rotating");
        button.classList.add("reset-rotation");
        button.addEventListener(
          "transitionend",
          () => {
            button.classList.remove("reset-rotation");
          },
          {
            once: true,
          }
        );
      });
    });
  });

  // rivç”»åƒã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã‚’å‰Šé™¤ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–: client:visibleã§é…å»¶èª­ã¿è¾¼ã¿ï¼‰
  // Riveã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯åˆæœŸè¡¨ç¤ºã«å¿…é ˆã§ã¯ãªã„ãŸã‚ã€ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã«å…¥ã‚‹ã¾ã§èª­ã¿è¾¼ã¾ãªã„
  // ã“ã‚Œã«ã‚ˆã‚Šã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹ã®æœ€å¤§å¾…ã¡æ™‚é–“ãŒå¤§å¹…ã«çŸ­ç¸®ã•ã‚Œã‚‹
</script>
