---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import type { GetStaticPaths } from "astro";
import { generateBreadcrumbs } from "../../util/generateBreadcrumbs";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import globalText from "../../data/globalText.json";
import worksText from "../../data/worksText.json";
import { WORKS_PAGE_API } from "../../api/headlessCms";
import { Image } from "astro:assets";
import { getOptimizedWordPressImage, getWordPressImageUrl } from "../../util/optimizeWordPressImage";

interface WorkObject {
  id: string;
  title: {
    rendered: string;
  };
  slug: string;
  acf?: {
    screenshot_pc?: string;
    left_link?: string;
    right_access?: string;
  };
}

interface PageObject {
  url: {
    first: string | undefined;
    prev: string | undefined;
    current: string | undefined;
    next: string | undefined;
    last: string | undefined;
    base: string;
  };
  data: WorkObject[];
  currentPage: number;
  lastPage: number;
}

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  try {
    console.log("üîç [Works Pagination] Fetching works from:", WORKS_PAGE_API);

    const worksData = await fetch(WORKS_PAGE_API);

    if (!worksData.ok) {
      console.error(`‚ùå [Works Pagination] Failed to fetch works: ${worksData.status} ${worksData.statusText}`);
      console.error(`‚ùå [Works Pagination] API URL: ${WORKS_PAGE_API}`);
      throw new Error(`Failed to fetch works: ${worksData.status} ${worksData.statusText}`);
    }

    const allWorks = (await worksData.json()) as WorkObject[];
    console.log(`‚úÖ [Works Pagination] Successfully fetched ${allWorks.length} works`);

    if (!Array.isArray(allWorks) || allWorks.length === 0) {
      console.warn("‚ö†Ô∏è [Works Pagination] No works found. Returning empty paths.");
      console.warn("‚ö†Ô∏è [Works Pagination] This will result in 404 errors for works pages.");
      return [];
    }

    const paginatedData = paginate(allWorks, { pageSize: 4 });
    console.log(`üìÑ [Works Pagination] Generated ${paginatedData.length} paginated pages`);

    const paths = paginatedData.map((path, index) => ({
      params: { page: String(index + 1) },
      props: path.props,
    }));

    if (paths.length > 0) {
      const defaultPageProps = (paginatedData[0]?.props ?? {
        page: {
          data: [] as WorkObject[],
          currentPage: 1,
          lastPage: 1,
        },
      }) as { [x: string]: unknown; page: import("astro").Page<WorkObject> };

      paths.unshift({
        params: { page: "" },
        props: defaultPageProps,
      });

      paths.unshift({
        params: { page: "1" },
        props: defaultPageProps,
      });
    }

    console.log(`‚úÖ [Works Pagination] Generated ${paths.length} total paths (including /works and /works/1)`);

    return paths;
  } catch (error) {
    console.error("‚ùå [Works Pagination] Error in getStaticPaths:", error);
    console.error("‚ùå [Works Pagination] API URL:", WORKS_PAGE_API);
    if (error instanceof Error) {
      console.error("‚ùå [Works Pagination] Error message:", error.message);
      console.error("‚ùå [Works Pagination] Error stack:", error.stack);
    }
    return [];
  }
};

const { page } = Astro.props as { page: PageObject };
console.log("Astro props:", page);

const isShowPagination = page.lastPage > 1;

const works = Array.isArray(page.data) ? page.data : [];

const crumbs = generateBreadcrumbs(Astro.url.pathname);

const worksItems = {
  alt: "„ÅÆÁîªÂÉè",
  notFound: "No image available",
  width: 320,
  height: 160,
  ariaLabel: "„ÅÆ„Éö„Éº„Ç∏„Å∏",
  ariaTitle: "„ÅÆ„Éö„Éº„Ç∏„Å∏",
  ariaLabelNewTab: "„ÅÆ„Éö„Éº„Ç∏„Å∏(Êñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè)",
  ariaTitleNewTab: "„ÅÆ„Éö„Éº„Ç∏„Å∏(Êñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åè)",
};

// WordPressÁîªÂÉè„ÇíÊúÄÈÅ©ÂåñÔºà„Éì„É´„ÉâÊôÇ„Å´Âá¶ÁêÜÔºâ
// È´òÂìÅË≥™„ÅßÊúÄÈÅ©ÂåñÔºàquality: 95„ÅßÈ´òÂìÅË≥™„ÇíÁ∂≠ÊåÅÔºâ
const optimizedWorks = await Promise.all(
  works.map(async (work) => {
    const optimizedImage = await getOptimizedWordPressImage(work.acf?.screenshot_pc, {
      width: worksItems.width,
      height: worksItems.height,
      quality: 95, // ÂìÅË≥™„Çí85„Åã„Çâ95„Å´Âêë‰∏ä
      format: "webp",
    });
    const fallbackUrl = getWordPressImageUrl(work.acf?.screenshot_pc) ?? "";
    return {
      ...work,
      optimizedImage,
      fallbackUrl,
    };
  })
);

const repeatTimes = 3;

// ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüÁîªÂÉè„ÇíÂê´„ÇÄworksÈÖçÂàó„ÇíÁπ∞„ÇäËøî„Åó
const repeatedWorks = Array.from(
  { length: optimizedWorks.length * repeatTimes },
  (_, i) => optimizedWorks[i % optimizedWorks.length]
);

const worksPagination = {
  first: "ÊúÄÂàù„ÅÆ„Éö„Éº„Ç∏„Å∏",
  prev: "Ââç„ÅÆ„Éö„Éº„Ç∏„Å∏",
  current: "ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏",
  next: "Ê¨°„ÅÆ„Éö„Éº„Ç∏„Å∏",
  last: "ÊúÄÂæå„ÅÆ„Éö„Éº„Ç∏„Å∏",
};
---

<Layout
  title={globalText.works.title}
  description={globalText.works.description}
  ogType={globalText.local.type}
  ogTitle={globalText.works.title}
  ogDescription={globalText.works.description}
  twitterTitle={globalText.works.title}
  twitterDescription={globalText.works.description}
>
  <div id="outer-container">
    <Header />
    <main id="page-wrap">
      <div class="breadcrumbs__wrapper">
        <Breadcrumbs {crumbs} />
      </div>
      <div class="works">
        <div class="works__wrapper">
          <div class="scrollImage">
            <ul class="scrollImage__menu">
              {
                repeatedWorks.length > 0 ? (
                  repeatedWorks
                    .filter((work) => typeof work !== "undefined")
                    .map((work) => (
                      <li class="scrollImage__menu_item">
                        <h2 class="scrollImage__header">{work?.title?.rendered}</h2>
                        <figure class="scrollImage__figure">
                          {work?.optimizedImage ? (
                            <Image
                              src={work.optimizedImage.src}
                              alt={`${work?.title?.rendered ?? "No Image Available"}${worksItems.alt}`}
                              class="scrollImage__image"
                              width={worksItems.width}
                              height={worksItems.height}
                              loading="lazy"
                              decoding="async"
                            />
                          ) : (
                            <img
                              class="scrollImage__image"
                              src={work?.fallbackUrl ?? ""}
                              alt={`${work?.title?.rendered ?? "No Image Available"}${worksItems.alt}`}
                              width={worksItems.width}
                              height={worksItems.height}
                              decoding="async"
                              loading="lazy"
                            />
                          )}
                        </figure>
                        <a
                          class="scrollImage__link"
                          href={work?.acf?.left_link ?? ""}
                          aria-label={`${work?.acf?.left_link}${worksItems.ariaLabel}`}
                          title={`${work?.acf?.left_link}${worksItems.ariaTitle}`}
                          set:html={work?.acf?.left_link ?? ""}
                        />
                        <p class="scrollImage__text">{work?.acf?.right_access ?? "No additional information"}</p>
                      </li>
                    ))
                ) : (
                  <li style="display:none" />
                )
              }
            </ul>
          </div>
          <h1 class="works__title">
            {worksText.worksTitle}
          </h1>
          <p class="works__text">
            {worksText.worksText}
          </p>
          <ul class="worksCard__menu">
            {
              optimizedWorks.length > 0 ? (
                optimizedWorks.map((work) => (
                  <li class="worksCard__menu_item">
                    <article
                      class="worksCard__article"
                      aria-labelledby={`works-card-${work.id ?? work.slug}-${work?.title?.rendered}`}
                    >
                      <h2 id={`works-card-${work.id ?? work.slug}-${work?.title?.rendered}`} class="worksCard__header">
                        <a
                          class="worksCard__slug"
                          href={`/works/${work.slug}`}
                          aria-label={`${work?.title?.rendered}${worksItems.ariaLabel}`}
                          title={`${work?.title?.rendered}${worksItems.ariaTitle}`}
                          set:html={work?.title?.rendered}
                        />
                      </h2>
                      <a
                        class="worksCard__slug"
                        href={`/works/${work.slug}`}
                        aria-label={`${work.slug}(${work?.title?.rendered})${worksItems.ariaLabel}`}
                        title={`${work.slug}(${work?.title?.rendered})${worksItems.ariaTitle}`}
                      >
                        {work?.optimizedImage ? (
                          <Image
                            src={work.optimizedImage.src}
                            alt={`${work?.title?.rendered ?? "No image available"}${worksItems.alt}`}
                            class="worksCard__image"
                            width={worksItems.width}
                            height={worksItems.height}
                            loading="lazy"
                            decoding="async"
                          />
                        ) : (
                          <img
                            class="worksCard__image"
                            src={work?.fallbackUrl ?? ""}
                            alt={`${work?.title?.rendered ?? "No image available"}${worksItems.alt}`}
                            width={worksItems.width}
                            height={worksItems.height}
                            loading="lazy"
                            decoding="async"
                          />
                        )}
                      </a>
                      <a
                        class="worksCard__link"
                        href={work?.acf?.left_link ?? ""}
                        aria-label={`${work?.title?.rendered}${worksItems.ariaLabelNewTab}`}
                        title={`${work?.title?.rendered}${worksItems.ariaTitleNewTab}`}
                        target="_blank"
                        set:html={work?.acf?.left_link ?? ""}
                      />
                      <p class="worksCard__body" set:html={work?.acf?.right_access ?? "No additional information"} />
                    </article>
                  </li>
                ))
              ) : (
                <p>{worksText.error.text}</p>
              )
            }
          </ul>

          {
            isShowPagination ? (
              <div class="pagination">
                <ul class="pagination__menu">
                  {page.url.first !== "" && page.currentPage > 1 ? (
                    <li class="pagination__menu_item">
                      <a
                        class="pagination__link_current"
                        href={page.url.first}
                        aria-label={worksPagination.first}
                        title={worksPagination.first}
                      >
                        1
                      </a>
                    </li>
                  ) : (
                    <li class="pagination__menu_item">
                      <span class="pagination__link_empty" />
                    </li>
                  )}
                  {page.url.prev !== "" && page.currentPage > 1 ? (
                    <li class="pagination__menu_item">
                      <a
                        class="pagination__link"
                        href={page.url.prev}
                        aria-label={`${worksPagination.prev}(${page.currentPage - 1})`}
                        title={worksPagination.prev}
                      >
                        &larr;
                      </a>
                    </li>
                  ) : (
                    <li class="pagination__menu_item">
                      <span class="pagination__link_empty" />
                    </li>
                  )}
                  <li class="pagination__menu_item">
                    <a
                      class="pagination__link_current"
                      href={page.url.current}
                      aria-label={`${worksPagination.current}(${page.currentPage})`}
                      title={`${worksPagination.current}(${page.currentPage})`}
                    >
                      {typeof page.currentPage === "number" && page.currentPage > 0 ? page.currentPage : "1"}
                    </a>
                  </li>
                  {page.url.next !== "" && page.currentPage < page.lastPage ? (
                    <li class="pagination__menu_item">
                      <a
                        class="pagination__link"
                        href={page.url.next}
                        aria-label={`${worksPagination.next}(${page.currentPage + 1})`}
                        title={worksPagination.next}
                      >
                        &rarr;
                      </a>
                    </li>
                  ) : (
                    <li class="pagination__menu_item">
                      <span class="pagination__link_empty" />
                    </li>
                  )}
                  {page.url.last !== "" && page.currentPage !== page.lastPage ? (
                    <li class="pagination__menu_item">
                      <a
                        class="pagination__link_current"
                        href={page.url.last}
                        aria-label={`${worksPagination.last}(${page.lastPage})`}
                        title={`${worksPagination.last}(${page.lastPage})`}
                      >
                        {page.lastPage}
                      </a>
                    </li>
                  ) : (
                    <li class="pagination__menu_item">
                      <span class="pagination__link_empty" />
                    </li>
                  )}
                </ul>
              </div>
            ) : (
              <div class="pagination" style="display: none;" />
            )
          }
        </div>
      </div>
    </main>
    <Footer />
  </div>
</Layout>

<style>
  .works {
    width: 100%;
    line-height: 1.6;
    color: inherit;
    background: transparent;
    position: relative;
    overflow: hidden;
  }
  .works__wrapper {
    width: 700px;
    max-width: calc(100% - 2rem);
    margin-inline: auto;
  }
  /* ËÉåÊôØ„Çπ„ÇØ„É≠„Éº„É´ÁîªÂÉè */
  .scrollImage {
    position: fixed;
    top: 0;
    left: 22%;
    z-index: -1;
  }
  .scrollImage__menu {
    width: 100%;
    height: 400px;
    display: grid;
    /* PC„Çµ„Ç§„Ç∫: 2ÂàóË°®Á§∫ */
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    list-style: none;
    filter: sepia(10%);
    opacity: 0;
    margin-block-start: 3rem;
    margin-inline: auto;
    animation: skew-scroll 24s linear infinite;
    will-change: transform, opacity;
  }

  /* „Çø„Éñ„É¨„ÉÉ„Éà„Çµ„Ç§„Ç∫‰ª•‰∏ã: 1ÂàóË°®Á§∫ */
  @media (width <= 768px) {
    .scrollImage__menu {
      grid-template-columns: 1fr;
    }
  }
  @keyframes skew-scroll {
    from {
      transform: rotateX(8deg) rotate(-8deg) skew(8deg) translateY(110%);
      opacity: 0;
    }
    24% {
      opacity: 0.7;
    }
    48% {
      opacity: 0.3;
    }
    to {
      transform: rotateX(8deg) rotate(-8deg) skew(8deg) translateY(-430%);
      opacity: 0;
    }
  }
  .scrollImage__menu_item {
    width: 100%;
    display: grid;
    color: rebeccapurple;
    background-color: transparent;
  }
  .scrollImage__header {
    align-self: flex-start;
    flex-shrink: 1;
    font-size: 1rem;
    overflow-wrap: normal;
    padding-inline: 1rem;
  }
  .scrollImage__figure {
    display: flex;
    flex-shrink: 0;
    aspect-ratio: 2 / 1;
    overflow: hidden;
    margin-block-start: 1rem;
  }
  .scrollImage__image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    overflow: hidden;
    padding-inline: 0.25rem;
  }
  .scrollImage__link {
    font-size: 0.875rem;
    color: white;
    text-align: center;
    text-decoration: none;
    pointer-events: none;
    margin-block-start: 1rem;
    padding-inline: 0.5rem;
  }
  .scrollImage__text {
    flex-shrink: 0;
    font-size: 0.75rem;
    text-align: center;
    margin-block-start: 1rem;
    padding-inline: 0.75rem;
  }
  /* Works„Éö„Éº„Ç∏ „Çø„Ç§„Éà„É´ */
  .works__title {
    font-size: 2rem;
    text-align: center;
  }
  /* Works„Éö„Éº„Ç∏ „ÉÜ„Ç≠„Çπ„Éà */
  .works__text {
    font-size: 1rem;
    line-height: 1.8;
    letter-spacing: 0.2em;
    color: inherit;
    padding-inline: 1rem;
  }
  /* Works„Éö„Éº„Ç∏ „Ç´„Éº„Éâ */
  .worksCard__menu {
    width: 100%;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
    list-style: none;
    margin-block-start: 3rem;
  }
  .worksCard__menu_item {
    display: block grid;
    grid-template-rows: subgrid;
    grid-row: span 4;
    color: rebeccapurple;
    background-color: whitesmoke;
    border: rebeccapurple 1px solid;
    border-radius: 1rem;
    box-shadow: 0 0 8px rgba(0 0 0 / 0.6);
    overflow: hidden;
    position: relative;
    padding-block: 1rem;
    transition: all 0.6s cubic-bezier(0.22, 1, 0.36, 1);
  }
  .worksCard__menu_item::before {
    content: "";
    width: 400px;
    height: 350px;
    display: grid;
    grid-template-rows: subgrid;
    grid-row: span 4;
    background: linear-gradient(
      -90deg,
      transparent,
      rgba(236, 159, 255, 1),
      #ffffff71,
      rgba(147, 183, 255, 1),
      #ffffff71,
      rgba(170, 244, 254, 1),
      transparent
    );
    position: absolute;
    top: 0;
    right: 0;
    z-index: -1;
    transform: translateX(300px) skew(-32deg);
    opacity: 0;
    animation: shineCard 2.5s linear infinite;
  }
  @keyframes shineCard {
    0% {
      transform: translateX(300px) skew(-32deg);
      opacity: 0;
    }
    8% {
      opacity: 1;
    }
    48% {
      transform: translateX(-300px) skew(-32deg);
      opacity: 0.9;
    }
    50% {
      opacity: 0.1;
    }
    100% {
      transform: translateX(300px) skew(-32deg);
      opacity: 0;
    }
  }
  .worksCard__menu_item:is(:hover, :focus-visible) {
    background-color: transparent;
    box-shadow: 0 10px 10px rgba(0 0 0 / 0.6);
  }
  @media (prefers-color-scheme: dark) {
    html.dark .worksCard__menu_item:is(:hover, :focus-visible) {
      color: #f1f5f9;
    }
    html.dark .worksCard__menu_item::before {
      background: linear-gradient(-90deg, transparent, #ffffff71, transparent, #ffffff71, transparent);
    }
  }
  .worksCard__article {
    display: block grid;
    grid-template-rows: subgrid;
    grid-row: span 4;
  }
  .worksCard__header {
    font-size: 1rem;
    overflow-wrap: normal;
    margin-inline: 1rem;
    padding-inline: 1rem;
  }
  .worksCard__slug {
    color: inherit;
    text-decoration: none;
    aspect-ratio: 2 / 1;
    overflow: hidden;
  }
  .worksCard__link {
    display: block;
    font-size: 0.875rem;
    text-decoration: none;
    text-align: center;
    margin-block-start: auto;
    padding-inline: 0.5rem;
    transition: all 0.4s ease;
  }
  .worksCard__link:is(:hover, :focus-visible) {
    color: #020202;
    border-bottom: 1px solid white;
    box-shadow: 0 6px 10px rgba(0 0 0 / 0.6);
    border-radius: 0.5rem;
    margin-inline: 0.5rem;
  }
  @media (prefers-color-scheme: dark) {
    html.dark .worksCard__link:is(:hover, :focus-visible) {
      color: #f1f5f9;
      border: 1px solid white;
    }
  }
  .worksCard__image {
    width: 100%;
    height: 100%;
    box-shadow: 0 6px 10px rgba(0 0 0 / 0.6);
    object-fit: contain;
    overflow: hidden;
    transition: all 0.3s ease-in;
    margin-block-start: auto;
    padding-inline: 0.25rem;
  }
  .worksCard__image:is(:hover, :focus-visible) {
    transform: scale(1.2);
    filter: brightness(125%) saturate(125%);
  }
  .worksCard__body {
    flex-shrink: 0;
    font-size: 0.75rem;
    text-align: center;
    margin-block-start: auto;
    padding-inline: 0.75rem;
  }
  @media (width <= 768px) {
    .worksCard__menu_item {
      background-color: transparent;
    }
    @media (prefers-color-scheme: dark) {
      html.dark .worksCard__menu_item {
        color: #f1f5f9;
      }
    }
  }
</style>
