# WordPress SMTP設定ガイド

このガイドでは、WordPress（Contact Form 7）でメール送信を行うためのSMTP設定手順を説明します。

## 目次

1. [概要](#概要)
2. [ConoHa WINGのSMTP設定](#conoha-wingのsmtp設定)
3. [SMTPプラグインのインストールと設定](#smtpプラグインのインストールと設定)
4. [Contact Form 7のメール設定確認](#contact-form-7のメール設定確認)
5. [テスト送信](#テスト送信)
6. [トラブルシューティング](#トラブルシューティング)

## 概要

### なぜSMTP設定が必要か

2026年1月にGmail POP設定受信が廃止されたため、WordPressのデフォルトのメール送信機能（`wp_mail()`）が正常に動作しない場合があります。SMTP（Simple Mail Transfer Protocol）を使用することで、確実にメールを送信できるようになります。

### SMTPとは

SMTPは、メールサーバー間でメールを送信するためのプロトコルです。WordPressからSMTPサーバー経由でメールを送信することで、メールの到達率が向上します。

## ConoHa WINGのSMTP設定

### SMTPサーバー情報

- **SMTPサーバー**: `mail58.conoha.ne.jp`
- **ポート番号**: 
  - **587** (TLS/STARTTLS) - 推奨
  - **465** (SSL)
- **認証**: 必須（メールアドレスとパスワード）

### 必要な情報

SMTP設定を行う前に、以下を準備してください：

1. **メールアドレス**: ConoHa WINGで作成したメールアドレス（例: `info@your-domain.com`）
2. **メールパスワード**: メールアドレスのパスワード
3. **送信者名**: メールに表示される送信者名（例: "Hibari Konaweb"）

## SMTPプラグインのインストールと設定

### 推奨プラグイン

以下のプラグインのいずれかを使用することを推奨します：

1. **WP Mail SMTP**（推奨）
   - 無料版で十分な機能を提供
   - 設定が簡単
   - メール送信ログ機能あり

2. **Easy WP SMTP**
   - シンプルで軽量
   - 基本的なSMTP設定のみ

### WP Mail SMTPの設定手順

#### 1. プラグインのインストール

1. WordPress管理画面にログイン
2. 「プラグイン」→「新規追加」をクリック
3. 「WP Mail SMTP」を検索
4. 「今すぐインストール」→「有効化」をクリック

#### 2. SMTP設定

1. **設定画面を開く**
   - 左メニューの「WP Mail SMTP」をクリック
   - または「設定」→「メール」をクリック

2. **メール設定を選択**
   - 「その他のSMTP」を選択（無料版の場合）

3. **SMTP設定を入力**

   ```
   SMTP ホスト: mail58.conoha.ne.jp
   SMTP 暗号化: TLS（推奨）または SSL
   SMTP ポート: 587（TLSの場合）または 465（SSLの場合）
   SMTP 認証: はい
   SMTP ユーザー名: メールアドレス（例: info@your-domain.com）
   SMTP パスワード: メールアドレスのパスワード
   ```

4. **送信者情報を設定**

   ```
   送信者メールアドレス: メールアドレス（例: info@your-domain.com）
   送信者名: サイト名または任意の名前（例: Hibari Konaweb）
   ```

5. **設定を保存**
   - 「設定を保存」ボタンをクリック

### Easy WP SMTPの設定手順

#### 1. プラグインのインストール

1. WordPress管理画面にログイン
2. 「プラグイン」→「新規追加」をクリック
3. 「Easy WP SMTP」を検索
4. 「今すぐインストール」→「有効化」をクリック

#### 2. SMTP設定

1. **設定画面を開く**
   - 左メニューの「Easy WP SMTP」をクリック

2. **SMTP設定を入力**

   ```
   From Email Address: メールアドレス（例: info@your-domain.com）
   From Name: サイト名または任意の名前（例: Hibari Konaweb）
   SMTP Host: mail58.conoha.ne.jp
   Type of Encryption: TLS（推奨）または SSL
   SMTP Port: 587（TLSの場合）または 465（SSLの場合）
   SMTP Username: メールアドレス（例: info@your-domain.com）
   SMTP Password: メールアドレスのパスワード
   ```

3. **設定を保存**
   - 「Save Changes」ボタンをクリック

## Contact Form 7のメール設定確認

### メール設定の確認手順

1. **Contact Form 7の管理画面を開く**
   - WordPress管理画面にログイン
   - 「お問い合わせ」→「コンタクトフォーム」をクリック
   - 使用しているフォームを選択

2. **メールタブを確認**
   - 「メール」タブをクリック
   - 以下の設定を確認：

   ```
   送信先: 受信したいメールアドレス（例: webengineer@hibari-konaweb.com）
   送信元: [your-email]（フォームに入力されたメールアドレス）
   件名: お問い合わせがありました
   メッセージ本文: フォームの内容
   ```

3. **メール（2）タブを確認**（自動返信メールを送信する場合）
   - 「メール（2）」タブをクリック
   - 自動返信メールの設定を確認

### メール設定の注意点

- **送信元メールアドレス**: SMTPで設定したメールアドレスと一致させることを推奨
- **送信者名**: 分かりやすい名前を設定（例: "Hibari Konaweb お問い合わせフォーム"）
- **文字エンコーディング**: UTF-8を指定

## テスト送信

### WP Mail SMTPを使用している場合

1. **テストメールを送信**
   - 「WP Mail SMTP」→「ツール」タブをクリック
   - 「テストメールを送信」セクションで送信先メールアドレスを入力
   - 「メールを送信」ボタンをクリック

2. **送信ログを確認**
   - 「WP Mail SMTP」→「メール」タブをクリック
   - 送信履歴とエラーログを確認

### Easy WP SMTPを使用している場合

1. **テストメールを送信**
   - 「Easy WP SMTP」→「Send Test Email」タブをクリック
   - 送信先メールアドレスを入力
   - 「Send Test Email」ボタンをクリック

### お問い合わせフォームからテスト送信

1. **フロントエンドからフォームを送信**
   - サイトのお問い合わせフォームにアクセス
   - テスト用の情報を入力して送信

2. **送信結果を確認**
   - メールが正常に受信できるか確認
   - エラーメッセージが表示されないか確認

## トラブルシューティング

### メールが送信されない場合

#### 1. SMTP設定の確認

- SMTPサーバー、ポート、認証情報が正しいか確認
- メールアドレスとパスワードが正しいか確認
- TLS/SSLの設定が正しいか確認

#### 2. ポート番号の確認

- **587（TLS）**: ファイアウォールでブロックされていないか確認
- **465（SSL）**: 別のポートを試す

#### 3. メールサーバーのログを確認

- ConoHa WINGのメールサーバーログを確認
- 認証エラーや接続エラーがないか確認

#### 4. プラグインの競合を確認

- 他のメール関連プラグインが競合していないか確認
- 一時的に他のプラグインを無効化してテスト

### タイムアウトエラーが発生する場合

フロントエンド側で「送信中...」のままになる場合：

1. **WordPress側の処理時間を確認**
   - SMTPサーバーへの接続に時間がかかっている可能性
   - メール送信処理が正常に完了しているか確認

2. **フロントエンド側のタイムアウト設定を確認**
   - `ContactForm.tsx`に30秒のタイムアウトが設定されていることを確認
   - タイムアウト時間を延長する必要がある場合は調整

3. **SMTPサーバーの応答速度を確認**
   - ConoHa WINGのメールサーバーが正常に応答しているか確認
   - 別のSMTPサーバーを試す

### よくあるエラーメッセージ

#### "SMTP connect() failed"

- **原因**: SMTPサーバーに接続できない
- **対処法**: 
  - SMTPサーバー名が正しいか確認
  - ポート番号が正しいか確認
  - ファイアウォールでブロックされていないか確認

#### "Authentication failed" / "SMTP アカウントを認証できませんでした"

- **原因**: 認証情報が間違っている、またはSMTP設定が正しくない
- **対処法**: 
  - メールアドレスとパスワードが正しいか確認
  - メールアドレスのパスワードをリセットして再設定
  - **SMTP認証方式の確認**: ConoHa WINGでは通常、通常のメールアドレス/パスワード認証を使用します
  - **ポートと暗号化の組み合わせを確認**:
    - ポート587 → TLS/STARTTLS
    - ポート465 → SSL
  - **送信者メールアドレスの確認**: WP Mail SMTPの「送信者メールアドレス」が、SMTP認証で使用しているメールアドレスと一致しているか確認
  - **ConoHa WINGのメールアカウント設定を確認**: メールアカウントが正しく作成され、有効になっているか確認

#### "Could not instantiate mail function"

- **原因**: PHPのメール関数が使用できない
- **対処法**: 
  - SMTPプラグインが正しく設定されているか確認
  - プラグインを再インストール

### 追加の確認事項

1. **ConoHa WINGのメールアカウント設定**
   - メールアカウントが正しく作成されているか確認
   - メールボックスの容量が上限に達していないか確認

2. **WordPressのデバッグモード（WP Mail SMTP無料版でもエラーログを確認可能）**

   - `wp-config.php`でデバッグモードを有効にしてエラーログを確認

   ```php
   define('WP_DEBUG', true);
   define('WP_DEBUG_LOG', true);
   define('WP_DEBUG_DISPLAY', false); // 本番環境ではfalseに設定（エラーを画面に表示しない）
   ```

   - エラーログは `wp-content/debug.log` に記録されます
   - SMTP送信時のエラーもこのログに記録されるため、WP Mail SMTP Proがなくてもエラー内容を確認できます
   - ログファイルの場所: `wp-content/debug.log`
   - ログを確認する方法:
     1. WordPressのファイルマネージャーまたはFTPで `wp-content/debug.log` を開く
     2. 最新のエラーメッセージを確認（SMTP関連のエラーを検索）
     3. エラーメッセージから原因を特定（例: "Authentication failed"、"Connection refused" など）

3. **プラグインの更新**
   - SMTPプラグインが最新版か確認
   - WordPress本体も最新版に更新

## 参考リンク

- [WP Mail SMTP公式サイト](https://wordpress.org/plugins/wp-mail-smtp/)
- [Easy WP SMTP公式サイト](https://wordpress.org/plugins/easy-wp-smtp/)
- [Contact Form 7公式サイト](https://contactform7.com/)
- [ConoHa WING公式サイト](https://www.conoha.jp/wing/)

## 関連ドキュメント

- [お問い合わせフォーム セキュリティ対策ガイド](./SECURITY_SETUP_GUIDE.md)
- [Netlify環境変数の設定手順](./NETLIFY_ENV_SETUP.md)
