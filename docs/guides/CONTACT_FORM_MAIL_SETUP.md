# Contact Form 7 自動返信メール設定ガイド

## 概要

ヘッドレスWordPress環境では、Contact Form 7の`[_site_url]`マイルタグがWordPress側のURL（例: `https://hibari-konaweb.com`）を返しますが、フロントエンド側のURL（例: `https://hibari-konaweb.netlify.app`）を表示したい場合があります。

## `[_site_url]`をフロントエンドURLに変更する方法

### 方法1: WordPress側でカスタムメールタグを作成（推奨）

WordPressの`functions.php`に以下のコードを追加することで、`[_site_url]`の出力をフロントエンドURLに上書きできます。

#### 実装手順

1. **WordPress管理画面にログイン**
2. **外観 → テーマエディター** または **プラグイン → プラグインエディター** を開く
3. **functions.php** を開く（または子テーマの`functions.php`を使用）
4. 以下のコードを追加：

```php
/**
 * Contact Form 7の[_site_url]マイルタグをフロントエンドURLに置き換える
 */
add_filter('wpcf7_special_mail_tags', 'custom_frontend_site_url_tag', 10, 3);
function custom_frontend_site_url_tag($output, $tag, $unused) {
    if ($tag === '_site_url') {
        // フロントエンド側のURLを返す
        return 'https://hibari-konaweb.netlify.app';
    }
    return $output;
}
```

#### 環境変数を使用する場合（より柔軟）

環境変数で管理したい場合は、以下のように実装できます：

```php
/**
 * Contact Form 7の[_site_url]マイルタグをフロントエンドURLに置き換える
 * 環境変数FRONTEND_URLが設定されている場合はそれを使用、なければデフォルト値を使用
 */
add_filter('wpcf7_special_mail_tags', 'custom_frontend_site_url_tag', 10, 3);
function custom_frontend_site_url_tag($output, $tag, $unused) {
    if ($tag === '_site_url') {
        // 環境変数から取得（wp-config.phpで定義）
        $frontend_url = defined('FRONTEND_URL') ? FRONTEND_URL : 'https://hibari-konaweb.netlify.app';
        return $frontend_url;
    }
    return $output;
}
```

`wp-config.php`に以下を追加：

```php
define('FRONTEND_URL', 'https://hibari-konaweb.netlify.app');
```

### 方法2: メールテンプレート内で直接URLを指定（シンプル）

Contact Form 7のメール設定画面で、`[_site_url]`を直接URLに置き換えます。

#### 変更前
```
本メールは、([_site_title] [_site_url]) のお問い合わせへの自動返信メールです。
```

#### 変更後
```
本メールは、([_site_title] https://hibari-konaweb.netlify.app) のお問い合わせへの自動返信メールです。
```

**注意**: この方法は、URLが変更された場合に手動で更新する必要があります。

## メール本文の改善案

### 現在のメール本文

```
[your-name]様

hibari-konaweb.comです。この度は、お問い合わせいただき誠にありがとうございます。以下の内容でお問い合わせを受け付けました。

================
[お名前]: [your-name]
[会社名]: [your-company]
[メールアドレス]: [your-email]
[お問い合わせ内容]: [your-message]
================

お問い合わせの件につきまして確認させていただきます。現在多数のお問い合わせをいただいており、回答までにお時間を頂戴しております。恐れ入りますが、今しばらくお待ちいただけますと幸いです。
なお、お問い合わせの際にいただいた個人情報は対応に必要な範囲でのみ利用いたします。
今後とも hibari-konaweb.com をよろしくお願いいたします。

---
本メールは、([_site_title] [_site_url]) のお問い合わせへの自動返信メールです。こちらに返信いただきましても、返答ができません。あらかじめご了承ください。
また、もしもこの自動返信メールについて心当たりのない場合は、どうぞこのメッセージを無視してください。
```

### 改善案

以下の改善点を反映したメール本文を提案します：

1. **冒頭の挨拶をより丁寧に**
2. **情報の見やすさを向上**（区切り線の改善）
3. **返信不可の注意をより明確に**
4. **サイト名の統一**（hibari-konaweb.com → サイト名）

#### 改善版メール本文（返信期限明示版・推奨）

```
[your-name] 様

この度は、お問い合わせいただき誠にありがとうございます。
以下の内容でお問い合わせを受け付けました。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【お問い合わせ内容】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

お名前: [your-name]
会社名: [your-company]
メールアドレス: [your-email]

お問い合わせ内容:
[your-message]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

お問い合わせの件につきまして、内容を確認させていただきます。
お問い合わせいただいた内容につきましては、**2営業日以内**にご返信いたします。

なお、お問い合わせの際にいただいた個人情報は、対応に必要な範囲でのみ利用いたします。

今後とも [_site_title] をよろしくお願いいたします。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【重要】
本メールは自動返信メールです。このメールアドレス（[_sender]）への返信はできません。
お問い合わせへの回答は、別途メールにてご連絡いたします。

もしもこの自動返信メールについて心当たりのない場合は、このメッセージを無視してください。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[_site_title]
[_site_url]
```

#### 改善版メール本文（返信期限なし版）

返信期限を明示しない場合は、以下のバージョンを使用できます：

```
[your-name] 様

この度は、お問い合わせいただき誠にありがとうございます。
以下の内容でお問い合わせを受け付けました。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【お問い合わせ内容】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

お名前: [your-name]
会社名: [your-company]
メールアドレス: [your-email]

お問い合わせ内容:
[your-message]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

お問い合わせの件につきまして、内容を確認させていただきます。
現在、多数のお問い合わせをいただいており、回答までにお時間を頂戴しております。
恐れ入りますが、今しばらくお待ちいただけますと幸いです。

なお、お問い合わせの際にいただいた個人情報は、対応に必要な範囲でのみ利用いたします。

今後とも [_site_title] をよろしくお願いいたします。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【重要】
本メールは自動返信メールです。このメールアドレス（[_sender]）への返信はできません。
お問い合わせへの回答は、別途メールにてご連絡いたします。

もしもこの自動返信メールについて心当たりのない場合は、このメッセージを無視してください。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[_site_title]
[_site_url]
```

### 改善点の説明

1. **冒頭の挨拶**: 「hibari-konaweb.comです」を削除し、より自然な挨拶に変更
2. **情報の整理**: 区切り線を明確にし、項目名を統一
3. **返信期限の明示**: 「2営業日以内にご返信」を明記し、ユーザーの期待値を明確化（推奨）
4. **返信不可の注意**: 「重要」セクションを追加し、返信不可であることを明確に
5. **サイト名の統一**: `[_site_title]`を使用してサイト名を動的に表示
6. **視認性の向上**: 区切り線を`━`に変更し、セクションを明確に分離

### 返信期限を明示するメリット

返信期限を明示することで、以下のメリットがあります：

1. **ユーザー体験の向上**
   - ユーザーが返信をいつ受け取れるか明確になる
   - 不安を軽減し、信頼性が向上

2. **業務効率の向上**
   - 期限を明示することで、対応の優先順位が明確になる
   - 期限内に返信する意識が高まる

3. **緊急時の対応**
   - 期限を明示することで、緊急の場合は別途連絡先を案内する余地が生まれる

### 返信期限の設定について

返信期限は、実際の対応能力に合わせて設定してください：

- **2営業日以内**: 一般的なビジネス対応（推奨）
- **3営業日以内**: 対応に時間がかかる場合
- **1週間以内**: 複雑な案件や専門的な対応が必要な場合

**注意**: 設定した期限は必ず守るようにしてください。期限を守れない場合は、期限を延長するか、より現実的な期限に変更してください。

## 実装手順

### 1. WordPress側でカスタムメールタグを設定

1. WordPress管理画面にログイン
2. 外観 → テーマエディター → functions.php を開く
3. 上記の「方法1」のコードを追加
4. ファイルを保存

### 2. Contact Form 7のメール設定を更新

1. WordPress管理画面で「お問い合わせ」→「コンタクトフォーム」を開く
2. 使用しているフォームを選択
3. 「メール（2）」タブをクリック
4. 「メッセージ本文」に改善版のメール本文を貼り付け
5. 「保存」をクリック

### 3. テスト送信

1. フロントエンド側のお問い合わせフォームからテスト送信
2. 自動返信メールが正しく受信できるか確認
3. `[_site_url]`がフロントエンドURL（`https://hibari-konaweb.netlify.app`）で表示されているか確認

## トラブルシューティング

### `[_site_url]`が変更されない場合

1. **functions.phpのコードが正しく追加されているか確認**
   - 構文エラーがないか確認
   - ファイルが保存されているか確認

2. **キャッシュをクリア**
   - WordPressのキャッシュプラグインを使用している場合は、キャッシュをクリア
   - ブラウザのキャッシュもクリア

3. **Contact Form 7の設定を再確認**
   - メールテンプレート内で`[_site_url]`が正しく使用されているか確認

### メールが送信されない場合

- [WordPress SMTP設定ガイド](./WORDPRESS_SMTP_SETUP.md)を参照してください

## 参考リンク

- [Contact Form 7公式サイト](https://contactform7.com/)
- [Contact Form 7 メールタグ一覧](https://contactform7.com/docs/special-mail-tags/)

## 関連ドキュメント

- [WordPress SMTP設定ガイド](./WORDPRESS_SMTP_SETUP.md)
- [お問い合わせフォーム セキュリティ対策ガイド](./SECURITY_SETUP_GUIDE.md)
